# Supabaseリアルタイム機能診断ガイド

## 🔍 リアルタイム機能の状態確認方法

### 1. Supabaseダッシュボードでの確認

#### **アクセス方法**
1. [Supabaseダッシュボード](https://supabase.com/dashboard)にアクセス
2. プロジェクト `mrjocjcppjnjxtudebta` を選択
3. 左サイドバーの「Database」→「Replication」をクリック

#### **確認すべき項目**
- ✅ **Replication Status**: `Active` になっているか
- ✅ **Tables**: `tasks`, `comments`, `notifications`, `meetings` が表示されているか
- ✅ **Publication**: `supabase_realtime` が有効になっているか

### 2. ブラウザの開発者ツールでの確認

#### **コンソールログの確認**
```javascript
// 以下のログが表示されているか確認
📱 モバイル環境情報: {isMobile: true, ...}
📡 Supabase接続確認: {url: "...", hasSupabase: true, ...}
✅ タスクのリアルタイム更新が有効になりました
✅ コメントのリアルタイム更新が有効になりました
✅ 通知のリアルタイム更新が有効になりました
```

#### **ネットワークタブの確認**
1. 開発者ツールの「Network」タブを開く
2. `supabase.co` へのWebSocket接続を確認
3. `realtime` エンドポイントへの接続を確認

### 3. リアルタイム機能のテスト

#### **テスト手順**
1. **PCとスマートフォンで同時にアプリを開く**
2. **PCでコメントを投稿**
3. **スマートフォンでリアルタイム更新を確認**

#### **期待される動作**
- PCでコメント投稿 → スマートフォンで即座に表示
- PCでタスク追加 → スマートフォンで即座に表示
- PCで通知作成 → スマートフォンで即座に表示

### 4. よくある問題と対処法

#### **問題1: スマートフォンでリアルタイム更新されない**
**原因**: モバイルブラウザのバックグラウンド制限
**対処法**: 
- アプリをフォアグラウンドに保つ
- ページをリフレッシュして再接続

#### **問題2: 接続が頻繁に切れる**
**原因**: ネットワークの不安定性
**対処法**: 
- WiFiとモバイルデータを切り替えてテスト
- アプリの再接続機能が動作するか確認

#### **問題3: 通知が届かない**
**原因**: ブラウザの通知許可が無効
**対処法**: 
- ブラウザの設定で通知を許可
- アプリの通知設定を確認

### 5. デバッグ用のコンソールコマンド

#### **リアルタイム接続の手動確認**
```javascript
// ブラウザのコンソールで実行
console.log('Supabase接続状態:', supabase);
console.log('サブスクリプション数:', appState.subscriptions.length);
console.log('ネットワーク状態:', navigator.onLine);
```

#### **手動再接続**
```javascript
// ブラウザのコンソールで実行
reconnectRealtimeSubscriptions();
```

### 6. 緊急時の対処法

#### **完全リセット**
1. ブラウザのキャッシュをクリア
2. アプリを完全にリロード
3. ログインし直す

#### **Service Workerのリセット**
1. 開発者ツールの「Application」タブ
2. 「Service Workers」を選択
3. 「Unregister」をクリック
4. ページをリロード

## 📊 診断結果の記録

### 確認項目チェックリスト
- [ ] SupabaseダッシュボードでReplication StatusがActive
- [ ] ブラウザコンソールでリアルタイム接続ログが表示
- [ ] PCとスマートフォン間でリアルタイム更新が動作
- [ ] 通知機能が正常に動作
- [ ] ネットワーク接続が安定

### 問題が発生した場合
1. 上記のチェックリストを確認
2. ブラウザの開発者ツールでエラーログを確認
3. ネットワーク接続を確認
4. 必要に応じてアプリをリロード

## 🔧 技術的な詳細

### リアルタイム機能の仕組み
1. **WebSocket接続**: Supabaseのリアルタイムサーバーと接続
2. **PostgreSQL Replication**: データベースの変更を監視
3. **Channel Subscription**: 特定のテーブルの変更を購読
4. **Event Broadcasting**: 変更をクライアントに配信

### モバイル環境での制限
- **バックグラウンド制限**: アプリが非アクティブになると接続が制限される
- **ネットワーク制限**: モバイルデータの制限やWiFiの切り替え
- **ブラウザ制限**: モバイルブラウザのリソース制限

### 最適化設定
- **ハートビート間隔**: iOS 15秒、Android 8秒
- **接続タイムアウト**: 30秒
- **リトライ回数**: 最大5回
- **自動再接続**: 30秒ごとの接続確認
