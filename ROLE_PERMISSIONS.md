# 🔐 プロジェクトロール権限一覧

## 概要

このドキュメントは、プロジェクトメンバーの各ロール（役割）の権限を明確に定義したものです。
最終更新: 2025-11-01

---

## ⏰ ロールが決まるタイミング

### 1. **プロジェクト作成時**
プロジェクト作成者は自動的に「**オーナー**」になる。

```javascript
// プロジェクト作成時に実行されるコード
async function createProject(name, description) {
    const { data: project } = await supabase.from('projects').insert([{
        name: name,
        description: description,
        created_by: appState.currentUser.id
    }]).select().single();

    // 自分をオーナーとして追加
    await supabase.from('project_members').insert([{
        project_id: project.id,
        user_id: appState.currentUser.id,
        role: 'owner'  // ← ここで自動的にオーナーになる
    }]);
}
```

### 2. **メンバー追加時**
オーナー・管理者がユーザーをプロジェクトに追加する際にロールを指定する（**現時点では未実装、今後実装予定**）。

**今後の実装イメージ:**
- プロジェクト設定画面から「メンバーを招待」
- ユーザー名を入力して「ロールを選択」（owner/admin/member/viewer）
- 決定ボタンで `project_members` テーブルに挿入

### 3. **マイグレーション（サンプルデータ）**
データベースマイグレーションでサンプルデータを作成する際に明示的に指定する。

```sql
-- サンプルデータ作成時の例
INSERT INTO project_members (project_id, user_id, role) VALUES
(project_id, user1_id, 'owner'),   -- オーナー
(project_id, user2_id, 'member'),  -- メンバー
(project_id, user3_id, 'viewer');  -- 閲覧者
```

### 4. **現時点での実装状況**

| 機能 | 実装状況 | 備考 |
|------|---------|------|
| プロジェクト作成時にオーナーになる | ✅ 実装済み | `js/projects.js` の `createProject` |
| メンバー追加UI | ❌ 未実装 | 今後の開発予定 |
| ロール変更UI | ❌ 未実装 | 今後の開発予定 |
| サンプルデータ作成 | ✅ 実装済み | マイグレーションファイル |
| RLSポリシー | ✅ 実装済み | データベースレベルで権限制御 |

**現在の制約:**
- メンバーを追加・削除するUIが存在しない
- ロールを変更するUIが存在しない
- 手動でSupabaseの `project_members` テーブルを編集する必要がある

---

## 📋 ロール一覧

### 1. **オーナー (owner)** 👑

**最上位権限**

| 操作 | 権限 |
|------|------|
| プロジェクト情報の編集 | ✅ 可能 |
| プロジェクトの削除 | ✅ 可能 |
| タスクの作成・編集・削除 | ✅ 可能 |
| コメントの投稿・編集・削除 | ✅ 可能 |
| 意見交換の投稿・編集・削除 | ✅ 可能 |
| リアクションの追加・削除 | ✅ 可能 |
| 会議の作成・編集・削除 | ✅ 可能 |
| メンバーの追加・削除 | ✅ 可能 |
| メンバーのロール変更 | ✅ 可能 |
| 通知の閲覧 | ✅ 可能 |
| 通知の作成・削除 | ✅ 可能 |

**特徴:**
- プロジェクトの完全な所有権を持つ
- メンバーの追加・削除が可能
- プロジェクトの削除が可能

---

### 2. **管理者 (admin)** 👨‍💼

**管理権限**

| 操作 | 権限 |
|------|------|
| プロジェクト情報の編集 | ✅ 可能 |
| プロジェクトの削除 | ❌ 不可 |
| タスクの作成・編集・削除 | ✅ 可能 |
| コメントの投稿・編集・削除 | ✅ 可能 |
| 意見交換の投稿・編集・削除 | ✅ 可能 |
| リアクションの追加・削除 | ✅ 可能 |
| 会議の作成・編集・削除 | ✅ 可能 |
| メンバーの追加・削除 | ✅ 可能 |
| メンバーのロール変更 | ✅ 可能 |
| 通知の閲覧 | ✅ 可能 |
| 通知の作成・削除 | ✅ 可能 |

**特徴:**
- オーナーと同等の操作権限
- **プロジェクト削除のみ不可**
- メンバー管理が可能

---

### 3. **メンバー (member)** 👤

**標準編集権限**

| 操作 | 権限 |
|------|------|
| プロジェクト情報の編集 | ❌ 不可 |
| プロジェクトの削除 | ❌ 不可 |
| タスクの作成・編集・削除 | ✅ 可能 |
| コメントの投稿・編集・削除 | ✅ 可能 |
| 意見交換の投稿・編集・削除 | ✅ 可能 |
| リアクションの追加・削除 | ✅ 可能 |
| 会議の作成・編集・削除 | ✅ 可能 |
| メンバーの追加・削除 | ❌ 不可 |
| メンバーのロール変更 | ❌ 不可 |
| 通知の閲覧 | ✅ 可能 |
| 通知の作成・削除 | ✅ 可能 |

**特徴:**
- コンテンツの作成・編集が可能
- メンバー管理は不可
- プロジェクト情報の編集は不可

---

### 4. **閲覧者 (viewer)** 👀

**閲覧専用権限**

| 操作 | 権限 |
|------|------|
| プロジェクト情報の閲覧 | ✅ 可能 |
| プロジェクトの削除 | ❌ 不可 |
| タスクの作成・編集・削除 | ❌ 不可 |
| コメントの閲覧 | ✅ 可能 |
| コメントの投稿 | ❌ 不可 |
| 意見交換の閲覧 | ✅ 可能 |
| 意見交換の投稿 | ❌ 不可 |
| リアクションの追加 | ❌ 不可 |
| リアクションの閲覧 | ✅ 可能 |
| 会議の閲覧 | ✅ 可能 |
| 会議の作成・編集・削除 | ❌ 不可 |
| メンバーの追加・削除 | ❌ 不可 |
| 通知の閲覧 | ✅ 可能 |
| 通知の作成・削除 | ❌ 不可 |

**特徴:**
- **閲覧のみ**の権限
- あらゆる編集・作成が不可
- 報告・監査目的のユーザーに適している

---

## 🔄 ロール比較表

| 機能 | オーナー | 管理者 | メンバー | 閲覧者 |
|------|---------|--------|---------|--------|
| **プロジェクト管理** |
| プロジェクト情報編集 | ✅ | ✅ | ❌ | ❌ |
| プロジェクト削除 | ✅ | ❌ | ❌ | ❌ |
| **コンテンツ操作** |
| タスク作成・編集・削除 | ✅ | ✅ | ✅ | ❌ |
| コメント投稿・編集・削除 | ✅ | ✅ | ✅ | ❌ |
| 意見交換投稿・編集・削除 | ✅ | ✅ | ✅ | ❌ |
| リアクション追加 | ✅ | ✅ | ✅ | ❌ |
| 会議作成・編集・削除 | ✅ | ✅ | ✅ | ❌ |
| **メンバー管理** |
| メンバー追加・削除 | ✅ | ✅ | ❌ | ❌ |
| ロール変更 | ✅ | ✅ | ❌ | ❌ |
| **閲覧** |
| コンテンツ閲覧 | ✅ | ✅ | ✅ | ✅ |
| 通知閲覧 | ✅ | ✅ | ✅ | ✅ |

---

## 📊 権限の階層

```
┌─────────────────────────────────────┐
│  オーナー (owner)                    │ ← 全権限
│  ├─ プロジェクト削除可能            │
│  ├─ メンバー管理可能                │
│  ├─ コンテンツ編集可能              │
│  └─ 閲覧可能                        │
└─────────────────────────────────────┘
            ↓
┌─────────────────────────────────────┐
│  管理者 (admin)                      │ ← 管理権限
│  ├─ メンバー管理可能                │
│  ├─ コンテンツ編集可能              │
│  └─ 閲覧可能                        │
└─────────────────────────────────────┘
            ↓
┌─────────────────────────────────────┐
│  メンバー (member)                   │ ← 編集権限
│  ├─ コンテンツ編集可能              │
│  └─ 閲覧可能                        │
└─────────────────────────────────────┘
            ↓
┌─────────────────────────────────────┐
│  閲覧者 (viewer)                     │ ← 閲覧のみ
│  └─ 閲覧可能                        │
└─────────────────────────────────────┘
```

---

## 🎯 使用例

### オーナーの使用例
- プロジェクトの全体管理
- チームメンバーの追加・削除
- プロジェクトの開始・終了決定

### 管理者の使用例
- オーナーの代理としてプロジェクトを運営
- メンバーのロール調整
- ガイドラインの策定

### メンバーの使用例
- 日常的な作業（タスクの作成・更新）
- コメントでのコミュニケーション
- リアクションによるフィードバック

### 閲覧者の使用例
- 進捗状況の確認
- 報告書作成のための情報収集
- 監査・レビューのための閲覧
- クライアント・ステークホルダー向けアクセス

---

## 🔒 実装詳細

### RLSポリシーの実装

権限制御は Supabase の Row Level Security (RLS) で実現されています。

#### 閲覧権限（全ロール）
```sql
CREATE POLICY "プロジェクト閲覧者はタスクを閲覧可能" ON tasks
    FOR SELECT USING (
        project_id IN (
            SELECT project_id FROM project_members WHERE user_id = auth.uid()
        )
    );
```

#### 編集権限（member/admin/ownerのみ）
```sql
CREATE POLICY "プロジェクトメンバー以上はタスクを作成・更新・削除可能" ON tasks
    FOR ALL USING (
        project_id IN (
            SELECT project_id FROM project_members 
            WHERE user_id = auth.uid() AND role IN ('owner', 'admin', 'member')
        )
    );
```

#### 管理権限（admin/ownerのみ）
```sql
CREATE POLICY "オーナーまたは管理者はメンバーを追加可能" ON project_members
    FOR INSERT WITH CHECK (
        project_id IN (
            SELECT project_id FROM project_members
            WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
        )
    );
```

#### オーナー限定（ownerのみ）
```sql
CREATE POLICY "プロジェクトオーナーは削除可能" ON projects
    FOR DELETE USING (
        id IN (
            SELECT project_id FROM project_members
            WHERE user_id = auth.uid() AND role = 'owner'
        )
    );
```

---

## 📝 注意事項

### ロール変更について
- オーナーまたは管理者のみがロール変更可能
- オーナーは1人以上必要（最後のオーナーを削除できないようにすべき）
- ロール変更は即座に反映される

### 既存データへの影響
- ロール変更前の権限で作成されたデータはそのまま残る
- 削除権限を失っても、自分が作成したデータは削除可能（現行の実装では削除ボタンが表示される）

### セキュリティ考慮事項
- 閲覧者でも通知を受信する（今後の改善の余地あり）
- 個人情報を含む通知の扱いに注意が必要
- 機密性の高い情報は慎重に取り扱う

---

## 🔄 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v1.0 | 2025-11-01 | viewerロールの権限制限を追加 |
| - | 2025-11-01 | 4ロール構造の実装開始 |

---

## 🆘 トラブルシューティング

### Q: 閲覧者なのに編集できてしまう

**A:** RLSポリシーが正しく適用されているか確認してください。

```sql
-- 現在のロールを確認
SELECT role FROM project_members WHERE user_id = auth.uid();

-- RLSポリシーを確認
SELECT * FROM pg_policies WHERE tablename = 'tasks';
```

### Q: ロール変更が反映されない

**A:** ブラウザをリロードしてください。セッションが更新されます。

### Q: 閲覧者でもコメントボタンが表示される

**A:** UIレベルでの制御は今後の改善課題です。現時点ではボタンを押してもデータベースレベルで拒否されます。

---

**最終更新**: 2025-11-01  
**マイグレーションファイル**: `20251101_0020_add_viewer_role_permissions.sql`

