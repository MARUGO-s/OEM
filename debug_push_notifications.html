<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>プッシュ通知デバッグツール</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 5px; }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #2a2a2a; padding: 10px; border-radius: 3px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>🔔 プッシュ通知デバッグツール</h1>
    
    <div class="section">
        <h2>📊 ブラウザ環境の確認</h2>
        <button onclick="checkBrowserSupport()">ブラウザサポートを確認</button>
        <div id="browserSupport" class="log"></div>
    </div>

    <div class="section">
        <h2>🔐 通知許可の確認・リクエスト</h2>
        <button onclick="checkNotificationPermission()">通知許可を確認</button>
        <button onclick="requestNotificationPermission()">通知許可をリクエスト</button>
        <div id="notificationPermission" class="log"></div>
    </div>

    <div class="section">
        <h2>⚙️ Service Workerの確認</h2>
        <button onclick="checkServiceWorker()">Service Workerを確認</button>
        <button onclick="resetServiceWorker()">Service Workerをリセット</button>
        <button onclick="registerServiceWorker()">Service Workerを登録</button>
        <button onclick="forceActivateServiceWorker()">Service Workerを強制アクティブ化</button>
        <button onclick="subscribeToPushNotifications()">プッシュ通知をサブスクライブ</button>
        <button onclick="checkExistingSubscription()">既存のサブスクリプションを確認</button>
        <div id="serviceWorker" class="log"></div>
    </div>

    <div class="section">
        <h2>🧪 テスト通知の送信</h2>
        <button onclick="sendTestNotification()">テスト通知を送信</button>
        <button onclick="sendTestNotificationViaServiceWorker()">Service Worker経由でテスト通知</button>
        <button onclick="sendTestNotificationWithoutVAPID()">VAPIDキーなしでテスト通知</button>
        <button onclick="resetNotificationState()">通知状態をリセット</button>
        <div id="testNotification" class="log"></div>
    </div>

    <div class="section">
        <h2>📡 Supabase接続の確認</h2>
        <button onclick="checkSupabaseConnection()">Supabase接続を確認</button>
        <button onclick="testRealtimeSubscription()">リアルタイムサブスクリプションをテスト</button>
        <div id="supabaseConnection" class="log"></div>
    </div>

    <div class="section">
        <h2>🔍 通知の流れをデバッグ</h2>
        <button onclick="debugNotificationFlow()">通知の流れをデバッグ</button>
        <div id="notificationFlow" class="log"></div>
    </div>

    <div class="section">
        <h2>📱 iPhoneでのPWAインストール手順</h2>
        <button onclick="showPWAInstallInstructions()">PWAインストール手順を表示</button>
        <div id="pwaInstallInstructions" class="log"></div>
    </div>

    <div class="section">
        <h2>📚 プッシュ通知の種類と実装方法</h2>
        <button onclick="showNotificationTypes()">通知の種類を説明</button>
        <div id="notificationTypes" class="log"></div>
    </div>

    <script>
        // Supabase設定
        const SUPABASE_URL = 'https://mrjocjcppjnjxtudebta.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yam9jamNwcGpuanh0dWRlYnRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NTk5NDksImV4cCI6MjA3NjQzNTk0OX0.jflBtUsb7Qq4-p-e-XDUb1DoxHbwjG1DFXPXDC-sN2E';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        }

        function checkBrowserSupport() {
            const elementId = 'browserSupport';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🔍 ブラウザサポートを確認中...');
            
            // 通知APIサポート
            if ('Notification' in window) {
                log(elementId, '✅ Notification API がサポートされています', 'success');
                log(elementId, `📱 通知許可状態: ${Notification.permission}`, 'info');
            } else {
                log(elementId, '❌ Notification API がサポートされていません', 'error');
            }

            // Service Workerサポート
            if ('serviceWorker' in navigator) {
                log(elementId, '✅ Service Worker がサポートされています', 'success');
            } else {
                log(elementId, '❌ Service Worker がサポートされていません', 'error');
            }

            // Push Managerサポート
            if ('PushManager' in window) {
                log(elementId, '✅ PushManager がサポートされています', 'success');
            } else {
                log(elementId, '❌ PushManager がサポートされていません', 'error');
            }

            // セキュアコンテキスト
            if (window.isSecureContext) {
                log(elementId, '✅ セキュアコンテキスト（HTTPS）です', 'success');
            } else {
                log(elementId, '❌ セキュアコンテキストではありません（HTTP）', 'error');
            }

            // ユーザーエージェント
            log(elementId, `📱 ユーザーエージェント: ${navigator.userAgent}`, 'info');
            
            // iOS/Android の特別な処理
            const isIOS = navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad');
            const isAndroid = navigator.userAgent.includes('Android');
            
            if (isIOS) {
                log(elementId, '🍎 iOS デバイスが検出されました', 'info');
                log(elementId, '⚠️ iOS Safari ではプッシュ通知に制限があります', 'warning');
                log(elementId, '💡 PWAとしてホーム画面に追加すると通知が可能です', 'info');
                log(elementId, '💡 ブラウザでは通知が制限されています', 'warning');
            } else if (isAndroid) {
                log(elementId, '🤖 Android デバイスが検出されました', 'info');
                log(elementId, '💡 Android ではChrome/Firefoxで通知が可能です', 'info');
            }
        }

        function checkNotificationPermission() {
            const elementId = 'notificationPermission';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🔍 通知許可状況を確認中...');
            
            if ('Notification' in window) {
                const permission = Notification.permission;
                log(elementId, `📱 現在の許可状態: ${permission}`, 'info');
                
                switch(permission) {
                    case 'granted':
                        log(elementId, '✅ 通知が許可されています', 'success');
                        break;
                    case 'denied':
                        log(elementId, '❌ 通知が拒否されています', 'error');
                        log(elementId, '💡 ブラウザの設定で通知を許可してください', 'warning');
                        break;
                    case 'default':
                        log(elementId, '⚠️ 通知許可がまだリクエストされていません', 'warning');
                        break;
                }
            } else {
                log(elementId, '❌ Notification API がサポートされていません', 'error');
            }
        }

        async function requestNotificationPermission() {
            const elementId = 'notificationPermission';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🔔 通知許可をリクエスト中...');
            
            if ('Notification' in window) {
                try {
                    const permission = await Notification.requestPermission();
                    log(elementId, `📱 許可結果: ${permission}`, permission === 'granted' ? 'success' : 'error');
                    
                    if (permission === 'granted') {
                        log(elementId, '✅ 通知が許可されました！', 'success');
                        // テスト通知を送信
                        showTestNotification('通知許可が完了しました！', 'これでプッシュ通知が届くはずです。');
                    } else {
                        log(elementId, '❌ 通知が拒否されました', 'error');
                    }
                } catch (error) {
                    log(elementId, `❌ 通知許可リクエストでエラー: ${error.message}`, 'error');
                }
            } else {
                log(elementId, '❌ Notification API がサポートされていません', 'error');
            }
        }

        function showTestNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    const notification = new Notification(title, {
                        body: body,
                        icon: '/OEM/icon-192.svg',
                        badge: '/OEM/icon-192.svg',
                        tag: 'test-notification',
                        requireInteraction: true
                    });
                    
                    notification.onclick = function() {
                        console.log('通知がクリックされました');
                        notification.close();
                    };
                    
                    return notification;
                } catch (error) {
                    console.error('通知作成エラー:', error);
                    return null;
                }
            }
            return null;
        }

        async function checkServiceWorker() {
            const elementId = 'serviceWorker';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🔍 Service Workerを確認中...');
            
            if (!('serviceWorker' in navigator)) {
                log(elementId, '❌ Service Worker がサポートされていません', 'error');
                return;
            }
            
            try {
                // まず既存のService Workerを確認
                const existingRegistrations = await navigator.serviceWorker.getRegistrations();
                log(elementId, `📊 既存のService Worker数: ${existingRegistrations.length}`, 'info');
                
                if (existingRegistrations.length === 0) {
                    log(elementId, '⚠️ Service Worker が登録されていません', 'warning');
                    log(elementId, '🔄 Service Worker を登録中...', 'info');
                    
                    try {
                        const registration = await navigator.serviceWorker.register('/OEM/sw.js', {
                            scope: '/OEM/'
                        });
                        log(elementId, '✅ Service Worker を登録しました', 'success');
                        log(elementId, `📱 スコープ: ${registration.scope}`, 'info');
                        
                        // 登録後、少し待ってから状態を確認
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                    } catch (registerError) {
                        log(elementId, `❌ Service Worker の登録でエラー: ${registerError.message}`, 'error');
                        return;
                    }
                }
                
                // Service Workerの状態を確認
                const registration = await navigator.serviceWorker.ready;
                log(elementId, '✅ Service Worker が登録されています', 'success');
                log(elementId, `📱 スコープ: ${registration.scope}`, 'info');
                
                // 各状態を詳細に確認
                if (registration.installing) {
                    log(elementId, '🔄 Service Worker がインストール中です', 'info');
                    registration.installing.addEventListener('statechange', (e) => {
                        log(elementId, `📱 インストール状態: ${e.target.state}`, 'info');
                    });
                }
                
                if (registration.waiting) {
                    log(elementId, '⏳ Service Worker が待機中です', 'warning');
                }
                
                if (registration.active) {
                    log(elementId, '✅ Service Worker がアクティブです', 'success');
                    log(elementId, `📱 アクティブなService Worker: ${registration.active.scriptURL}`, 'info');
                } else {
                    log(elementId, '⚠️ Service Worker がアクティブではありません', 'warning');
                }
                
                // プッシュ通知のサブスクリプション確認
                if ('PushManager' in window) {
                    try {
                        const subscription = await registration.pushManager.getSubscription();
                        if (subscription) {
                            log(elementId, '✅ プッシュ通知のサブスクリプションが存在します', 'success');
                        } else {
                            log(elementId, '⚠️ プッシュ通知のサブスクリプションが存在しません', 'warning');
                        }
                    } catch (error) {
                        log(elementId, `⚠️ プッシュ通知サブスクリプションの確認でエラー: ${error.message}`, 'warning');
                    }
                }
                
                // Service Workerとの通信テスト
                if (registration.active) {
                    log(elementId, '📡 Service Worker との通信をテスト中...', 'info');
                    
                    const messageChannel = new MessageChannel();
                    messageChannel.port1.onmessage = (event) => {
                        log(elementId, `📨 Service Worker からの応答: ${event.data}`, 'success');
                    };
                    
                    registration.active.postMessage({
                        type: 'PING',
                        message: 'Service Worker の通信テスト'
                    }, [messageChannel.port2]);
                    
                    // タイムアウト設定
                    setTimeout(() => {
                        log(elementId, '⏰ Service Worker の応答がタイムアウトしました', 'warning');
                    }, 3000);
                }
                
            } catch (error) {
                log(elementId, `❌ Service Worker の確認でエラー: ${error.message}`, 'error');
                log(elementId, `📝 エラー詳細: ${error.stack}`, 'error');
            }
        }

        function sendTestNotification() {
            const elementId = 'testNotification';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🧪 テスト通知を送信中...');
            
            // 詳細な診断情報を表示
            log(elementId, `📱 現在の通知許可状態: ${Notification.permission}`, 'info');
            log(elementId, `📱 ブラウザサポート: ${'Notification' in window ? 'あり' : 'なし'}`, 'info');
            log(elementId, `📱 セキュアコンテキスト: ${window.isSecureContext ? 'あり' : 'なし'}`, 'info');
            log(elementId, `📱 ユーザーエージェント: ${navigator.userAgent.includes('iPhone') ? 'iPhone' : navigator.userAgent.includes('Android') ? 'Android' : 'PC'}`, 'info');
            
            if (!('Notification' in window)) {
                log(elementId, '❌ Notification API がサポートされていません', 'error');
                log(elementId, '💡 このブラウザでは通知がサポートされていません', 'warning');
                return;
            }
            
            if (Notification.permission !== 'granted') {
                log(elementId, '❌ 通知が許可されていません', 'error');
                log(elementId, '💡 通知許可をリクエストしてください', 'info');
                return;
            }
            
            const notification = showTestNotification(
                'MARUGO OEM Special Menu',
                'これはテスト通知です。プッシュ通知が正常に動作しています。'
            );
            
            if (notification) {
                log(elementId, '✅ テスト通知を送信しました', 'success');
                log(elementId, '📱 通知が表示されるはずです', 'info');
                
                // 通知のイベントリスナーを追加
                notification.onclick = () => {
                    log(elementId, '📱 通知がクリックされました', 'info');
                    window.focus();
                };
                
                notification.onerror = (error) => {
                    log(elementId, `❌ 通知エラー: ${error}`, 'error');
                };
                
                // 5秒後に通知の状態を確認
                setTimeout(() => {
                    log(elementId, '📱 通知の状態確認完了', 'info');
                }, 5000);
            } else {
                log(elementId, '❌ テスト通知の送信に失敗しました', 'error');
            }
        }

        async function sendTestNotificationWithServiceWorker() {
            const elementId = 'testNotification';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🧪 Service Worker経由でテスト通知を送信中...');
            
            try {
                const registration = await navigator.serviceWorker.ready;
                
                if (registration.active) {
                    // Service Workerにメッセージを送信
                    registration.active.postMessage({
                        type: 'SHOW_NOTIFICATION',
                        notificationData: {
                            title: 'MARUGO OEM Special Menu',
                            message: 'Service Worker経由のテスト通知です',
                            icon: '/OEM/icon-192.svg',
                            badge: '/OEM/icon-192.svg',
                            tag: 'sw-test-notification',
                            url: '/OEM/',
                            notification_id: 'test-' + Date.now()
                        }
                    });
                    
                    log(elementId, '✅ Service Workerに通知メッセージを送信しました', 'success');
                } else {
                    log(elementId, '❌ Service Worker がアクティブではありません', 'error');
                }
            } catch (error) {
                log(elementId, `❌ Service Worker経由の通知送信でエラー: ${error.message}`, 'error');
            }
        }

        async function checkSupabaseConnection() {
            const elementId = 'supabaseConnection';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🔍 Supabase接続を確認中...');
            
            try {
                // 基本的な接続テスト
                const { data, error } = await supabase
                    .from('notifications')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    log(elementId, `❌ Supabase接続エラー: ${error.message}`, 'error');
                } else {
                    log(elementId, '✅ Supabase接続が正常です', 'success');
                }
                
                // リアルタイム機能のテスト
                log(elementId, '📡 リアルタイム機能をテスト中...');
                
                const channel = supabase
                    .channel('debug-notifications')
                    .on('postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'notifications' },
                        (payload) => {
                            log(elementId, `🔔 リアルタイム通知を受信: ${JSON.stringify(payload)}`, 'success');
                        }
                    )
                    .subscribe((status) => {
                        log(elementId, `📊 リアルタイムサブスクリプション状態: ${status}`, 'info');
                    });
                
                // 5秒後にサブスクリプションをクリーンアップ
                setTimeout(() => {
                    channel.unsubscribe();
                    log(elementId, '🧹 テスト用サブスクリプションをクリーンアップしました', 'info');
                }, 5000);
                
            } catch (error) {
                log(elementId, `❌ Supabase接続確認でエラー: ${error.message}`, 'error');
            }
        }

        async function testRealtimeSubscription() {
            const elementId = 'supabaseConnection';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '📡 リアルタイムサブスクリプションをテスト中...');
            
            try {
                // テスト通知を挿入
                const { data, error } = await supabase
                    .from('notifications')
                    .insert([{
                        message: 'デバッグ用テスト通知',
                        type: 'debug',
                        created_by: null
                    }])
                    .select();
                
                if (error) {
                    log(elementId, `❌ テスト通知の挿入でエラー: ${error.message}`, 'error');
                } else {
                    log(elementId, '✅ テスト通知を挿入しました', 'success');
                    log(elementId, `📝 挿入された通知: ${JSON.stringify(data)}`, 'info');
                }
                
            } catch (error) {
                log(elementId, `❌ リアルタイムテストでエラー: ${error.message}`, 'error');
            }
        }

        async function debugNotificationFlow() {
            const elementId = 'notificationFlow';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🔍 通知の流れをデバッグ中...');
            
            // 1. ブラウザサポート確認
            log(elementId, '1️⃣ ブラウザサポート確認');
            if (!('Notification' in window)) {
                log(elementId, '❌ Notification API がサポートされていません', 'error');
                return;
            }
            if (!('serviceWorker' in navigator)) {
                log(elementId, '❌ Service Worker がサポートされていません', 'error');
                return;
            }
            log(elementId, '✅ ブラウザサポートOK', 'success');
            
            // 2. 通知許可確認
            log(elementId, '2️⃣ 通知許可確認');
            if (Notification.permission !== 'granted') {
                log(elementId, `❌ 通知が許可されていません: ${Notification.permission}`, 'error');
                return;
            }
            log(elementId, '✅ 通知許可OK', 'success');
            
            // 3. Service Worker確認
            log(elementId, '3️⃣ Service Worker確認');
            try {
                const registration = await navigator.serviceWorker.ready;
                if (!registration.active) {
                    log(elementId, '❌ Service Worker がアクティブではありません', 'error');
                    return;
                }
                log(elementId, '✅ Service Worker OK', 'success');
            } catch (error) {
                log(elementId, `❌ Service Worker エラー: ${error.message}`, 'error');
                return;
            }
            
            // 4. Supabase接続確認
            log(elementId, '4️⃣ Supabase接続確認');
            try {
                const { data, error } = await supabase
                    .from('notifications')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    log(elementId, `❌ Supabase接続エラー: ${error.message}`, 'error');
                    return;
                }
                log(elementId, '✅ Supabase接続OK', 'success');
            } catch (error) {
                log(elementId, `❌ Supabase接続エラー: ${error.message}`, 'error');
                return;
            }
            
            // 5. 総合判定
            log(elementId, '🎯 総合判定');
            log(elementId, '✅ すべての条件が満たされています', 'success');
            log(elementId, '💡 プッシュ通知が届かない場合は、以下を確認してください:', 'info');
            log(elementId, '   - アプリがフォアグラウンドにいるか', 'info');
            log(elementId, '   - ブラウザの通知設定', 'info');
            log(elementId, '   - ネットワーク接続', 'info');
            log(elementId, '   - Service Workerの状態', 'info');
        }

        async function resetServiceWorker() {
            const elementId = 'serviceWorker';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🔄 Service Worker をリセット中...');
            
            try {
                // 既存のService Workerをすべて削除
                const registrations = await navigator.serviceWorker.getRegistrations();
                log(elementId, `📊 削除対象のService Worker数: ${registrations.length}`, 'info');
                
                for (const registration of registrations) {
                    await registration.unregister();
                    log(elementId, `✅ Service Worker を削除しました: ${registration.scope}`, 'success');
                }
                
                log(elementId, '✅ Service Worker のリセットが完了しました', 'success');
                log(elementId, '💡 ページをリロードしてから再度確認してください', 'info');
                
                // 自動的に再登録を試行
                log(elementId, '🔄 自動的にService Workerを再登録中...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1000));
                await registerServiceWorker();
                
            } catch (error) {
                log(elementId, `❌ Service Worker のリセットでエラー: ${error.message}`, 'error');
            }
        }

        async function registerServiceWorker() {
            const elementId = 'serviceWorker';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🔄 Service Worker を登録中...');
            
            if (!('serviceWorker' in navigator)) {
                log(elementId, '❌ Service Worker がサポートされていません', 'error');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.register('/OEM/sw.js', {
                    scope: '/OEM/'
                });
                
                log(elementId, '✅ Service Worker を登録しました', 'success');
                log(elementId, `📱 スコープ: ${registration.scope}`, 'info');
                
                // 登録後の状態を確認
                registration.addEventListener('updatefound', () => {
                    log(elementId, '🔄 Service Worker の更新が見つかりました', 'info');
                });
                
                // 少し待ってから状態を確認
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                if (registration.active) {
                    log(elementId, '✅ Service Worker がアクティブです', 'success');
                } else if (registration.installing) {
                    log(elementId, '🔄 Service Worker がインストール中です', 'info');
                } else if (registration.waiting) {
                    log(elementId, '⏳ Service Worker が待機中です', 'warning');
                }
                
            } catch (error) {
                log(elementId, `❌ Service Worker の登録でエラー: ${error.message}`, 'error');
                log(elementId, `📝 エラー詳細: ${error.stack}`, 'error');
            }
        }

        async function subscribeToPushNotifications() {
            const elementId = 'serviceWorker';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🔄 プッシュ通知のサブスクリプションを作成中...');
            
            // タイムアウト処理を追加
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('サブスクリプション作成がタイムアウトしました')), 10000);
            });
            
            try {
                // Service Workerの登録を確認
                const registration = await navigator.serviceWorker.ready;
                log(elementId, '✅ Service Worker が準備完了しました', 'success');
                
                // プッシュ通知のサブスクリプションを作成
                let subscription;
                try {
                    // まずVAPIDキーなしで試行
                    subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true
                    });
                    log(elementId, '✅ VAPIDキーなしでサブスクリプションを作成しました', 'success');
                } catch (error) {
                    log(elementId, `⚠️ VAPIDキーなしでの作成に失敗: ${error.message}`, 'warning');
                    log(elementId, '🔄 代替方法を試行中...', 'info');
                    
                    // 代替方法: 既存のサブスクリプションを取得
                    subscription = await registration.pushManager.getSubscription();
                    if (subscription) {
                        log(elementId, '✅ 既存のサブスクリプションを取得しました', 'success');
                    } else {
                        log(elementId, '❌ サブスクリプションの作成に失敗しました', 'error');
                        log(elementId, '💡 VAPIDキーが必要です', 'warning');
                        log(elementId, '💡 現在はService Worker経由の通知のみ可能です', 'info');
                        return null;
                    }
                }
                
                log(elementId, '✅ プッシュ通知のサブスクリプションを作成しました', 'success');
                log(elementId, `📱 エンドポイント: ${subscription.endpoint}`, 'info');
                
                // サブスクリプション情報を表示
                const key = subscription.getKey('p256dh');
                const auth = subscription.getKey('auth');
                
                if (key) {
                    log(elementId, `🔑 P256DH キー: ${btoa(String.fromCharCode.apply(null, new Uint8Array(key)))}`, 'info');
                }
                if (auth) {
                    log(elementId, `🔐 Auth キー: ${btoa(String.fromCharCode.apply(null, new Uint8Array(auth)))}`, 'info');
                }
                
                return subscription;
                
            } catch (error) {
                log(elementId, `❌ プッシュ通知のサブスクリプション作成でエラー: ${error.message}`, 'error');
                log(elementId, `📝 エラー詳細: ${error.stack}`, 'error');
                
                // 具体的なエラーメッセージを追加
                if (error.message.includes('タイムアウト')) {
                    log(elementId, '⏰ 10秒でタイムアウトしました', 'warning');
                    log(elementId, '💡 ブラウザの通知設定を確認してください', 'info');
                } else if (error.message.includes('Permission denied')) {
                    log(elementId, '🔒 通知許可が拒否されています', 'error');
                    log(elementId, '💡 ブラウザの設定で通知を許可してください', 'info');
                } else if (error.message.includes('Not supported')) {
                    log(elementId, '❌ このブラウザはプッシュ通知をサポートしていません', 'error');
                    log(elementId, '💡 Chrome、Firefox、Safari 14+ を使用してください', 'info');
                }
                
                return null;
            }
        }

        async function sendTestNotificationViaServiceWorker() {
            const elementId = 'testNotification';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🔄 Service Worker経由でテスト通知を送信中...');
            
            try {
                // Service Workerの登録を確認
                const registration = await navigator.serviceWorker.ready;
                log(elementId, '✅ Service Worker が準備完了しました', 'success');
                
                // Service Workerにメッセージを送信
                if (registration.active) {
                    registration.active.postMessage({
                        type: 'SHOW_NOTIFICATION',
                        title: 'テスト通知',
                        options: {
                            body: 'Service Worker経由のテスト通知です',
                            icon: '/OEM/icon-192.svg',
                            badge: '/OEM/icon-192.svg',
                            tag: 'test-notification',
                            requireInteraction: true,
                            silent: false
                        }
                    });
                    
                    log(elementId, '✅ Service Worker にメッセージを送信しました', 'success');
                    log(elementId, '📱 通知が表示されるはずです', 'info');
                } else {
                    log(elementId, '❌ Service Worker がアクティブではありません', 'error');
                }
                
            } catch (error) {
                log(elementId, `❌ テスト通知の送信でエラー: ${error.message}`, 'error');
                log(elementId, `📝 エラー詳細: ${error.stack}`, 'error');
            }
        }

        async function forceActivateServiceWorker() {
            const elementId = 'serviceWorker';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🔄 Service Worker を強制アクティブ化中...');
            
            try {
                // Service Workerの登録を確認
                const registration = await navigator.serviceWorker.ready;
                log(elementId, '✅ Service Worker が準備完了しました', 'success');
                
                if (registration.active) {
                    log(elementId, '✅ Service Worker は既にアクティブです', 'success');
                    return;
                }
                
                // Service Workerを強制的にアクティブ化
                if (registration.installing) {
                    log(elementId, '🔄 Service Worker がインストール中です...', 'info');
                    await new Promise(resolve => {
                        registration.installing.addEventListener('statechange', () => {
                            if (registration.installing.state === 'activated') {
                                resolve();
                            }
                        });
                    });
                } else if (registration.waiting) {
                    log(elementId, '🔄 Service Worker が待機中です...', 'info');
                    // 待機中のService Workerをアクティブ化
                    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                // 最終確認
                if (registration.active) {
                    log(elementId, '✅ Service Worker がアクティブになりました', 'success');
                } else {
                    log(elementId, '⚠️ Service Worker のアクティブ化に失敗しました', 'warning');
                    log(elementId, '💡 ページをリロードしてから再度確認してください', 'info');
                }
                
            } catch (error) {
                log(elementId, `❌ Service Worker の強制アクティブ化でエラー: ${error.message}`, 'error');
                log(elementId, `📝 エラー詳細: ${error.stack}`, 'error');
            }
        }

        async function checkExistingSubscription() {
            const elementId = 'serviceWorker';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🔄 既存のプッシュ通知サブスクリプションを確認中...');
            
            try {
                // Service Workerの登録を確認
                const registration = await navigator.serviceWorker.ready;
                log(elementId, '✅ Service Worker が準備完了しました', 'success');
                
                // 既存のサブスクリプションを取得
                const subscription = await registration.pushManager.getSubscription();
                
                if (subscription) {
                    log(elementId, '✅ 既存のサブスクリプションが見つかりました', 'success');
                    log(elementId, `📱 エンドポイント: ${subscription.endpoint}`, 'info');
                    
                    // サブスクリプション情報を表示
                    const key = subscription.getKey('p256dh');
                    const auth = subscription.getKey('auth');
                    
                    if (key) {
                        log(elementId, `🔑 P256DH キー: ${btoa(String.fromCharCode.apply(null, new Uint8Array(key)))}`, 'info');
                    }
                    if (auth) {
                        log(elementId, `🔐 Auth キー: ${btoa(String.fromCharCode.apply(null, new Uint8Array(auth)))}`, 'info');
                    }
                } else {
                    log(elementId, '❌ 既存のサブスクリプションが見つかりません', 'warning');
                    log(elementId, '💡 「プッシュ通知をサブスクライブ」ボタンをクリックしてください', 'info');
                }
                
            } catch (error) {
                log(elementId, `❌ サブスクリプション確認でエラー: ${error.message}`, 'error');
                log(elementId, `📝 エラー詳細: ${error.stack}`, 'error');
            }
        }

        function showPWAInstallInstructions() {
            const elementId = 'pwaInstallInstructions';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '📱 iPhoneでのPWAインストール手順', 'info');
            log(elementId, '', 'info');
            log(elementId, '🍎 iOS Safari ではプッシュ通知に制限があります', 'warning');
            log(elementId, '💡 PWAとしてホーム画面に追加すると通知が可能です', 'info');
            log(elementId, '', 'info');
            log(elementId, '📋 インストール手順:', 'info');
            log(elementId, '1. Safari で https://marugo-s.github.io/OEM/ にアクセス', 'info');
            log(elementId, '2. 画面下部の「共有」ボタンをタップ', 'info');
            log(elementId, '3. 「ホーム画面に追加」を選択', 'info');
            log(elementId, '4. 「追加」をタップ', 'info');
            log(elementId, '5. ホーム画面からアプリを起動', 'info');
            log(elementId, '', 'info');
            log(elementId, '✅ PWAとしてインストール後は通知が可能です', 'success');
            log(elementId, '⚠️ ブラウザから直接アクセスした場合は通知が制限されます', 'warning');
        }

        async function resetNotificationState() {
            const elementId = 'testNotification';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🔄 通知状態をリセット中...');
            
            try {
                // 既存の通知をすべて閉じる
                if ('Notification' in window) {
                    log(elementId, '📱 既存の通知を閉じています...', 'info');
                }
                
                // Service Workerをリセット
                const registrations = await navigator.serviceWorker.getRegistrations();
                log(elementId, `📊 既存のService Worker数: ${registrations.length}`, 'info');
                
                for (const registration of registrations) {
                    await registration.unregister();
                    log(elementId, `✅ Service Worker を削除しました: ${registration.scope}`, 'success');
                }
                
                // 通知許可をリセット（可能な場合）
                if ('Notification' in window) {
                    log(elementId, `📱 現在の通知許可状態: ${Notification.permission}`, 'info');
                    if (Notification.permission === 'denied') {
                        log(elementId, '⚠️ 通知が拒否されています', 'warning');
                        log(elementId, '💡 ブラウザの設定で通知を許可してください', 'info');
                    }
                }
                
                log(elementId, '✅ 通知状態のリセットが完了しました', 'success');
                log(elementId, '💡 ページをリロードしてから再度テストしてください', 'info');
                
            } catch (error) {
                log(elementId, `❌ 通知状態のリセットでエラー: ${error.message}`, 'error');
                log(elementId, `📝 エラー詳細: ${error.stack}`, 'error');
            }
        }

        async function sendTestNotificationWithoutVAPID() {
            const elementId = 'testNotification';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '🧪 VAPIDキーなしでテスト通知を送信中...');
            log(elementId, '📚 参考: ローカル通知（アプリから直接発火）', 'info');
            
            try {
                // Service Workerの登録を確認
                const registration = await navigator.serviceWorker.ready;
                log(elementId, '✅ Service Worker が準備完了しました', 'success');
                
                if (registration.active) {
                    // 記事の実装方法を参考にした通知データ
                    const notificationData = {
                        type: 'SHOW_NOTIFICATION',
                        title: 'MARUGO OEM Special Menu',
                        options: {
                            body: 'VAPIDキーなしのローカル通知です（Service Worker経由）',
                            icon: '/OEM/icon-192.svg',
                            badge: '/OEM/icon-192.svg',
                            tag: 'test-without-vapid',
                            requireInteraction: true,
                            silent: false,
                            // 記事の実装方法を参考にした追加オプション
                            data: {
                                url: '/OEM/',
                                timestamp: Date.now(),
                                type: 'local-notification'
                            }
                        }
                    };
                    
                    // Service Workerにメッセージを送信
                    registration.active.postMessage(notificationData);
                    
                    log(elementId, '✅ Service Worker にメッセージを送信しました', 'success');
                    log(elementId, '📱 通知が表示されるはずです', 'info');
                    log(elementId, '💡 これはローカル通知（アプリから直接発火）です', 'info');
                    log(elementId, '💡 インターネット接続不要で動作します', 'info');
                } else {
                    log(elementId, '❌ Service Worker がアクティブではありません', 'error');
                    log(elementId, '💡 「Service Workerを強制アクティブ化」をクリックしてください', 'info');
                }
                
            } catch (error) {
                log(elementId, `❌ VAPIDキーなしのテスト通知でエラー: ${error.message}`, 'error');
                log(elementId, `📝 エラー詳細: ${error.stack}`, 'error');
            }
        }

        function showNotificationTypes() {
            const elementId = 'notificationTypes';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, '📚 プッシュ通知の種類と実装方法', 'info');
            log(elementId, '', 'info');
            log(elementId, '🔔 プッシュ通知には大きく2種類あります:', 'info');
            log(elementId, '', 'info');
            log(elementId, '1️⃣ ローカル通知（Local Notification）', 'info');
            log(elementId, '   - アプリから直接発火', 'info');
            log(elementId, '   - インターネット接続不要', 'info');
            log(elementId, '   - 例: アラームアプリ、タイマー', 'info');
            log(elementId, '   - 実装: Service Worker経由', 'info');
            log(elementId, '', 'info');
            log(elementId, '2️⃣ リモート通知（Remote Notification）', 'info');
            log(elementId, '   - サーバー経由で配信', 'info');
            log(elementId, '   - インターネット接続必要', 'info');
            log(elementId, '   - 例: チャットメッセージ、ニュース', 'info');
            log(elementId, '   - 実装: Supabase Edge Function send-push + VAPIDキー', 'info');
            log(elementId, '', 'info');
            log(elementId, '🎯 現在の実装状況:', 'info');
            log(elementId, '✅ ローカル通知: Service Worker経由で実装済み', 'success');
            log(elementId, '✅ リモート通知: Edge Function経由で配信', 'success');
            log(elementId, '   - 環境変数: VAPID_PUBLIC_KEY / VAPID_PRIVATE_KEY / VAPID_SUBJECT', 'info');
            log(elementId, '', 'info');
            log(elementId, '💡 参考記事: https://gist.github.com/pine/8b7e58ff7fa259df17351d959c6118f7', 'info');
        }

        // ページ読み込み時に自動実行
        window.addEventListener('load', () => {
            checkBrowserSupport();
            checkNotificationPermission();
            checkServiceWorker();
        });
    </script>
</body>
</html>
