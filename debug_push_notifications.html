<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 5px; }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #2a2a2a; padding: 10px; border-radius: 3px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ”” ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
    
    <div class="section">
        <h2>ğŸ“Š ãƒ–ãƒ©ã‚¦ã‚¶ç’°å¢ƒã®ç¢ºèª</h2>
        <button onclick="checkBrowserSupport()">ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆã‚’ç¢ºèª</button>
        <div id="browserSupport" class="log"></div>
    </div>

    <div class="section">
        <h2>ğŸ” é€šçŸ¥è¨±å¯ã®ç¢ºèªãƒ»ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</h2>
        <button onclick="checkNotificationPermission()">é€šçŸ¥è¨±å¯ã‚’ç¢ºèª</button>
        <button onclick="requestNotificationPermission()">é€šçŸ¥è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</button>
        <div id="notificationPermission" class="log"></div>
    </div>

    <div class="section">
        <h2>âš™ï¸ Service Workerã®ç¢ºèª</h2>
        <button onclick="checkServiceWorker()">Service Workerã‚’ç¢ºèª</button>
        <button onclick="resetServiceWorker()">Service Workerã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        <button onclick="registerServiceWorker()">Service Workerã‚’ç™»éŒ²</button>
        <button onclick="forceActivateServiceWorker()">Service Workerã‚’å¼·åˆ¶ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–</button>
        <button onclick="subscribeToPushNotifications()">ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–</button>
        <button onclick="checkExistingSubscription()">æ—¢å­˜ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç¢ºèª</button>
        <div id="serviceWorker" class="log"></div>
    </div>

    <div class="section">
        <h2>ğŸ§ª ãƒ†ã‚¹ãƒˆé€šçŸ¥ã®é€ä¿¡</h2>
        <button onclick="sendTestNotification()">ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡</button>
        <button onclick="sendTestNotificationViaServiceWorker()">Service WorkerçµŒç”±ã§ãƒ†ã‚¹ãƒˆé€šçŸ¥</button>
        <button onclick="sendTestNotificationWithoutVAPID()">VAPIDã‚­ãƒ¼ãªã—ã§ãƒ†ã‚¹ãƒˆé€šçŸ¥</button>
        <button onclick="resetNotificationState()">é€šçŸ¥çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        <div id="testNotification" class="log"></div>
    </div>

    <div class="section">
        <h2>ğŸ“¡ Supabaseæ¥ç¶šã®ç¢ºèª</h2>
        <button onclick="checkSupabaseConnection()">Supabaseæ¥ç¶šã‚’ç¢ºèª</button>
        <button onclick="testRealtimeSubscription()">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒ†ã‚¹ãƒˆ</button>
        <div id="supabaseConnection" class="log"></div>
    </div>

    <div class="section">
        <h2>ğŸ” é€šçŸ¥ã®æµã‚Œã‚’ãƒ‡ãƒãƒƒã‚°</h2>
        <button onclick="debugNotificationFlow()">é€šçŸ¥ã®æµã‚Œã‚’ãƒ‡ãƒãƒƒã‚°</button>
        <div id="notificationFlow" class="log"></div>
    </div>

    <div class="section">
        <h2>ğŸ“± iPhoneã§ã®PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †</h2>
        <button onclick="showPWAInstallInstructions()">PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †ã‚’è¡¨ç¤º</button>
        <div id="pwaInstallInstructions" class="log"></div>
    </div>

    <div class="section">
        <h2>ğŸ“š ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®ç¨®é¡ã¨å®Ÿè£…æ–¹æ³•</h2>
        <button onclick="showNotificationTypes()">é€šçŸ¥ã®ç¨®é¡ã‚’èª¬æ˜</button>
        <div id="notificationTypes" class="log"></div>
    </div>

    <script>
        // Supabaseè¨­å®š
        const SUPABASE_URL = 'https://mrjocjcppjnjxtudebta.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yam9jamNwcGpuanh0dWRlYnRhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NTk5NDksImV4cCI6MjA3NjQzNTk0OX0.jflBtUsb7Qq4-p-e-XDUb1DoxHbwjG1DFXPXDC-sN2E';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        }

        function checkBrowserSupport() {
            const elementId = 'browserSupport';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ” ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆã‚’ç¢ºèªä¸­...');
            
            // é€šçŸ¥APIã‚µãƒãƒ¼ãƒˆ
            if ('Notification' in window) {
                log(elementId, 'âœ… Notification API ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™', 'success');
                log(elementId, `ğŸ“± é€šçŸ¥è¨±å¯çŠ¶æ…‹: ${Notification.permission}`, 'info');
            } else {
                log(elementId, 'âŒ Notification API ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
            }

            // Service Workerã‚µãƒãƒ¼ãƒˆ
            if ('serviceWorker' in navigator) {
                log(elementId, 'âœ… Service Worker ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™', 'success');
            } else {
                log(elementId, 'âŒ Service Worker ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
            }

            // Push Managerã‚µãƒãƒ¼ãƒˆ
            if ('PushManager' in window) {
                log(elementId, 'âœ… PushManager ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™', 'success');
            } else {
                log(elementId, 'âŒ PushManager ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
            }

            // ã‚»ã‚­ãƒ¥ã‚¢ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
            if (window.isSecureContext) {
                log(elementId, 'âœ… ã‚»ã‚­ãƒ¥ã‚¢ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆHTTPSï¼‰ã§ã™', 'success');
            } else {
                log(elementId, 'âŒ ã‚»ã‚­ãƒ¥ã‚¢ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆHTTPï¼‰', 'error');
            }

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
            log(elementId, `ğŸ“± ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: ${navigator.userAgent}`, 'info');
            
            // iOS/Android ã®ç‰¹åˆ¥ãªå‡¦ç†
            const isIOS = navigator.userAgent.includes('iPhone') || navigator.userAgent.includes('iPad');
            const isAndroid = navigator.userAgent.includes('Android');
            
            if (isIOS) {
                log(elementId, 'ğŸ iOS ãƒ‡ãƒã‚¤ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ', 'info');
                log(elementId, 'âš ï¸ iOS Safari ã§ã¯ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã«åˆ¶é™ãŒã‚ã‚Šã¾ã™', 'warning');
                log(elementId, 'ğŸ’¡ PWAã¨ã—ã¦ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã™ã‚‹ã¨é€šçŸ¥ãŒå¯èƒ½ã§ã™', 'info');
                log(elementId, 'ğŸ’¡ ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯é€šçŸ¥ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™', 'warning');
            } else if (isAndroid) {
                log(elementId, 'ğŸ¤– Android ãƒ‡ãƒã‚¤ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ', 'info');
                log(elementId, 'ğŸ’¡ Android ã§ã¯Chrome/Firefoxã§é€šçŸ¥ãŒå¯èƒ½ã§ã™', 'info');
            }
        }

        function checkNotificationPermission() {
            const elementId = 'notificationPermission';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ” é€šçŸ¥è¨±å¯çŠ¶æ³ã‚’ç¢ºèªä¸­...');
            
            if ('Notification' in window) {
                const permission = Notification.permission;
                log(elementId, `ğŸ“± ç¾åœ¨ã®è¨±å¯çŠ¶æ…‹: ${permission}`, 'info');
                
                switch(permission) {
                    case 'granted':
                        log(elementId, 'âœ… é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™', 'success');
                        break;
                    case 'denied':
                        log(elementId, 'âŒ é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™', 'error');
                        log(elementId, 'ğŸ’¡ ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„', 'warning');
                        break;
                    case 'default':
                        log(elementId, 'âš ï¸ é€šçŸ¥è¨±å¯ãŒã¾ã ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                        break;
                }
            } else {
                log(elementId, 'âŒ Notification API ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
            }
        }

        async function requestNotificationPermission() {
            const elementId = 'notificationPermission';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ”” é€šçŸ¥è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¸­...');
            
            if ('Notification' in window) {
                try {
                    const permission = await Notification.requestPermission();
                    log(elementId, `ğŸ“± è¨±å¯çµæœ: ${permission}`, permission === 'granted' ? 'success' : 'error');
                    
                    if (permission === 'granted') {
                        log(elementId, 'âœ… é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸï¼', 'success');
                        // ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡
                        showTestNotification('é€šçŸ¥è¨±å¯ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'ã“ã‚Œã§ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãŒå±Šãã¯ãšã§ã™ã€‚');
                    } else {
                        log(elementId, 'âŒ é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ', 'error');
                    }
                } catch (error) {
                    log(elementId, `âŒ é€šçŸ¥è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            } else {
                log(elementId, 'âŒ Notification API ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
            }
        }

        function showTestNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    const notification = new Notification(title, {
                        body: body,
                        icon: '/OEM/icon-192.svg',
                        badge: '/OEM/icon-192.svg',
                        tag: 'test-notification',
                        requireInteraction: true
                    });
                    
                    notification.onclick = function() {
                        console.log('é€šçŸ¥ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                        notification.close();
                    };
                    
                    return notification;
                } catch (error) {
                    console.error('é€šçŸ¥ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                    return null;
                }
            }
            return null;
        }

        async function checkServiceWorker() {
            const elementId = 'serviceWorker';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ” Service Workerã‚’ç¢ºèªä¸­...');
            
            if (!('serviceWorker' in navigator)) {
                log(elementId, 'âŒ Service Worker ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                // ã¾ãšæ—¢å­˜ã®Service Workerã‚’ç¢ºèª
                const existingRegistrations = await navigator.serviceWorker.getRegistrations();
                log(elementId, `ğŸ“Š æ—¢å­˜ã®Service Workeræ•°: ${existingRegistrations.length}`, 'info');
                
                if (existingRegistrations.length === 0) {
                    log(elementId, 'âš ï¸ Service Worker ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                    log(elementId, 'ğŸ”„ Service Worker ã‚’ç™»éŒ²ä¸­...', 'info');
                    
                    try {
                        const registration = await navigator.serviceWorker.register('/OEM/sw.js', {
                            scope: '/OEM/'
                        });
                        log(elementId, 'âœ… Service Worker ã‚’ç™»éŒ²ã—ã¾ã—ãŸ', 'success');
                        log(elementId, `ğŸ“± ã‚¹ã‚³ãƒ¼ãƒ—: ${registration.scope}`, 'info');
                        
                        // ç™»éŒ²å¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰çŠ¶æ…‹ã‚’ç¢ºèª
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                    } catch (registerError) {
                        log(elementId, `âŒ Service Worker ã®ç™»éŒ²ã§ã‚¨ãƒ©ãƒ¼: ${registerError.message}`, 'error');
                        return;
                    }
                }
                
                // Service Workerã®çŠ¶æ…‹ã‚’ç¢ºèª
                const registration = await navigator.serviceWorker.ready;
                log(elementId, 'âœ… Service Worker ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™', 'success');
                log(elementId, `ğŸ“± ã‚¹ã‚³ãƒ¼ãƒ—: ${registration.scope}`, 'info');
                
                // å„çŠ¶æ…‹ã‚’è©³ç´°ã«ç¢ºèª
                if (registration.installing) {
                    log(elementId, 'ğŸ”„ Service Worker ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­ã§ã™', 'info');
                    registration.installing.addEventListener('statechange', (e) => {
                        log(elementId, `ğŸ“± ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ…‹: ${e.target.state}`, 'info');
                    });
                }
                
                if (registration.waiting) {
                    log(elementId, 'â³ Service Worker ãŒå¾…æ©Ÿä¸­ã§ã™', 'warning');
                }
                
                if (registration.active) {
                    log(elementId, 'âœ… Service Worker ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã™', 'success');
                    log(elementId, `ğŸ“± ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªService Worker: ${registration.active.scriptURL}`, 'info');
                } else {
                    log(elementId, 'âš ï¸ Service Worker ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'warning');
                }
                
                // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç¢ºèª
                if ('PushManager' in window) {
                    try {
                        const subscription = await registration.pushManager.getSubscription();
                        if (subscription) {
                            log(elementId, 'âœ… ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¾ã™', 'success');
                        } else {
                            log(elementId, 'âš ï¸ ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¾ã›ã‚“', 'warning');
                        }
                    } catch (error) {
                        log(elementId, `âš ï¸ ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ç¢ºèªã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'warning');
                    }
                }
                
                // Service Workerã¨ã®é€šä¿¡ãƒ†ã‚¹ãƒˆ
                if (registration.active) {
                    log(elementId, 'ğŸ“¡ Service Worker ã¨ã®é€šä¿¡ã‚’ãƒ†ã‚¹ãƒˆä¸­...', 'info');
                    
                    const messageChannel = new MessageChannel();
                    messageChannel.port1.onmessage = (event) => {
                        log(elementId, `ğŸ“¨ Service Worker ã‹ã‚‰ã®å¿œç­”: ${event.data}`, 'success');
                    };
                    
                    registration.active.postMessage({
                        type: 'PING',
                        message: 'Service Worker ã®é€šä¿¡ãƒ†ã‚¹ãƒˆ'
                    }, [messageChannel.port2]);
                    
                    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
                    setTimeout(() => {
                        log(elementId, 'â° Service Worker ã®å¿œç­”ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'warning');
                    }, 3000);
                }
                
            } catch (error) {
                log(elementId, `âŒ Service Worker ã®ç¢ºèªã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(elementId, `ğŸ“ ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.stack}`, 'error');
            }
        }

        function sendTestNotification() {
            const elementId = 'testNotification';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ§ª ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ä¸­...');
            
            // è©³ç´°ãªè¨ºæ–­æƒ…å ±ã‚’è¡¨ç¤º
            log(elementId, `ğŸ“± ç¾åœ¨ã®é€šçŸ¥è¨±å¯çŠ¶æ…‹: ${Notification.permission}`, 'info');
            log(elementId, `ğŸ“± ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆ: ${'Notification' in window ? 'ã‚ã‚Š' : 'ãªã—'}`, 'info');
            log(elementId, `ğŸ“± ã‚»ã‚­ãƒ¥ã‚¢ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ: ${window.isSecureContext ? 'ã‚ã‚Š' : 'ãªã—'}`, 'info');
            log(elementId, `ğŸ“± ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: ${navigator.userAgent.includes('iPhone') ? 'iPhone' : navigator.userAgent.includes('Android') ? 'Android' : 'PC'}`, 'info');
            
            if (!('Notification' in window)) {
                log(elementId, 'âŒ Notification API ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                log(elementId, 'ğŸ’¡ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯é€šçŸ¥ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                return;
            }
            
            if (Notification.permission !== 'granted') {
                log(elementId, 'âŒ é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                log(elementId, 'ğŸ’¡ é€šçŸ¥è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ãã ã•ã„', 'info');
                return;
            }
            
            const notification = showTestNotification(
                'MARUGO OEM Special Menu',
                'ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆé€šçŸ¥ã§ã™ã€‚ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚'
            );
            
            if (notification) {
                log(elementId, 'âœ… ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
                log(elementId, 'ğŸ“± é€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™', 'info');
                
                // é€šçŸ¥ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                notification.onclick = () => {
                    log(elementId, 'ğŸ“± é€šçŸ¥ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ', 'info');
                    window.focus();
                };
                
                notification.onerror = (error) => {
                    log(elementId, `âŒ é€šçŸ¥ã‚¨ãƒ©ãƒ¼: ${error}`, 'error');
                };
                
                // 5ç§’å¾Œã«é€šçŸ¥ã®çŠ¶æ…‹ã‚’ç¢ºèª
                setTimeout(() => {
                    log(elementId, 'ğŸ“± é€šçŸ¥ã®çŠ¶æ…‹ç¢ºèªå®Œäº†', 'info');
                }, 5000);
            } else {
                log(elementId, 'âŒ ãƒ†ã‚¹ãƒˆé€šçŸ¥ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }

        async function sendTestNotificationWithServiceWorker() {
            const elementId = 'testNotification';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ§ª Service WorkerçµŒç”±ã§ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ä¸­...');
            
            try {
                const registration = await navigator.serviceWorker.ready;
                
                if (registration.active) {
                    // Service Workerã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
                    registration.active.postMessage({
                        type: 'SHOW_NOTIFICATION',
                        notificationData: {
                            title: 'MARUGO OEM Special Menu',
                            message: 'Service WorkerçµŒç”±ã®ãƒ†ã‚¹ãƒˆé€šçŸ¥ã§ã™',
                            icon: '/OEM/icon-192.svg',
                            badge: '/OEM/icon-192.svg',
                            tag: 'sw-test-notification',
                            url: '/OEM/',
                            notification_id: 'test-' + Date.now()
                        }
                    });
                    
                    log(elementId, 'âœ… Service Workerã«é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
                } else {
                    log(elementId, 'âŒ Service Worker ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'error');
                }
            } catch (error) {
                log(elementId, `âŒ Service WorkerçµŒç”±ã®é€šçŸ¥é€ä¿¡ã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function checkSupabaseConnection() {
            const elementId = 'supabaseConnection';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ” Supabaseæ¥ç¶šã‚’ç¢ºèªä¸­...');
            
            try {
                // åŸºæœ¬çš„ãªæ¥ç¶šãƒ†ã‚¹ãƒˆ
                const { data, error } = await supabase
                    .from('notifications')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    log(elementId, `âŒ Supabaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                } else {
                    log(elementId, 'âœ… Supabaseæ¥ç¶šãŒæ­£å¸¸ã§ã™', 'success');
                }
                
                // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
                log(elementId, 'ğŸ“¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆä¸­...');
                
                const channel = supabase
                    .channel('debug-notifications')
                    .on('postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'notifications' },
                        (payload) => {
                            log(elementId, `ğŸ”” ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ã‚’å—ä¿¡: ${JSON.stringify(payload)}`, 'success');
                        }
                    )
                    .subscribe((status) => {
                        log(elementId, `ğŸ“Š ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çŠ¶æ…‹: ${status}`, 'info');
                    });
                
                // 5ç§’å¾Œã«ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                setTimeout(() => {
                    channel.unsubscribe();
                    log(elementId, 'ğŸ§¹ ãƒ†ã‚¹ãƒˆç”¨ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ', 'info');
                }, 5000);
                
            } catch (error) {
                log(elementId, `âŒ Supabaseæ¥ç¶šç¢ºèªã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function testRealtimeSubscription() {
            const elementId = 'supabaseConnection';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ“¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒ†ã‚¹ãƒˆä¸­...');
            
            try {
                // ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’æŒ¿å…¥
                const { data, error } = await supabase
                    .from('notifications')
                    .insert([{
                        message: 'ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ†ã‚¹ãƒˆé€šçŸ¥',
                        type: 'debug',
                        created_by: null
                    }])
                    .select();
                
                if (error) {
                    log(elementId, `âŒ ãƒ†ã‚¹ãƒˆé€šçŸ¥ã®æŒ¿å…¥ã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                } else {
                    log(elementId, 'âœ… ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’æŒ¿å…¥ã—ã¾ã—ãŸ', 'success');
                    log(elementId, `ğŸ“ æŒ¿å…¥ã•ã‚ŒãŸé€šçŸ¥: ${JSON.stringify(data)}`, 'info');
                }
                
            } catch (error) {
                log(elementId, `âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function debugNotificationFlow() {
            const elementId = 'notificationFlow';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ” é€šçŸ¥ã®æµã‚Œã‚’ãƒ‡ãƒãƒƒã‚°ä¸­...');
            
            // 1. ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆç¢ºèª
            log(elementId, '1ï¸âƒ£ ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆç¢ºèª');
            if (!('Notification' in window)) {
                log(elementId, 'âŒ Notification API ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            if (!('serviceWorker' in navigator)) {
                log(elementId, 'âŒ Service Worker ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            log(elementId, 'âœ… ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆOK', 'success');
            
            // 2. é€šçŸ¥è¨±å¯ç¢ºèª
            log(elementId, '2ï¸âƒ£ é€šçŸ¥è¨±å¯ç¢ºèª');
            if (Notification.permission !== 'granted') {
                log(elementId, `âŒ é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“: ${Notification.permission}`, 'error');
                return;
            }
            log(elementId, 'âœ… é€šçŸ¥è¨±å¯OK', 'success');
            
            // 3. Service Workerç¢ºèª
            log(elementId, '3ï¸âƒ£ Service Workerç¢ºèª');
            try {
                const registration = await navigator.serviceWorker.ready;
                if (!registration.active) {
                    log(elementId, 'âŒ Service Worker ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'error');
                    return;
                }
                log(elementId, 'âœ… Service Worker OK', 'success');
            } catch (error) {
                log(elementId, `âŒ Service Worker ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return;
            }
            
            // 4. Supabaseæ¥ç¶šç¢ºèª
            log(elementId, '4ï¸âƒ£ Supabaseæ¥ç¶šç¢ºèª');
            try {
                const { data, error } = await supabase
                    .from('notifications')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    log(elementId, `âŒ Supabaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    return;
                }
                log(elementId, 'âœ… Supabaseæ¥ç¶šOK', 'success');
            } catch (error) {
                log(elementId, `âŒ Supabaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return;
            }
            
            // 5. ç·åˆåˆ¤å®š
            log(elementId, 'ğŸ¯ ç·åˆåˆ¤å®š');
            log(elementId, 'âœ… ã™ã¹ã¦ã®æ¡ä»¶ãŒæº€ãŸã•ã‚Œã¦ã„ã¾ã™', 'success');
            log(elementId, 'ğŸ’¡ ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãŒå±Šã‹ãªã„å ´åˆã¯ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„:', 'info');
            log(elementId, '   - ã‚¢ãƒ—ãƒªãŒãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ã„ã‚‹ã‹', 'info');
            log(elementId, '   - ãƒ–ãƒ©ã‚¦ã‚¶ã®é€šçŸ¥è¨­å®š', 'info');
            log(elementId, '   - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶š', 'info');
            log(elementId, '   - Service Workerã®çŠ¶æ…‹', 'info');
        }

        async function resetServiceWorker() {
            const elementId = 'serviceWorker';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ”„ Service Worker ã‚’ãƒªã‚»ãƒƒãƒˆä¸­...');
            
            try {
                // æ—¢å­˜ã®Service Workerã‚’ã™ã¹ã¦å‰Šé™¤
                const registrations = await navigator.serviceWorker.getRegistrations();
                log(elementId, `ğŸ“Š å‰Šé™¤å¯¾è±¡ã®Service Workeræ•°: ${registrations.length}`, 'info');
                
                for (const registration of registrations) {
                    await registration.unregister();
                    log(elementId, `âœ… Service Worker ã‚’å‰Šé™¤ã—ã¾ã—ãŸ: ${registration.scope}`, 'success');
                }
                
                log(elementId, 'âœ… Service Worker ã®ãƒªã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                log(elementId, 'ğŸ’¡ ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰å†åº¦ç¢ºèªã—ã¦ãã ã•ã„', 'info');
                
                // è‡ªå‹•çš„ã«å†ç™»éŒ²ã‚’è©¦è¡Œ
                log(elementId, 'ğŸ”„ è‡ªå‹•çš„ã«Service Workerã‚’å†ç™»éŒ²ä¸­...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1000));
                await registerServiceWorker();
                
            } catch (error) {
                log(elementId, `âŒ Service Worker ã®ãƒªã‚»ãƒƒãƒˆã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function registerServiceWorker() {
            const elementId = 'serviceWorker';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ”„ Service Worker ã‚’ç™»éŒ²ä¸­...');
            
            if (!('serviceWorker' in navigator)) {
                log(elementId, 'âŒ Service Worker ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            try {
                const registration = await navigator.serviceWorker.register('/OEM/sw.js', {
                    scope: '/OEM/'
                });
                
                log(elementId, 'âœ… Service Worker ã‚’ç™»éŒ²ã—ã¾ã—ãŸ', 'success');
                log(elementId, `ğŸ“± ã‚¹ã‚³ãƒ¼ãƒ—: ${registration.scope}`, 'info');
                
                // ç™»éŒ²å¾Œã®çŠ¶æ…‹ã‚’ç¢ºèª
                registration.addEventListener('updatefound', () => {
                    log(elementId, 'ğŸ”„ Service Worker ã®æ›´æ–°ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ', 'info');
                });
                
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰çŠ¶æ…‹ã‚’ç¢ºèª
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                if (registration.active) {
                    log(elementId, 'âœ… Service Worker ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã™', 'success');
                } else if (registration.installing) {
                    log(elementId, 'ğŸ”„ Service Worker ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­ã§ã™', 'info');
                } else if (registration.waiting) {
                    log(elementId, 'â³ Service Worker ãŒå¾…æ©Ÿä¸­ã§ã™', 'warning');
                }
                
            } catch (error) {
                log(elementId, `âŒ Service Worker ã®ç™»éŒ²ã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(elementId, `ğŸ“ ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.stack}`, 'error');
            }
        }

        async function subscribeToPushNotifications() {
            const elementId = 'serviceWorker';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ”„ ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆä¸­...');
            
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’è¿½åŠ 
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ')), 10000);
            });
            
            try {
                // Service Workerã®ç™»éŒ²ã‚’ç¢ºèª
                const registration = await navigator.serviceWorker.ready;
                log(elementId, 'âœ… Service Worker ãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ', 'success');
                
                // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
                let subscription;
                try {
                    // ã¾ãšVAPIDã‚­ãƒ¼ãªã—ã§è©¦è¡Œ
                    subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true
                    });
                    log(elementId, 'âœ… VAPIDã‚­ãƒ¼ãªã—ã§ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
                } catch (error) {
                    log(elementId, `âš ï¸ VAPIDã‚­ãƒ¼ãªã—ã§ã®ä½œæˆã«å¤±æ•—: ${error.message}`, 'warning');
                    log(elementId, 'ğŸ”„ ä»£æ›¿æ–¹æ³•ã‚’è©¦è¡Œä¸­...', 'info');
                    
                    // ä»£æ›¿æ–¹æ³•: æ—¢å­˜ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
                    subscription = await registration.pushManager.getSubscription();
                    if (subscription) {
                        log(elementId, 'âœ… æ—¢å­˜ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã—ã¾ã—ãŸ', 'success');
                    } else {
                        log(elementId, 'âŒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                        log(elementId, 'ğŸ’¡ VAPIDã‚­ãƒ¼ãŒå¿…è¦ã§ã™', 'warning');
                        log(elementId, 'ğŸ’¡ ç¾åœ¨ã¯Service WorkerçµŒç”±ã®é€šçŸ¥ã®ã¿å¯èƒ½ã§ã™', 'info');
                        return null;
                    }
                }
                
                log(elementId, 'âœ… ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
                log(elementId, `ğŸ“± ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: ${subscription.endpoint}`, 'info');
                
                // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
                const key = subscription.getKey('p256dh');
                const auth = subscription.getKey('auth');
                
                if (key) {
                    log(elementId, `ğŸ”‘ P256DH ã‚­ãƒ¼: ${btoa(String.fromCharCode.apply(null, new Uint8Array(key)))}`, 'info');
                }
                if (auth) {
                    log(elementId, `ğŸ” Auth ã‚­ãƒ¼: ${btoa(String.fromCharCode.apply(null, new Uint8Array(auth)))}`, 'info');
                }
                
                return subscription;
                
            } catch (error) {
                log(elementId, `âŒ ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ä½œæˆã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(elementId, `ğŸ“ ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.stack}`, 'error');
                
                // å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
                if (error.message.includes('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ')) {
                    log(elementId, 'â° 10ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ', 'warning');
                    log(elementId, 'ğŸ’¡ ãƒ–ãƒ©ã‚¦ã‚¶ã®é€šçŸ¥è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'info');
                } else if (error.message.includes('Permission denied')) {
                    log(elementId, 'ğŸ”’ é€šçŸ¥è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™', 'error');
                    log(elementId, 'ğŸ’¡ ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„', 'info');
                } else if (error.message.includes('Not supported')) {
                    log(elementId, 'âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“', 'error');
                    log(elementId, 'ğŸ’¡ Chromeã€Firefoxã€Safari 14+ ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„', 'info');
                }
                
                return null;
            }
        }

        async function sendTestNotificationViaServiceWorker() {
            const elementId = 'testNotification';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ”„ Service WorkerçµŒç”±ã§ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ä¸­...');
            
            try {
                // Service Workerã®ç™»éŒ²ã‚’ç¢ºèª
                const registration = await navigator.serviceWorker.ready;
                log(elementId, 'âœ… Service Worker ãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ', 'success');
                
                // Service Workerã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
                if (registration.active) {
                    registration.active.postMessage({
                        type: 'SHOW_NOTIFICATION',
                        title: 'ãƒ†ã‚¹ãƒˆé€šçŸ¥',
                        options: {
                            body: 'Service WorkerçµŒç”±ã®ãƒ†ã‚¹ãƒˆé€šçŸ¥ã§ã™',
                            icon: '/OEM/icon-192.svg',
                            badge: '/OEM/icon-192.svg',
                            tag: 'test-notification',
                            requireInteraction: true,
                            silent: false
                        }
                    });
                    
                    log(elementId, 'âœ… Service Worker ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
                    log(elementId, 'ğŸ“± é€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™', 'info');
                } else {
                    log(elementId, 'âŒ Service Worker ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'error');
                }
                
            } catch (error) {
                log(elementId, `âŒ ãƒ†ã‚¹ãƒˆé€šçŸ¥ã®é€ä¿¡ã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(elementId, `ğŸ“ ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.stack}`, 'error');
            }
        }

        async function forceActivateServiceWorker() {
            const elementId = 'serviceWorker';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ”„ Service Worker ã‚’å¼·åˆ¶ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ä¸­...');
            
            try {
                // Service Workerã®ç™»éŒ²ã‚’ç¢ºèª
                const registration = await navigator.serviceWorker.ready;
                log(elementId, 'âœ… Service Worker ãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ', 'success');
                
                if (registration.active) {
                    log(elementId, 'âœ… Service Worker ã¯æ—¢ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã™', 'success');
                    return;
                }
                
                // Service Workerã‚’å¼·åˆ¶çš„ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
                if (registration.installing) {
                    log(elementId, 'ğŸ”„ Service Worker ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­ã§ã™...', 'info');
                    await new Promise(resolve => {
                        registration.installing.addEventListener('statechange', () => {
                            if (registration.installing.state === 'activated') {
                                resolve();
                            }
                        });
                    });
                } else if (registration.waiting) {
                    log(elementId, 'ğŸ”„ Service Worker ãŒå¾…æ©Ÿä¸­ã§ã™...', 'info');
                    // å¾…æ©Ÿä¸­ã®Service Workerã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
                    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                // æœ€çµ‚ç¢ºèª
                if (registration.active) {
                    log(elementId, 'âœ… Service Worker ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã‚Šã¾ã—ãŸ', 'success');
                } else {
                    log(elementId, 'âš ï¸ Service Worker ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
                    log(elementId, 'ğŸ’¡ ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰å†åº¦ç¢ºèªã—ã¦ãã ã•ã„', 'info');
                }
                
            } catch (error) {
                log(elementId, `âŒ Service Worker ã®å¼·åˆ¶ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(elementId, `ğŸ“ ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.stack}`, 'error');
            }
        }

        async function checkExistingSubscription() {
            const elementId = 'serviceWorker';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ”„ æ—¢å­˜ã®ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç¢ºèªä¸­...');
            
            try {
                // Service Workerã®ç™»éŒ²ã‚’ç¢ºèª
                const registration = await navigator.serviceWorker.ready;
                log(elementId, 'âœ… Service Worker ãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ', 'success');
                
                // æ—¢å­˜ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
                const subscription = await registration.pushManager.getSubscription();
                
                if (subscription) {
                    log(elementId, 'âœ… æ—¢å­˜ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ', 'success');
                    log(elementId, `ğŸ“± ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: ${subscription.endpoint}`, 'info');
                    
                    // ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æƒ…å ±ã‚’è¡¨ç¤º
                    const key = subscription.getKey('p256dh');
                    const auth = subscription.getKey('auth');
                    
                    if (key) {
                        log(elementId, `ğŸ”‘ P256DH ã‚­ãƒ¼: ${btoa(String.fromCharCode.apply(null, new Uint8Array(key)))}`, 'info');
                    }
                    if (auth) {
                        log(elementId, `ğŸ” Auth ã‚­ãƒ¼: ${btoa(String.fromCharCode.apply(null, new Uint8Array(auth)))}`, 'info');
                    }
                } else {
                    log(elementId, 'âŒ æ—¢å­˜ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                    log(elementId, 'ğŸ’¡ ã€Œãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„', 'info');
                }
                
            } catch (error) {
                log(elementId, `âŒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç¢ºèªã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(elementId, `ğŸ“ ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.stack}`, 'error');
            }
        }

        function showPWAInstallInstructions() {
            const elementId = 'pwaInstallInstructions';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ“± iPhoneã§ã®PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †', 'info');
            log(elementId, '', 'info');
            log(elementId, 'ğŸ iOS Safari ã§ã¯ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã«åˆ¶é™ãŒã‚ã‚Šã¾ã™', 'warning');
            log(elementId, 'ğŸ’¡ PWAã¨ã—ã¦ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã™ã‚‹ã¨é€šçŸ¥ãŒå¯èƒ½ã§ã™', 'info');
            log(elementId, '', 'info');
            log(elementId, 'ğŸ“‹ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †:', 'info');
            log(elementId, '1. Safari ã§ https://marugo-s.github.io/OEM/ ã«ã‚¢ã‚¯ã‚»ã‚¹', 'info');
            log(elementId, '2. ç”»é¢ä¸‹éƒ¨ã®ã€Œå…±æœ‰ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—', 'info');
            log(elementId, '3. ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠ', 'info');
            log(elementId, '4. ã€Œè¿½åŠ ã€ã‚’ã‚¿ãƒƒãƒ—', 'info');
            log(elementId, '5. ãƒ›ãƒ¼ãƒ ç”»é¢ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’èµ·å‹•', 'info');
            log(elementId, '', 'info');
            log(elementId, 'âœ… PWAã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã¯é€šçŸ¥ãŒå¯èƒ½ã§ã™', 'success');
            log(elementId, 'âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã¯é€šçŸ¥ãŒåˆ¶é™ã•ã‚Œã¾ã™', 'warning');
        }

        async function resetNotificationState() {
            const elementId = 'testNotification';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ”„ é€šçŸ¥çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆä¸­...');
            
            try {
                // æ—¢å­˜ã®é€šçŸ¥ã‚’ã™ã¹ã¦é–‰ã˜ã‚‹
                if ('Notification' in window) {
                    log(elementId, 'ğŸ“± æ—¢å­˜ã®é€šçŸ¥ã‚’é–‰ã˜ã¦ã„ã¾ã™...', 'info');
                }
                
                // Service Workerã‚’ãƒªã‚»ãƒƒãƒˆ
                const registrations = await navigator.serviceWorker.getRegistrations();
                log(elementId, `ğŸ“Š æ—¢å­˜ã®Service Workeræ•°: ${registrations.length}`, 'info');
                
                for (const registration of registrations) {
                    await registration.unregister();
                    log(elementId, `âœ… Service Worker ã‚’å‰Šé™¤ã—ã¾ã—ãŸ: ${registration.scope}`, 'success');
                }
                
                // é€šçŸ¥è¨±å¯ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆå¯èƒ½ãªå ´åˆï¼‰
                if ('Notification' in window) {
                    log(elementId, `ğŸ“± ç¾åœ¨ã®é€šçŸ¥è¨±å¯çŠ¶æ…‹: ${Notification.permission}`, 'info');
                    if (Notification.permission === 'denied') {
                        log(elementId, 'âš ï¸ é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™', 'warning');
                        log(elementId, 'ğŸ’¡ ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„', 'info');
                    }
                }
                
                log(elementId, 'âœ… é€šçŸ¥çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                log(elementId, 'ğŸ’¡ ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰å†åº¦ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„', 'info');
                
            } catch (error) {
                log(elementId, `âŒ é€šçŸ¥çŠ¶æ…‹ã®ãƒªã‚»ãƒƒãƒˆã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(elementId, `ğŸ“ ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.stack}`, 'error');
            }
        }

        async function sendTestNotificationWithoutVAPID() {
            const elementId = 'testNotification';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ§ª VAPIDã‚­ãƒ¼ãªã—ã§ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ä¸­...');
            log(elementId, 'ğŸ“š å‚è€ƒ: ãƒ­ãƒ¼ã‚«ãƒ«é€šçŸ¥ï¼ˆã‚¢ãƒ—ãƒªã‹ã‚‰ç›´æ¥ç™ºç«ï¼‰', 'info');
            
            try {
                // Service Workerã®ç™»éŒ²ã‚’ç¢ºèª
                const registration = await navigator.serviceWorker.ready;
                log(elementId, 'âœ… Service Worker ãŒæº–å‚™å®Œäº†ã—ã¾ã—ãŸ', 'success');
                
                if (registration.active) {
                    // è¨˜äº‹ã®å®Ÿè£…æ–¹æ³•ã‚’å‚è€ƒã«ã—ãŸé€šçŸ¥ãƒ‡ãƒ¼ã‚¿
                    const notificationData = {
                        type: 'SHOW_NOTIFICATION',
                        title: 'MARUGO OEM Special Menu',
                        options: {
                            body: 'VAPIDã‚­ãƒ¼ãªã—ã®ãƒ­ãƒ¼ã‚«ãƒ«é€šçŸ¥ã§ã™ï¼ˆService WorkerçµŒç”±ï¼‰',
                            icon: '/OEM/icon-192.svg',
                            badge: '/OEM/icon-192.svg',
                            tag: 'test-without-vapid',
                            requireInteraction: true,
                            silent: false,
                            // è¨˜äº‹ã®å®Ÿè£…æ–¹æ³•ã‚’å‚è€ƒã«ã—ãŸè¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                            data: {
                                url: '/OEM/',
                                timestamp: Date.now(),
                                type: 'local-notification'
                            }
                        }
                    };
                    
                    // Service Workerã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
                    registration.active.postMessage(notificationData);
                    
                    log(elementId, 'âœ… Service Worker ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
                    log(elementId, 'ğŸ“± é€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¯ãšã§ã™', 'info');
                    log(elementId, 'ğŸ’¡ ã“ã‚Œã¯ãƒ­ãƒ¼ã‚«ãƒ«é€šçŸ¥ï¼ˆã‚¢ãƒ—ãƒªã‹ã‚‰ç›´æ¥ç™ºç«ï¼‰ã§ã™', 'info');
                    log(elementId, 'ğŸ’¡ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šä¸è¦ã§å‹•ä½œã—ã¾ã™', 'info');
                } else {
                    log(elementId, 'âŒ Service Worker ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã¯ã‚ã‚Šã¾ã›ã‚“', 'error');
                    log(elementId, 'ğŸ’¡ ã€ŒService Workerã‚’å¼·åˆ¶ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„', 'info');
                }
                
            } catch (error) {
                log(elementId, `âŒ VAPIDã‚­ãƒ¼ãªã—ã®ãƒ†ã‚¹ãƒˆé€šçŸ¥ã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(elementId, `ğŸ“ ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.stack}`, 'error');
            }
        }

        function showNotificationTypes() {
            const elementId = 'notificationTypes';
            document.getElementById(elementId).innerHTML = '';
            
            log(elementId, 'ğŸ“š ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®ç¨®é¡ã¨å®Ÿè£…æ–¹æ³•', 'info');
            log(elementId, '', 'info');
            log(elementId, 'ğŸ”” ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã«ã¯å¤§ãã2ç¨®é¡ã‚ã‚Šã¾ã™:', 'info');
            log(elementId, '', 'info');
            log(elementId, '1ï¸âƒ£ ãƒ­ãƒ¼ã‚«ãƒ«é€šçŸ¥ï¼ˆLocal Notificationï¼‰', 'info');
            log(elementId, '   - ã‚¢ãƒ—ãƒªã‹ã‚‰ç›´æ¥ç™ºç«', 'info');
            log(elementId, '   - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šä¸è¦', 'info');
            log(elementId, '   - ä¾‹: ã‚¢ãƒ©ãƒ¼ãƒ ã‚¢ãƒ—ãƒªã€ã‚¿ã‚¤ãƒãƒ¼', 'info');
            log(elementId, '   - å®Ÿè£…: Service WorkerçµŒç”±', 'info');
            log(elementId, '', 'info');
            log(elementId, '2ï¸âƒ£ ãƒªãƒ¢ãƒ¼ãƒˆé€šçŸ¥ï¼ˆRemote Notificationï¼‰', 'info');
            log(elementId, '   - ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é…ä¿¡', 'info');
            log(elementId, '   - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šå¿…è¦', 'info');
            log(elementId, '   - ä¾‹: ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ãƒ‹ãƒ¥ãƒ¼ã‚¹', 'info');
            log(elementId, '   - å®Ÿè£…: Supabase Edge Function send-push + VAPIDã‚­ãƒ¼', 'info');
            log(elementId, '', 'info');
            log(elementId, 'ğŸ¯ ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³:', 'info');
            log(elementId, 'âœ… ãƒ­ãƒ¼ã‚«ãƒ«é€šçŸ¥: Service WorkerçµŒç”±ã§å®Ÿè£…æ¸ˆã¿', 'success');
            log(elementId, 'âœ… ãƒªãƒ¢ãƒ¼ãƒˆé€šçŸ¥: Edge FunctionçµŒç”±ã§é…ä¿¡', 'success');
            log(elementId, '   - ç’°å¢ƒå¤‰æ•°: VAPID_PUBLIC_KEY / VAPID_PRIVATE_KEY / VAPID_SUBJECT', 'info');
            log(elementId, '', 'info');
            log(elementId, 'ğŸ’¡ å‚è€ƒè¨˜äº‹: https://gist.github.com/pine/8b7e58ff7fa259df17351d959c6118f7', 'info');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        window.addEventListener('load', () => {
            checkBrowserSupport();
            checkNotificationPermission();
            checkServiceWorker();
        });
    </script>
</body>
</html>
