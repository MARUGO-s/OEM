<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ¬ã‚·ãƒ”è¡¨ç¤º â€” Recipe Box</title>
  <link rel="icon" type="image/x-icon" href="../favicon.ico">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <!-- HTML to Canvaså¤‰æ› -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- å¤–éƒ¨JavaScriptãƒ•ã‚¡ã‚¤ãƒ« -->
  <script src="../assets/js/utils.js"></script>
  <script src="../assets/js/database.js"></script>
  <script src="../assets/js/translation.js?v=20250116dual"></script>
  <script src="../assets/js/pdf-generator.js?v=20250917cors-fix"></script>
  <script src="../assets/js/pdf-generator-v2.js?v=20250917debug-flow"></script>
  <script src="../assets/js/ui-components.js"></script>
  <script src="../assets/js/recipe-view.js"></script>

  <link rel="stylesheet" href="../assets/css/style.css?v=20250116ai">
  <link rel="stylesheet" href="../assets/css/components.css?v=20250115">
  <style>
    /* ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .translated-title {
      font-size: 0.9em;
      color: #ffffff;
      font-style: italic;
      margin-top: 0.25rem;
      margin-bottom: 0.5rem;
      padding-left: 0.5rem;
      border-left: 3px solid #ddd;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .translated-text {
      font-size: 1em;
    }
    
    .original-text {
      font-size: 0.7em;
      color: #cccccc;
      margin-left: 0.5rem;
    }
    
    /* ç¿»è¨³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæƒ…å ±ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .translation-layout-info {
      margin: 1rem 0;
      padding: 1rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .translation-info-card {
      background: rgba(255, 255, 255, 0.95);
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .translation-info-card h4 {
      color: #333;
      margin: 0 0 1rem 0;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .translation-info-card p {
      margin: 0.5rem 0;
      color: #555;
      font-size: 0.9rem;
    }
    
    .translation-info-card strong {
      color: #333;
      font-weight: 600;
    }
    
    .translated-description {
      margin: 1rem 0;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border-left: 3px solid #4a90e2;
    }
    
    .translated-description .translated-text {
      font-size: 1em;
      color: #ffffff;
      margin-bottom: 0.5rem;
    }
    
    .translated-description .original-text {
      font-size: 0.8em;
      color: #cccccc;
      font-style: italic;
    }
    
    .translated-section {
      margin: 1.5rem 0;
      padding: 1rem 1rem 1rem 1.5rem;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      border-left: 3px solid #4a90e2;
    }
    
    .translated-section ol {
      padding-left: 0;
      margin-left: 0;
    }
    
    .translated-section ol li {
      list-style: none;
      position: relative;
      padding-left: 2rem;
      margin-bottom: 0.8rem;
      line-height: 1.6;
      word-wrap: break-word;
      word-break: break-word;
      overflow-wrap: break-word;
      white-space: normal;
    }
    
    .translated-section ol li::before {
      content: counter(step-counter);
      counter-increment: step-counter;
      position: absolute;
      left: 0;
      top: 0;
      background: #4a90e2;
      color: white;
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    /* AIå‰µä½œãƒ¬ã‚·ãƒ”ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .ai-generated-icon {
      color: #ff6b6b;
      margin-left: 0.5rem;
      font-size: 0.9em;
      opacity: 0.8;
      transition: all 0.2s ease;
    }
    
    .ai-generated-icon:hover {
      opacity: 1;
      transform: scale(1.1);
    }
    
    .translated-section ol {
      counter-reset: step-counter;
    }
    
    .translated-section h4 {
      color: #4a90e2;
      margin-bottom: 1rem;
      font-size: 1.1em;
    }
    
    .original-section {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .original-section h5 {
      color: #cccccc;
      margin-bottom: 0.5rem;
      font-size: 0.9em;
    }
    
    .original-section ol {
      padding-left: 0;
      margin-left: 0;
    }
    
    .original-section ol li {
      list-style: none;
      position: relative;
      padding-left: 2rem;
      margin-bottom: 0.8rem;
      line-height: 1.6;
      word-wrap: break-word;
      word-break: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      color: #cccccc;
    }
    
    .original-section ol li::before {
      content: counter(original-step-counter);
      counter-increment: original-step-counter;
      position: absolute;
      left: 0;
      top: 0;
      background: #666;
      color: white;
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .original-section ol {
      counter-reset: original-step-counter;
    }
    
    /* ç¿»è¨³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
    .translate-popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
    }
    
    .translate-popup-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2a2a2a;
      padding: 2rem;
      border-radius: 12px;
      min-width: 320px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid #444;
    }
    
    .translate-popup-content h3 {
      margin-top: 0;
      margin-bottom: 1.5rem;
      color: #ffffff;
      text-align: center;
      font-size: 1.2em;
    }
    
    .language-buttons {
      margin-bottom: 1.5rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    
    .language-buttons .btn {
      margin: 0;
      padding: 0.75rem 1rem;
      font-size: 0.9em;
      text-align: center;
      border-radius: 8px;
      transition: all 0.2s ease;
    }
    
    .language-buttons .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    /* ç¿»è¨³ä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
    .translate-loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1001;
    }
    
    .translate-loading-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2a2a2a;
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 1px solid #444;
      min-width: 200px;
    }
    
    .loading-icon {
      font-size: 2rem;
      margin-bottom: 1rem;
    }
    
    .loading-text {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: #ffffff;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #444;
      border-top: 4px solid #4a90e2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    /* å›½æ——ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .flag-emoji {
      font-size: 1em;
      margin-left: 0.25rem;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¹…èª¿æ•´ */
    .table {
      width: 100%;
      max-width: 100%;
      table-layout: fixed;
      word-wrap: break-word;
      border-collapse: collapse;
      border-spacing: 0;
    }
    
    .table th,
    .table td {
      padding: 4px 8px;
      text-align: left;
      vertical-align: top;
      word-break: break-word;
      line-height: 1.5;
      border-bottom: 1px solid rgba(204, 204, 204, 0.5);
    }
    
    .table th:nth-child(1),
    .table td:nth-child(1) {
      width: 8%;
      text-align: center;
    }
    
    .table th:nth-child(2),
    .table td:nth-child(2) {
      width: 40%;
    }
    
    .table th:nth-child(3),
    .table td:nth-child(3) {
      width: 25%;
      text-align: right;
    }
    
    .table th:nth-child(4),
    .table td:nth-child(4) {
      width: 15%;
      text-align: center;
    }
    
    .table th:nth-child(5),
    .table td:nth-child(5) {
      width: 12%;
      text-align: right;
    }
    
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 768px) {
      .table th,
      .table td {
        padding: 3px 6px;
        font-size: 0.9em;
        line-height: 1.5;
        border-bottom: 1px solid rgba(204, 204, 204, 0.5);
      }
      
      .table th:nth-child(1),
      .table td:nth-child(1) {
        width: 10%;
      }
      
      .table th:nth-child(2),
      .table td:nth-child(2) {
        width: 45%;
      }
      
      .table th:nth-child(3),
      .table td:nth-child(3) {
        width: 25%;
      }
      
      .table th:nth-child(4),
      .table td:nth-child(4) {
        width: 20%;
      }
    }
    /* ===== AIãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆ3ã‚¿ãƒ–çµ±åˆç‰ˆï¼‰ ===== */
    .ai-view-modal-overlay{ 
      position:fixed; 
      inset:0; 
      background:rgba(0,0,0,.45); 
      z-index:1000; 
      display:none; 
      align-items:center; 
      justify-content:center; 
      padding:1rem;
    }
    .ai-view-modal-content{ 
      background:var(--bg-panel,#fff); 
      color:var(--fg,#222); 
      width:clamp(320px,95vw,860px); 
      height:clamp(400px,85vh,800px); 
      max-height:90vh; 
      overflow:hidden; 
      border-radius:12px; 
      box-shadow:0 8px 28px rgba(0,0,0,.35); 
      display:flex; 
      flex-direction:column;
      margin:auto;
    }
    .ai-view-modal-header{ 
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      gap:1rem; 
      padding:.85rem 1rem; 
      border-bottom:1px solid rgba(0,0,0,.08);
      flex-shrink:0;
    }
    .ai-view-modal-title{ 
      font-weight:700; 
      font-size:clamp(1rem,4vw,1.25rem);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .ai-view-modal-close{ 
      background:#f3f4f6; 
      border:1px solid #d1d5db; 
      font-size:1.2rem; 
      line-height:1; 
      cursor:pointer;
      flex-shrink:0;
      padding:0.5rem;
      border-radius:6px;
      color:#374151;
      transition:all 0.2s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      width:32px;
      height:32px;
    }
    
    .ai-view-modal-close:hover{ 
      background:#e5e7eb; 
      border-color:#9ca3af;
      color:#1f2937;
      transform:scale(1.05);
    }
    
    .ai-view-modal-close:active{ 
      transform:scale(0.95);
    }
    
    .ai-view-modal-close:focus{ 
      outline:2px solid #3b82f6;
      outline-offset:2px;
    }
    .ai-view-tabs{ 
      display:flex; 
      gap:.25rem; 
      padding:.5rem; 
      border-bottom:1px solid rgba(0,0,0,.06); 
      background:var(--bg-muted,#f7f7f7);
      flex-shrink:0;
      overflow-x:auto;
      scrollbar-width:none;
      -ms-overflow-style:none;
    }
    .ai-view-tabs::-webkit-scrollbar{ display:none; }
    .ai-tab{ 
      padding:.4rem .75rem; 
      border-radius:999px; 
      cursor:pointer; 
      border:1px solid transparent;
      white-space:nowrap;
      flex-shrink:0;
      font-size:clamp(0.8rem,3vw,0.9rem);
    }
    .ai-tab[aria-selected="true"]{ background:#e8f0fe; border-color:#b6cef7; }
    .ai-chat-container{ 
      flex:1; 
      overflow:auto; 
      padding:1rem; 
      display:none;
      min-height:0;
      max-width:100%;
      box-sizing:border-box;
      word-wrap:break-word;
      word-break:break-word;
      overflow-wrap:break-word;
      overflow-x:auto;
      overflow-y:auto;
      white-space:normal;
      text-overflow:unset;
      hyphens:auto;
      -webkit-hyphens:auto;
      -moz-hyphens:auto;
      -ms-hyphens:auto;
      max-height:calc(100% - 120px);
    }
    
    /* AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå†…ã®ã™ã¹ã¦ã®è¦ç´ ã«å¯¾ã—ã¦æ ¹æœ¬çš„ãªæŠ˜ã‚Šè¿”ã—è¨­å®š */
    .ai-chat-container * {
      overflow: visible !important;
      text-overflow: unset !important;
      white-space: normal !important;
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
    }
    .ai-chat-container.active{ display:block; }
    .ai-input-row{ 
      display:flex; 
      gap:.5rem; 
      padding:.75rem 1rem; 
      border-top:1px solid rgba(0,0,0,.08);
      flex-shrink:0;
      flex-wrap:wrap;
    }
    .ai-input-row textarea{ 
      flex:1; 
      resize:vertical; 
      min-height:42px;
      min-width:200px;
    }
    .ai-btn{ 
      padding:.5rem .85rem; 
      border:1px solid #d0d7de; 
      border-radius:8px; 
      background:#fff; 
      cursor:pointer;
      white-space:nowrap;
      flex-shrink:0;
    }
    .ai-btn.primary{ background:#2563eb; color:#fff; border-color:#2563eb; }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 768px) {
      .ai-view-modal-overlay{ 
        padding:0.5rem;
        align-items:flex-start;
        padding-top:2rem;
      }
      .ai-view-modal-content{ 
        width:100%;
        height:clamp(350px,90vh,750px);
        max-height:95vh;
        border-radius:8px;
      }
      .ai-view-modal-header{ 
        padding:.75rem 1rem;
      }
      .ai-view-modal-title{ 
        font-size:1rem;
      }
      .ai-view-modal-close{ 
        width:28px;
        height:28px;
        font-size:1rem;
        padding:0.4rem;
      }
      .ai-view-tabs{ 
        padding:.4rem;
        gap:.2rem;
      }
      .ai-tab{ 
        padding:.3rem .6rem;
        font-size:0.8rem;
      }
      
      /* æ‰‹é †ãƒªã‚¹ãƒˆã®ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
      .ai-msg ol li {
        margin: 0.4rem 0 !important;
        padding: 0.3rem 0 !important;
        line-height: 1.6 !important;
        font-size: 0.9em !important;
      }
      
      .ai-msg ol {
        padding-left: 1.2rem !important;
        margin: 0.6rem 0 !important;
      }
      .ai-chat-container{ 
        padding:.75rem;
        max-height:calc(100% - 100px);
      }
      .ai-input-row{ 
        padding:.5rem .75rem;
        gap:.4rem;
      }
      .ai-input-row textarea{ 
        min-width:150px;
        min-height:36px;
      }
      .ai-btn{ 
        padding:.4rem .7rem;
        font-size:0.85rem;
      }
    }
    
    @media (max-width: 480px) {
      .ai-view-modal-overlay{ 
        padding:0.25rem;
        padding-top:1rem;
      }
      .ai-view-modal-content{ 
        height:clamp(300px,95vh,700px);
        max-height:98vh;
        border-radius:6px;
      }
      .ai-view-modal-header{ 
        padding:.6rem .8rem;
      }
      .ai-view-modal-title{ 
        font-size:0.9rem;
      }
      .ai-view-modal-close{ 
        width:26px;
        height:26px;
        font-size:0.9rem;
        padding:0.3rem;
      }
      .ai-view-tabs{ 
        padding:.3rem;
        gap:.15rem;
      }
      .ai-tab{ 
        padding:.25rem .5rem;
        font-size:0.75rem;
      }
      .ai-chat-container{ 
        padding:.5rem;
        max-height:calc(100% - 90px);
      }
      .ai-input-row{ 
        padding:.4rem .6rem;
        gap:.3rem;
        flex-direction:column;
      }
      .ai-input-row textarea{ 
        min-width:100%;
        min-height:32px;
      }
      .ai-btn{ 
        padding:.35rem .6rem;
        font-size:0.8rem;
        width:100%;
      }
      
      /* æ‰‹é †ãƒªã‚¹ãƒˆã®ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³å¯¾å¿œ */
      .ai-msg ol li {
        margin: 0.3rem 0 !important;
        padding: 0.2rem 0 !important;
        line-height: 1.5 !important;
        font-size: 0.85em !important;
      }
      
      .ai-msg ol {
        padding-left: 1rem !important;
        margin: 0.5rem 0 !important;
      }
      
      .ai-msg{ 
        padding:.75rem 1rem;
        font-size:0.9em;
        margin:.6rem 0;
      }
      
      .ai-msg h1, .ai-msg h2, .ai-msg h3, .ai-msg h4 {
        font-size:1.1em;
        margin:1rem 0 0.6rem 0;
      }
      
      .ai-msg ul, .ai-msg ol {
        padding-left:1.2rem;
      }
      
      .ai-msg pre {
        padding:.75rem;
        font-size:0.85em;
      }
      
      .ai-msg .improvement-section {
        padding:.75rem;
      }
    }
    
    .ai-msg{ 
      margin:.8rem 0; 
      padding:1rem 1.2rem; 
      border-radius:12px; 
      border:1px solid #e5e7eb; 
      background:#fafafa; 
      line-height:1.7; 
      font-size: 0.95em;
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      hyphens: auto !important;
      -webkit-hyphens: auto !important;
      -moz-hyphens: auto !important;
      -ms-hyphens: auto !important;
      max-width: 100% !important;
      width: 100% !important;
      box-sizing: border-box !important;
      overflow: visible !important;
      white-space: normal !important;
      text-overflow: unset !important;
    }
    .ai-msg.user{ 
      background:#eef5ff; 
      border-color:#cfe2ff; 
    }
    
    /* ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³é¢¨ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
    .ai-msg h1, .ai-msg h2, .ai-msg h3, .ai-msg h4 {
      margin: 1.5rem 0 0.8rem 0;
      color: #1a1a1a;
      font-weight: 600;
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      white-space: normal !important;
    }
    
    .ai-msg h1 { 
      font-size: 1.4em; 
      border-bottom: 2px solid #e5e7eb; 
      padding-bottom: 0.5rem; 
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      white-space: normal !important;
    }
    .ai-msg h2 { 
      font-size: 1.3em; 
      border-bottom: 1px solid #e5e7eb; 
      padding-bottom: 0.3rem; 
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      white-space: normal !important;
    }
    
    /* ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— ===== */
    .status-popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .status-popup-content {
      background: var(--bg-primary);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 8px 28px rgba(0, 0, 0, 0.35);
      display: flex;
      align-items: center;
      gap: 1rem;
      min-width: 300px;
      max-width: 500px;
      border: 1px solid var(--border-medium);
    }
    
    .status-icon {
      flex-shrink: 0;
    }
    
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .status-text {
      flex: 1;
    }
    
    .status-title {
      font-weight: 600;
      font-size: 1.1em;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }
    
    .status-message {
      color: var(--text-muted);
      font-size: 0.9em;
    }
    
    .status-popup.success .spinner {
      border: 3px solid #d1fae5;
      border-top: 3px solid #10b981;
    }
    
    .status-popup.error .spinner {
      border: 3px solid #fee2e2;
      border-top: 3px solid #ef4444;
    }
    
    .status-popup.success .status-title {
      color: #10b981;
    }
    
    .status-popup.error .status-title {
      color: #ef4444;
    }
    .ai-msg h3 { font-size: 1.2em; color: #2563eb; }
    .ai-msg h4 { font-size: 1.1em; color: #374151; }
    
    .ai-msg p {
      margin: 0.8rem 0;
      line-height: 1.7;
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      white-space: normal !important;
    }
    
    .ai-msg ul, .ai-msg ol {
      margin: 0.8rem 0;
      padding-left: 1.5rem;
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      white-space: normal !important;
      overflow: visible !important;
    }
    
    .ai-msg li {
      margin: 0.4rem 0;
      line-height: 1.6;
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      white-space: normal !important;
      padding: 0.2rem 0;
      overflow: visible !important;
    }
    
    /* æ‰‹é †ãƒªã‚¹ãƒˆã®ç‰¹åˆ¥ãªã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
    .ai-msg ol li {
      margin: 0.6rem 0 !important;
      padding: 0.4rem 0 !important;
      line-height: 1.7 !important;
      overflow: visible !important;
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      white-space: normal !important;
      display: block !important;
      width: 100% !important;
      box-sizing: border-box !important;
      text-overflow: unset !important;
      hyphens: auto !important;
      -webkit-hyphens: auto !important;
      -moz-hyphens: auto !important;
      -ms-hyphens: auto !important;
      list-style-position: outside !important;
      list-style-type: decimal !important;
      position: relative !important;
    }
    
    /* æ‰‹é †ãƒªã‚¹ãƒˆã®ç•ªå·éƒ¨åˆ†ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
    .ai-msg ol li::marker {
      content: counter(list-item) ". " !important;
      font-weight: bold !important;
      color: #374151 !important;
    }
    
    /* æ‰‹é †ãƒªã‚¹ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆéƒ¨åˆ†ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
    .ai-msg ol li > * {
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      white-space: normal !important;
      text-overflow: unset !important;
      hyphens: auto !important;
      -webkit-hyphens: auto !important;
      -moz-hyphens: auto !important;
      -ms-hyphens: auto !important;
    }
    
    /* æ‰‹é †ãƒªã‚¹ãƒˆå…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
    .ai-msg ol {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
      overflow: visible !important;
      margin: 0.8rem 0 !important;
      padding-left: 1.5rem !important;
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      white-space: normal !important;
      text-overflow: unset !important;
    }
    
    /* AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå†…ã®ã™ã¹ã¦ã®è¦ç´ ã«å¯¾ã—ã¦æŠ˜ã‚Šè¿”ã—ã‚’å¼·åˆ¶é©ç”¨ */
    .ai-msg * {
      overflow: visible !important;
      text-overflow: unset !important;
      white-space: normal !important;
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
    }
    
    /* ãŸã ã—ã€ãƒœã‚¿ãƒ³ã‚„ç‰¹å®šã®è¦ç´ ã¯é™¤å¤– */
    .ai-msg .btn,
    .ai-msg button,
    .ai-msg input,
    .ai-msg select,
    .ai-msg textarea {
      overflow: visible !important;
      text-overflow: unset !important;
      white-space: normal !important;
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
    }
    
    .ai-msg strong {
      color: #1a1a1a;
      font-weight: 600;
    }
    
    .ai-msg em {
      color: #6b7280;
      font-style: italic;
    }
    
    .ai-msg blockquote {
      margin: 1rem 0;
      padding: 0.8rem 1rem;
      background: #f8f9fa;
      border-left: 4px solid #2563eb;
      border-radius: 0 6px 6px 0;
    }
    
    .ai-msg code {
      background: #f1f5f9;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.9em;
      color: #dc2626;
      word-wrap: break-word !important;
      word-break: break-all !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      white-space: normal !important;
    }
    
    .ai-msg pre {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 8px;
      overflow-x: auto;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      margin: 1rem 0;
      max-width: 100% !important;
      width: 100% !important;
      box-sizing: border-box !important;
      white-space: pre-wrap !important;
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
    }
    
    .ai-msg pre code {
      background: none;
      padding: 0;
      color: #374151;
    }
    
    /* æ”¹å–„ææ¡ˆã®ç‰¹åˆ¥ãªã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚° */
    .ai-msg .improvement-section {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      width: 100% !important;
      box-sizing: border-box !important;
      white-space: normal !important;
    }
    
    .ai-msg .improvement-title {
      color: #0369a1;
      font-weight: 600;
      font-size: 1.1em;
      margin-bottom: 0.8rem;
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      white-space: normal !important;
    }
    
    .ai-msg .rationale, .ai-msg .implementation, .ai-msg .risk {
      margin: 0.8rem 0;
      padding: 0.6rem 0.8rem;
      border-radius: 6px;
      word-wrap: break-word !important;
      word-break: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      width: 100% !important;
      box-sizing: border-box !important;
      white-space: normal !important;
    }
    
    .ai-msg .rationale {
      background: #fef3c7;
      border-left: 3px solid #f59e0b;
    }
    
    .ai-msg .implementation {
      background: #dbeafe;
      border-left: 3px solid #3b82f6;
    }
    
    .ai-msg .risk {
      background: #fee2e2;
      border-left: 3px solid #ef4444;
    }
    
    .ai-msg .rationale::before {
      content: "æ ¹æ‹ : ";
      font-weight: 600;
      color: #92400e;
    }
    
    .ai-msg .implementation::before {
      content: "å®Ÿè£…: ";
      font-weight: 600;
      color: #1e40af;
    }
    
    .ai-msg .risk::before {
      content: "ãƒªã‚¹ã‚¯: ";
      font-weight: 600;
      color: #991b1b;
    }
    .loading{ width:24px; height:24px; border:3px solid rgba(0,0,0,.15); border-top-color:rgba(0,0,0,.45); border-radius:50%; animation:spin 1s linear infinite; margin:.25rem auto; }
    @keyframes spin{ to{ transform:rotate(360deg);} }
    body.modal-open{ overflow:hidden; }
    
    /* ãƒ¬ã‚·ãƒ”åŒ–é€²è¡ŒçŠ¶æ³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    .recipe-progress-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    
    .recipe-progress-content {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      text-align: center;
      min-width: 300px;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .progress-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      animation: bounce 2s infinite;
    }
    
    .progress-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 0.5rem;
    }
    
    .progress-text {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 1.5rem;
      min-height: 1.2rem;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 0.5rem;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #1d4ed8);
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }
    
    .progress-percentage {
      font-size: 0.8rem;
      color: #666;
      font-weight: 500;
    }
    
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    /* æ—¢å­˜ã®è§£æã‚«ãƒ¼ãƒ‰ã®ä½“è£è£œåŠ© */
    .grid{ display:grid; grid-template-columns: 1fr auto; gap:.25rem .75rem; align-items:baseline; }
    .card .num{ text-align:right; }

    /* AIãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¦‹ã‚„ã™ãã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ« */
    .ai-chat-container table {
        width: 100% !important;
        max-width: 100% !important;
        border-collapse: collapse;
        margin-top: 1rem;
        margin-bottom: 1rem;
        font-size: 0.9em;
        line-height: 1.5;
        table-layout: fixed;
        word-wrap: break-word !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
    }
    .ai-chat-container th,
    .ai-chat-container td {
        border: 1px solid #dee2e6; /* var(--line-primary) */
        padding: 0.6rem 0.75rem;
        text-align: left;
        vertical-align: top;
        word-wrap: break-word !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        max-width: 0 !important;
        white-space: normal !important;
    }
    .ai-chat-container th {
        background-color: #f8f9fa; /* Lighter than --bg-muted */
        font-weight: 600;
        word-wrap: break-word !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        white-space: normal !important;
    }
    .ai-chat-container tr:nth-child(even) {
        background-color: #f7f7f7; /* var(--bg-muted) */
    }
  </style>
</head>
<body>

  <header class="app-header">
    <h1 class="brand">ãƒ¬ã‚·ãƒ”è¡¨ç¤º</h1>
    <div class="header-actions" data-actions>
      <button class="btn primary small js-ai-advice">âœ¨ AIã‚¢ãƒ‰ãƒã‚¤ã‚¹</button>
      <button class="btn secondary js-export-pdf">ğŸ“„ PDFå‡ºåŠ›</button>
      <button class="btn secondary js-export-csv">ğŸ“Š CSVå‡ºåŠ›</button>
      <button class="btn secondary js-show-readable-text">ğŸ“ èª­ã¿ã‚„ã™ã„ãƒ†ã‚­ã‚¹ãƒˆ</button>
      <button class="btn js-edit">ç·¨é›†</button>
      <button class="btn ghost js-delete" style="color:#c0392b;border-color:#c0392b;">å‰Šé™¤</button>
      <button class="btn js-back">æˆ»ã‚‹</button>
    </div>
  </header>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div id="statusPopup" class="status-popup" style="display: none;">
    <div class="status-popup-content">
      <div class="status-icon">
        <div class="spinner"></div>
      </div>
      <div class="status-text">
        <div class="status-title">å‡¦ç†ä¸­...</div>
        <div class="status-message">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„</div>
      </div>
    </div>
  </div>

  <!-- èª­ã¿ã‚„ã™ã„ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="readableTextModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
      <div class="modal-header">
        <h2 class="modal-title">èª­ã¿ã‚„ã™ã„ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼</h2>
        <button id="readableTextCloseBtn" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="readableTextContent" style="white-space: pre-wrap; font-family: 'Courier New', monospace; line-height: 1.6; max-height: 60vh; overflow-y: auto; background: #ffffff; color: #2c3e50; padding: 1.5rem; border-radius: 6px; border: 1px solid #e1e8ed; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" contenteditable="true"></div>
      </div>
      <div class="modal-footer">
        <button id="readableTextEditBtn" class="btn secondary">ç·¨é›†</button>
        <button id="readableTextSaveBtn" class="btn primary" style="display: none;">ä¿å­˜</button>
        <button id="readableTextCancelBtn" class="btn ghost" style="display: none;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button id="readableTextCopyBtn" class="btn secondary">ã‚³ãƒ”ãƒ¼</button>
        <button id="readableTextCloseBtn2" class="btn ghost">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <main class="container two-col-layout">
    <article class="panel">
      <div class="fav-block" style="text-align:right;margin-bottom:1rem;">
        <button id="favBtn" class="btn small">â™¡ ãŠæ°—ã«å…¥ã‚Š</button>
        <button id="translateBtn" class="btn small" style="margin-left: 0.5rem;" onclick="showTranslatePopup()">ğŸŒ ç¿»è¨³</button>
      </div>
      <h2 id="recipeTitle">ã‚¿ã‚¤ãƒˆãƒ«</h2>
      <div id="translatedTitle" class="translated-title" style="display: none;"></div>
      <div class="muted" id="meta">ä½œæˆæ—¥ â€” / æ›´æ–°æ—¥ â€”</div>
      
      <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã‚¿ã‚°ã®è¡¨ç¤º -->
      <div id="categoryAndTags" style="margin: 8px 0;">
        <div id="categoryDisplay" style="display: none; margin-bottom: 6px;">
          <span class="category-badge" style="background: #e3f2fd; color: #1976d2; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 500; display: inline-block;">
            <i class="fas fa-folder" style="margin-right: 4px; font-size: 0.8em;"></i>
            <span id="categoryText"></span>
          </span>
        </div>
        <div id="tagsDisplay" style="display: none;">
          <div style="display: flex; flex-wrap: wrap; gap: 4px; align-items: center;">
            <i class="fas fa-tags" style="color: #7b1fa2; font-size: 0.8em; margin-right: 4px;"></i>
            <div id="tagsContainer" style="display: flex; flex-wrap: wrap; gap: 4px;"></div>
          </div>
        </div>
      </div>
      
      <div id="sourceUrlSection" style="margin: 8px 0; display: none;">
        <span class="muted">å‚è€ƒURL: </span>
        <a id="sourceUrlLink" href="#" target="_blank" rel="noopener noreferrer" style="color: #2563eb; text-decoration: none;">
          <i class="fas fa-external-link-alt" style="margin-right: 4px; font-size: 0.85em;"></i>
          <span id="sourceUrlText"></span>
        </a>
      </div>
      <div id="tags" style="margin:8px 0;"></div>
      
      <!-- ãƒ¬ã‚·ãƒ”ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="recipeImageContainer" class="recipe-image-container" style="display: none; margin: 16px 0;">
        <img id="recipeImage" src="" alt="ãƒ¬ã‚·ãƒ”ç”»åƒ" class="recipe-image" />
      </div>
      
      <p id="recipeIntro" class="lead"></p>
      <div id="notes" style="margin-top:16px;white-space:pre-wrap;"></div>
    </article>

    <aside class="panel">
      <h3>ææ–™</h3>
      <div id="ingredients"><div class="muted">æœªç™»éŒ²</div></div>

      <h3 style="margin-top:24px;">æ‰‹é †</h3>
      <ol id="steps"><li class="muted">æœªç™»éŒ²</li></ol>

      <section class="card" id="analysisSection" style="display:none;">
        <h3>ç§‘å­¦ãƒ¡ãƒ¢ï¼ˆãƒ™ãƒ¼ã‚«ãƒ¼ã‚ºï¼…ï¼‰</h3>
        <div class="grid">
          <div>ç²‰åˆè¨ˆ</div><div><span id="flour_g">â€“</span> g (100%)</div>
          <div>åŠ æ°´ç‡</div><div><span id="hydration_bp">â€“</span>%ï¼ˆæ°´åˆ† <span id="water_g">â€“</span> gï¼‰</div>
          <div>æ²¹è„‚</div><div><span id="fat_bp">â€“</span>%ï¼ˆ<span id="fat_g">â€“</span> gï¼‰</div>
          <div>ç³–</div><div><span id="sugar_bp">â€“</span>%ï¼ˆ<span id="sugar_g">â€“</span> gï¼‰</div>
          <div>å¡©</div><div><span id="salt_bp">â€“</span>%ï¼ˆ<span id="salt_g">â€“</span> gï¼‰</div>
          <div>é…µæ¯</div><div><span id="yeast_bp">â€“</span>%ï¼ˆ<span id="yeast_g">â€“</span> gï¼‰</div>
        </div>
        <p id="analysisNotes" class="note"></p>
      </section>


    </aside>
  </main>

  <!-- ç¿»è¨³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div id="translatePopup" class="translate-popup">
    <div class="translate-popup-content">
      <h3>ç¿»è¨³å…ˆè¨€èªã‚’é¸æŠ</h3>
      <div class="language-buttons">
        <button class="btn" onclick="startTranslation('fr')">ğŸ‡«ğŸ‡· ãƒ•ãƒ©ãƒ³ã‚¹èª</button>
        <button class="btn" onclick="startTranslation('it')">ğŸ‡®ğŸ‡¹ ã‚¤ã‚¿ãƒªã‚¢èª</button>
        <button class="btn" onclick="startTranslation('zh')">ğŸ‡¨ğŸ‡³ ä¸­å›½èª</button>
        <button class="btn" onclick="startTranslation('es')">ğŸ‡ªğŸ‡¸ ã‚¹ãƒšã‚¤ãƒ³èª</button>
        <button class="btn" onclick="startTranslation('de')">ğŸ‡©ğŸ‡ª ãƒ‰ã‚¤ãƒ„èª</button>
        <button class="btn" onclick="startTranslation('en')">ğŸ‡ºğŸ‡¸ è‹±èª</button>
      </div>
      <button class="btn ghost" onclick="closeTranslatePopup()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <!-- ç¿»è¨³ä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div id="translateLoading" class="translate-loading">
    <div class="translate-loading-content">
      <div class="loading-icon">ğŸŒ</div>
      <div class="loading-text">ç¿»è¨³ä¸­...</div>
      <div class="loading-spinner"></div>
    </div>
  </div>

  <!-- ãƒ¬ã‚·ãƒ”åŒ–é€²è¡ŒçŠ¶æ³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div id="recipeProgressPopup" class="recipe-progress-popup" style="display: none;">
    <div class="recipe-progress-content">
      <div class="progress-icon">ğŸ³</div>
      <div class="progress-title">ãƒ¬ã‚·ãƒ”åŒ–ä¸­...</div>
      <div class="progress-text" id="progressText">AIãŒãƒ¬ã‚·ãƒ”ã‚’åˆ†æã—ã¦ã„ã¾ã™</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-percentage" id="progressPercentage">0%</div>
    </div>
  </div>

  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>

  <div id="aiModal" class="ai-view-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="aiTitle">
    <div class="ai-view-modal-content" tabindex="-1">
      <header class="ai-view-modal-header">
        <div class="ai-view-modal-title" id="aiTitle">âœ¨ AI ãƒ¬ã‚·ãƒ” ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</div>
        <button class="ai-view-modal-close" id="aiClose" aria-label="é–‰ã˜ã‚‹">âœ•</button>
      </header>
      <nav class="ai-view-tabs" role="tablist">
        <button class="ai-tab" role="tab" aria-selected="true" data-tab="advice">ææ¡ˆ</button>
        <button class="ai-tab" role="tab" aria-selected="false" data-tab="temps">æ¸©åº¦ãƒ»æ™‚é–“</button>
        <button class="ai-tab" role="tab" aria-selected="false" data-tab="hazards">å±å®³è¦å› </button>
        <button class="ai-tab" role="tab" aria-selected="false" data-tab="wine">ãƒšã‚¢ãƒªãƒ³ã‚°ãƒ¯ã‚¤ãƒ³</button>
      </nav>
      <section id="tab-advice" class="ai-chat-container active"></section>
      <section id="tab-temps" class="ai-chat-container"></section>
      <section id="tab-hazards" class="ai-chat-container"></section>
      <section id="tab-wine" class="ai-chat-container"></section>
      <div class="ai-input-row">
        <textarea id="aiInput" placeholder="è³ªå•ã‚„è¦æœ›ã‚’å…¥åŠ›â€¦"></textarea>
        <button class="ai-btn" id="aiSave">ãƒ¬ã‚·ãƒ”åŒ–</button>
        <button class="ai-btn primary" id="aiSend">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Supabase åˆæœŸåŒ–ï¼ˆæ—¢ã« window.sb ãŒã‚ã‚Œã°æµç”¨ï¼‰ =====
    if (window.supabase && !window.sb) {
      window.sb = window.supabase.createClient(
        "https://nnbdzwrndqtsfzobknmj.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0eHlhd2luYmx3Y2Jrb3Zmc3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NzE3MzIsImV4cCI6MjA3MDU0NzczMn0.HMMoDl_LPz8uICruD_tzn75eUpU7rp3RZx_N8CEfO1Q",
        { auth: { storageKey: 'app-main-11-view', autoRefreshToken: true, persistSession: true, detectSessionInUrl: false } }
      );
    }

    // ===== è¦ç´ å‚ç…§ =====
    const btnOpen = document.querySelector('.js-ai-advice');
    const btnBack = document.querySelector('.js-back');
    console.log('AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒœã‚¿ãƒ³è¦ç´ :', btnOpen);
    console.log('æˆ»ã‚‹ãƒœã‚¿ãƒ³è¦ç´ :', btnBack);
    
    // ãƒœã‚¿ãƒ³ã®å­˜åœ¨ç¢ºèª
    if (!btnOpen) {
      console.error('AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    } else {
      console.log('AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:', btnOpen);
    }
    const modal = document.getElementById('aiModal');
    const modalContent = modal.querySelector('.ai-view-modal-content');
    const btnClose = document.getElementById('aiClose');
    const tabs = document.querySelectorAll('.ai-tab');
    const panes = { advice: document.getElementById('tab-advice'), temps: document.getElementById('tab-temps'), hazards: document.getElementById('tab-hazards'), wine: document.getElementById('tab-wine') };
    const input = document.getElementById('aiInput');
    const btnSend = document.getElementById('aiSend');
    const btnSave = document.getElementById('aiSave');
    // å…¥åŠ›ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
    function setAIInputEnabled(enabled){
      try{
        if (input) {
          input.disabled = !enabled;
          input.style.opacity = enabled ? '1' : '0.6';
          input.style.pointerEvents = enabled ? 'auto' : 'none';
        }
        if (btnSend) {
          btnSend.disabled = !enabled;
          btnSend.style.opacity = enabled ? '1' : '0.6';
          btnSend.style.pointerEvents = enabled ? 'auto' : 'none';
        }
      }catch(_){}
    }


    // â–¼â–¼â–¼ã€å¤‰æ›´ç‚¹ 1ã€‘ä¼šè©±å±¥æ­´ã‚’ä¿å­˜ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿½åŠ  â–¼â–¼â–¼
    const chatHistories = { advice: [], temps: [], hazards: [], wine: [] };

    // ===== ã‚¿ãƒ–åˆ‡æ›¿ï¼ˆé…å»¶ç”Ÿæˆå¯¾å¿œï¼‰ =====
    const tabLoaded = { advice:false, temps:false, hazards:false, wine:false };
    tabs.forEach(t=>t.addEventListener('click', async ()=>{
      tabs.forEach(x=>x.setAttribute('aria-selected','false'));
      t.setAttribute('aria-selected','true');
      Object.values(panes).forEach(p=>p.classList.remove('active'));
      panes[t.dataset.tab].classList.add('active');
      if(!tabLoaded[t.dataset.tab]){ await generateTab(t.dataset.tab); tabLoaded[t.dataset.tab]=true; }
    }));

    // ===== é–‹é–‰ï¼ˆEsc/èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯/æˆ»ã‚‹å°ç·šï¼‰ =====
    const openModal = ()=>{ 
      console.log('openModalé–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ');
      modal.style.display='flex'; 
      document.body.classList.add('modal-open'); 
      modalContent.focus({preventScroll:true}); 
    };
    const closeModalLocal = ()=>{ modal.style.display='none'; document.body.classList.remove('modal-open'); };
    btnOpen?.addEventListener('click', async ()=>{
      console.log('AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
      try {
        openModal(); 
        if(!tabLoaded.advice) { 
          console.log('AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚¿ãƒ–ã‚’ç”Ÿæˆä¸­...');
          await generateTab('advice'); 
          tabLoaded.advice=true; 
        }
      } catch (error) {
        console.error('AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¨ãƒ©ãƒ¼:', error);
      }
    });
    btnClose?.addEventListener('click', closeModalLocal);
    modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModalLocal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.style.display==='flex') closeModalLocal(); });
    
    console.log('AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');

    // ===== ç¿»è¨³æ©Ÿèƒ½æ‹¡å¼µ =====
    let enhancedTranslatedData = null;


    // æ—¢å­˜ã®ç¿»è¨³æ©Ÿèƒ½ã«æ–°æ©Ÿèƒ½ã‚’çµ±åˆ
    async function toggleEnhancedLanguageDisplay() {
      // æ—¢å­˜ã®ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      if (currentTranslatedData) {
        // æ—¢å­˜ã®ç¿»è¨³è¡¨ç¤ºã¨å…ƒè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        const ingredientsEl = document.getElementById('ingredients');
        const stepsEl = document.getElementById('steps');
        
        // ç¾åœ¨ç¿»è¨³è¡¨ç¤ºä¸­ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
        const isTranslatedShowing = ingredientsEl.querySelector('.translated-section');
        
        if (isTranslatedShowing) {
          // å…ƒã®è¡¨ç¤ºã«æˆ»ã™ - ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
          location.reload();
        } else {
          // ç¿»è¨³ç‰ˆã‚’å†è¡¨ç¤ºï¼ˆå…ƒã®è¨€èªã‚’æ¤œå‡ºï¼‰
          const detectedLanguage = detectOriginalLanguage();
          await showTranslatedResult(currentTranslatedData, detectedLanguage);
          btnToggleLanguage.textContent = 'ğŸ”„ å…ƒã®è¨€èªã«æˆ»ã™';
        }
      }
    }

    // å…ƒã®è¨€èªã‚’æ¤œå‡ºã™ã‚‹é–¢æ•°
    function detectOriginalLanguage() {
      // ææ–™åã‹ã‚‰è¨€èªã‚’æ¨å®š
      const firstIngredient = currentTranslatedData?.ingredients?.[0]?.item || '';
      if (firstIngredient.match(/[ã‚¹ãƒšã‚¤ãƒ³èªç‰¹æœ‰ã®æ–‡å­—]/)) return 'es';
      if (firstIngredient.match(/[ãƒ•ãƒ©ãƒ³ã‚¹èªç‰¹æœ‰ã®æ–‡å­—]/)) return 'fr';
      if (firstIngredient.match(/[ã‚¤ã‚¿ãƒªã‚¢èªç‰¹æœ‰ã®æ–‡å­—]/)) return 'it';
      if (firstIngredient.match(/[ãƒ‰ã‚¤ãƒ„èªç‰¹æœ‰ã®æ–‡å­—]/)) return 'de';
      if (firstIngredient.match(/[ä¸­å›½èª]/)) return 'zh';
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯è‹±èª
      return 'en';
    }

    async function saveEnhancedTranslation() {
      if (!currentTranslatedData) return;

      try {
        const params = new URLSearchParams(location.search);
        const id = params.get('id');

        // æ—¢å­˜ã®ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã‚’æ–°å½¢å¼ã§ä¿å­˜
        await saveTranslationToDatabase(currentTranslatedData, id);
        
        console.log('ç¿»è¨³ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('ç¿»è¨³ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    }

    async function saveTranslationToDatabase(translatedData, recipeId) {
      // ãƒ¬ã‚·ãƒ”ã®ç¿»è¨³æƒ…å ±ã‚’ä¿å­˜
      const recipeUpdateData = {
        title_translated: translatedData.title,
        is_translated: true,
        translation_date: new Date().toISOString()
      };

      const { error: recipeError } = await sb.from('recipes')
        .update(recipeUpdateData)
        .eq('id', recipeId);

      if (recipeError) throw recipeError;

      // ææ–™ã®ç¿»è¨³ã‚’ä¿å­˜
      if (translatedData.ingredients) {
        for (let i = 0; i < translatedData.ingredients.length; i++) {
          const ing = translatedData.ingredients[i];
          const { error: ingError } = await sb.from('recipe_ingredients')
            .update({
              item_translated: ing.item,
              unit_translated: ing.unit
            })
            .eq('recipe_id', recipeId)
            .eq('position', i + 1);
          
          if (ingError) console.warn('ææ–™ç¿»è¨³ä¿å­˜ã‚¨ãƒ©ãƒ¼:', ingError);
        }
      }

      // æ‰‹é †ã®ç¿»è¨³ã‚’ä¿å­˜
      if (translatedData.steps) {
        for (let i = 0; i < translatedData.steps.length; i++) {
          const step = translatedData.steps[i];
          const { error: stepError } = await sb.from('recipe_steps')
            .update({
              instruction_translated: step
            })
            .eq('recipe_id', recipeId)
            .eq('position', i + 1);
          
          if (stepError) console.warn('æ‰‹é †ç¿»è¨³ä¿å­˜ã‚¨ãƒ©ãƒ¼:', stepError);
        }
      }
    }

    // ===== ä¾¿åˆ©é–¢æ•° =====
    const md = (s)=>{ try{ return marked.parse(s||''); }catch{ return (s||''); } };
    
    // ===== ãƒ¬ã‚·ãƒ”åŒ–é€²è¡ŒçŠ¶æ³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—åˆ¶å¾¡ =====
    function showRecipeProgressPopup() {
      const popup = document.getElementById('recipeProgressPopup');
      if (popup) {
        popup.style.display = 'flex';
        updateRecipeProgress(0, 'AIãŒãƒ¬ã‚·ãƒ”ã‚’åˆ†æã—ã¦ã„ã¾ã™...');
      }
    }
    
    function hideRecipeProgressPopup() {
      const popup = document.getElementById('recipeProgressPopup');
      if (popup) {
        popup.style.display = 'none';
      }
    }
    
    function updateRecipeProgress(percentage, text) {
      const progressFill = document.getElementById('progressFill');
      const progressPercentage = document.getElementById('progressPercentage');
      const progressText = document.getElementById('progressText');
      
      if (progressFill) progressFill.style.width = `${percentage}%`;
      if (progressPercentage) progressPercentage.textContent = `${percentage}%`;
      if (progressText) progressText.textContent = text;
    }
    const pushMsg = (pane, role, text)=>{ 
      const el=document.createElement('div'); 
      el.className=`ai-msg ${role}`; 
      el.innerHTML = role==='assistant'? md(text): (text||''); 
      pane.appendChild(el); 
      
      // AIå¿œç­”ã®å ´åˆã€ç”Ÿæˆã•ã‚ŒãŸHTMLã«æŠ˜ã‚Šè¿”ã—ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¼·åˆ¶é©ç”¨
      if (role === 'assistant') {
        setTimeout(() => {
          // æ‰‹é †ãƒªã‚¹ãƒˆï¼ˆol, liï¼‰ã«æŠ˜ã‚Šè¿”ã—ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¼·åˆ¶é©ç”¨
          const olElements = el.querySelectorAll('ol');
          olElements.forEach(ol => {
            ol.style.overflow = 'visible';
            ol.style.textOverflow = 'unset';
            ol.style.whiteSpace = 'normal';
            ol.style.wordWrap = 'break-word';
            ol.style.wordBreak = 'break-word';
            ol.style.overflowWrap = 'break-word';
            ol.style.maxWidth = '100%';
            ol.style.boxSizing = 'border-box';
            ol.style.margin = '0.8rem 0';
            ol.style.paddingLeft = '1.5rem';
          });
          
          const liElements = el.querySelectorAll('ol li');
          liElements.forEach(li => {
            li.style.overflow = 'visible';
            li.style.textOverflow = 'unset';
            li.style.whiteSpace = 'normal';
            li.style.wordWrap = 'break-word';
            li.style.wordBreak = 'break-word';
            li.style.overflowWrap = 'break-word';
            li.style.maxWidth = '100%';
            li.style.boxSizing = 'border-box';
            li.style.margin = '0.6rem 0';
            li.style.padding = '0.4rem 0';
            li.style.lineHeight = '1.7';
          });
          
          // ãã®ä»–ã®è¦ç´ ã«ã‚‚æŠ˜ã‚Šè¿”ã—ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
          const allElements = el.querySelectorAll('*');
          allElements.forEach(element => {
            element.style.overflow = 'visible';
            element.style.textOverflow = 'unset';
            element.style.whiteSpace = 'normal';
            element.style.wordWrap = 'break-word';
            element.style.wordBreak = 'break-word';
            element.style.overflowWrap = 'break-word';
            element.style.maxWidth = '100%';
            element.style.boxSizing = 'border-box';
          });
        }, 50);
      }
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã®èª¿æ•´ - ã™ã¹ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ä¸€ç•ªä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆã‚¿ã‚°é¸æŠã‚’å¦¨ã’ãªã„ã‚ˆã†ã«ï¼‰
      setTimeout(() => {
        pane.scrollTop = pane.scrollHeight;
      }, 100);
    };
    const spinner = ()=>{ const d=document.createElement('div'); d.className='loading'; return d; };

    // ===== ãƒ¬ã‚·ãƒ”æŠ½å‡º =====
    function scrapeRecipe(){
      const title = document.getElementById('recipeTitle')?.textContent?.trim() || '';
      const ings = Array.from(document.querySelectorAll('#ingredients tbody tr')).map(tr=>{
        const tds = tr.querySelectorAll('td');
        return { item:(tds[0]?.textContent||'').trim(), quantity:(tds[1]?.textContent||'').trim(), unit:(tds[2]?.textContent||'').trim() };
      });
      const steps = Array.from(document.querySelectorAll('#steps li')).map(li=> (li.textContent||'').trim()).filter(Boolean);
      return { title, ings, steps };
    }

    // ===== ã‚¿ãƒ–åˆ¥ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ =====
    function buildPrompts(){
      const { title, ings, steps } = scrapeRecipe();
      const ingText = ings.map(i=>`- ${i.item} ${i.quantity||''} ${i.unit||''}`).join('\n');
      const stepText = steps.map((s,i)=> `${i+1}. ${s}`).join('\n');
      const base = `# ãƒ«ã‚»ãƒƒãƒˆå\n${title||'ç„¡é¡Œã®ãƒ¬ã‚·ãƒ”'}\n\n## ææ–™\n${ingText}\n\n## æ‰‹é †\n${stepText}`;
      const advice = `ã‚ãªãŸã¯ãƒ—ãƒ­å‘ã‘ã®èª¿ç†ç§‘å­¦ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ã§ã™ã€‚${base}

## æ”¹å–„ææ¡ˆï¼ˆè¦ç´„ç‰ˆï¼‰

### ä¸»è¦ãªæ”¹å–„ç‚¹ï¼ˆ5å€‹ï¼‰

å„æ”¹å–„ç‚¹ã‚’ç°¡æ½”ã«è¨˜è¿°ã—ã¦ãã ã•ã„ï¼š

#### 1. [æ”¹å–„é …ç›®å]
- **æ ¹æ‹ :** ç°¡æ½”ãªç§‘å­¦çš„æ ¹æ‹ 
- **å®Ÿè£…:** å…·ä½“çš„ãªæ‰‹é †ï¼ˆ1-2è¡Œï¼‰
- **æ³¨æ„ç‚¹:** é‡è¦ãªãƒªã‚¹ã‚¯ã‚„æ³¨æ„äº‹é …

#### 2. [æ”¹å–„é …ç›®å]
- **æ ¹æ‹ :** ç°¡æ½”ãªç§‘å­¦çš„æ ¹æ‹ 
- **å®Ÿè£…:** å…·ä½“çš„ãªæ‰‹é †ï¼ˆ1-2è¡Œï¼‰
- **æ³¨æ„ç‚¹:** é‡è¦ãªãƒªã‚¹ã‚¯ã‚„æ³¨æ„äº‹é …

#### 3. [æ”¹å–„é …ç›®å]
- **æ ¹æ‹ :** ç°¡æ½”ãªç§‘å­¦çš„æ ¹æ‹ 
- **å®Ÿè£…:** å…·ä½“çš„ãªæ‰‹é †ï¼ˆ1-2è¡Œï¼‰
- **æ³¨æ„ç‚¹:** é‡è¦ãªãƒªã‚¹ã‚¯ã‚„æ³¨æ„äº‹é …

#### 4. [æ”¹å–„é …ç›®å]
- **æ ¹æ‹ :** ç°¡æ½”ãªç§‘å­¦çš„æ ¹æ‹ 
- **å®Ÿè£…:** å…·ä½“çš„ãªæ‰‹é †ï¼ˆ1-2è¡Œï¼‰
- **æ³¨æ„ç‚¹:** é‡è¦ãªãƒªã‚¹ã‚¯ã‚„æ³¨æ„äº‹é …

#### 5. [æ”¹å–„é …ç›®å]
- **æ ¹æ‹ :** ç°¡æ½”ãªç§‘å­¦çš„æ ¹æ‹ 
- **å®Ÿè£…:** å…·ä½“çš„ãªæ‰‹é †ï¼ˆ1-2è¡Œï¼‰
- **æ³¨æ„ç‚¹:** é‡è¦ãªãƒªã‚¹ã‚¯ã‚„æ³¨æ„äº‹é …

### èª¿ç†ç§‘å­¦ã®ãƒã‚¤ãƒ³ãƒˆ

é‡è¦ãªèª¿ç†ç§‘å­¦ã®è¦³ç‚¹ã‚’ç°¡æ½”ã«ç®‡æ¡æ›¸ãã§ï¼š
- ãƒ¡ã‚¤ãƒ©ãƒ¼ãƒ‰åå¿œã€é…µç´ æ´»æ€§ã€ã‚¿ãƒ³ãƒ‘ã‚¯è³ªå¤‰æ€§ãªã©
- ãƒ‘ãƒ³/ç”Ÿåœ°ç³»ã®å ´åˆã¯ãƒ™ãƒ¼ã‚«ãƒ¼ã‚ºï¼…ã®å¦¥å½“æ€§`;
      const temps = `ã‚ãªãŸã¯ãƒ—ãƒ­ã®é£Ÿå“å®‰å…¨ã‚³ãƒ³ã‚µãƒ«ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ãƒ¬ã‚·ãƒ”ã®é‡è¦ç®¡ç†ç‚¹ï¼ˆCCPï¼‰ã«ãŠã‘ã‚‹æ¸©åº¦ã¨æ™‚é–“ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®è¡¨ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚\n\n${base}\n\nâ€” å‡ºåŠ›ä»•æ§˜ â€”\n- å¿…ãšMarkdownã®è¡¨å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n- è¡¨ã«ã¯ã€Œå·¥ç¨‹ã€ã€Œæ¸©åº¦ï¼ˆè¡¨é¢/ä¸­å¿ƒï¼‰ã€ã€Œæ™‚é–“ã€ã€Œå‚™è€ƒï¼ˆé£Ÿå“å®‰å…¨ä¸Šã®æ ¹æ‹ ç­‰ï¼‰ã€ã®åˆ—ã‚’å«ã‚ã¦ãã ã•ã„ã€‚`;
      const hazards = `ä»¥ä¸‹ã®ãƒ¬ã‚·ãƒ”ã«é–¢ã™ã‚‹å±å®³è¦å› ï¼ˆå¾®ç”Ÿç‰©/ã‚¢ãƒ¬ãƒ«ã‚²ãƒ³/åŒ–å­¦ãƒ»ç‰©ç†ï¼‰ã¨CCPå€™è£œã€ç°¡å˜ãªç®¡ç†åŸºæº–æ¡ˆã‚’ç®‡æ¡æ›¸ãã§ã€‚\n\n${base}`;
      const wine = `ã‚ãªãŸã¯ãƒ—ãƒ­ã®ã‚½ãƒ ãƒªã‚¨ã§ã™ã€‚ä»¥ä¸‹ã®ãƒ¬ã‚·ãƒ”ã«æœ€é©ãªãƒšã‚¢ãƒªãƒ³ã‚°ãƒ¯ã‚¤ãƒ³ã‚’3ç¨®é¡ææ¡ˆã—ã¦ãã ã•ã„ã€‚\n\n${base}\n\n## ãƒšã‚¢ãƒªãƒ³ã‚°ãƒ¯ã‚¤ãƒ³ææ¡ˆ\n\n### 1. [ãƒ¯ã‚¤ãƒ³åãƒ»ç”£åœ°ãƒ»å¹´]ï¼ˆ[è‰²ãƒ»ã‚¿ã‚¤ãƒ—]ï¼‰\n- **é¸å®šç†ç”±:** æ–™ç†ã®ç‰¹å¾´ã¨ãƒ¯ã‚¤ãƒ³ã®ç‰¹æ€§ã®ç›¸æ€§\n- **å‘³ã‚ã„:** ãƒ¯ã‚¤ãƒ³ã®å‘³ã‚ã„ã®ç‰¹å¾´\n- **ã‚»ãƒ‘ãƒ¼ã‚¸ãƒ¥:** ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ–ãƒ‰ã‚¦å“ç¨®\n- **æ¤œè¨¼:** ãªãœã“ã®çµ„ã¿åˆã‚ã›ãŒè‰¯ã„ã®ã‹ã®ç§‘å­¦çš„ãƒ»æ„Ÿè¦šçš„æ ¹æ‹ \n\n### 2. [ãƒ¯ã‚¤ãƒ³åãƒ»ç”£åœ°ãƒ»å¹´]ï¼ˆ[è‰²ãƒ»ã‚¿ã‚¤ãƒ—]ï¼‰\n- **é¸å®šç†ç”±:** æ–™ç†ã®ç‰¹å¾´ã¨ãƒ¯ã‚¤ãƒ³ã®ç‰¹æ€§ã®ç›¸æ€§\n- **å‘³ã‚ã„:** ãƒ¯ã‚¤ãƒ³ã®å‘³ã‚ã„ã®ç‰¹å¾´\n- **ã‚»ãƒ‘ãƒ¼ã‚¸ãƒ¥:** ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ–ãƒ‰ã‚¦å“ç¨®\n- **æ¤œè¨¼:** ãªãœã“ã®çµ„ã¿åˆã‚ã›ãŒè‰¯ã„ã®ã‹ã®ç§‘å­¦çš„ãƒ»æ„Ÿè¦šçš„æ ¹æ‹ \n\n### 3. [ãƒ¯ã‚¤ãƒ³åãƒ»ç”£åœ°ãƒ»å¹´]ï¼ˆ[è‰²ãƒ»ã‚¿ã‚¤ãƒ—]ï¼‰\n- **é¸å®šç†ç”±:** æ–™ç†ã®ç‰¹å¾´ã¨ãƒ¯ã‚¤ãƒ³ã®ç‰¹æ€§ã®ç›¸æ€§\n- **å‘³ã‚ã„:** ãƒ¯ã‚¤ãƒ³ã®å‘³ã‚ã„ã®ç‰¹å¾´\n- **ã‚»ãƒ‘ãƒ¼ã‚¸ãƒ¥:** ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ–ãƒ‰ã‚¦å“ç¨®\n- **æ¤œè¨¼:** ãªãœã“ã®çµ„ã¿åˆã‚ã›ãŒè‰¯ã„ã®ã‹ã®ç§‘å­¦çš„ãƒ»æ„Ÿè¦šçš„æ ¹æ‹ \n\n## ãƒšã‚¢ãƒªãƒ³ã‚°ã®åŸºæœ¬åŸå‰‡\n\n- **ç›¸è£œæ€§:** æ–™ç†ã¨ãƒ¯ã‚¤ãƒ³ã®å‘³ã®ãƒãƒ©ãƒ³ã‚¹\n- **ç›¸ä¹—åŠ¹æœ:** æ–™ç†ã¨ãƒ¯ã‚¤ãƒ³ãŒäº’ã„ã‚’å¼•ãç«‹ã¦ã‚‹åŠ¹æœ\n- **åœ°åŸŸæ€§:** åŒã˜åœ°åŸŸã®æ–™ç†ã¨ãƒ¯ã‚¤ãƒ³ã®ç›¸æ€§\n- **æ¸©åº¦:** é©åˆ‡ãªé£²ç”¨æ¸©åº¦ã®ææ¡ˆ`;
      return { advice, temps, hazards, wine };
    }

    // ===== ç›´æ¥Groq APIå‘¼ã³å‡ºã— =====
    async function invokeGroq(prompt, responseSchema){
       const load = spinner();
       const activePane = document.querySelector('.ai-chat-container.active') || panes.advice;
       activePane.appendChild(load);
       try{
         await new Promise(resolve => setTimeout(resolve, 1000));

         const { data, error } = await sb.functions.invoke('call-groq-api', {
           body: {
             prompt,
             model: 'llama-3.1-8b-instant',
             maxTokens: 2048,
             temperature: 0.7
           }
         });

         if (error || !data?.success) {
           console.error('Groq API ã‚¨ãƒ©ãƒ¼:', error || data);
           throw new Error(`Groq API ã‚¨ãƒ©ãƒ¼: ${data?.error || 'unknown'}`);
         }

         const content = data.content;
         console.log('[AI raw]', content);

         if (!content) {
           throw new Error('Groq APIã‹ã‚‰æœ‰åŠ¹ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
         }

         const jsonMatch = content.match(/\{[\s\S]*\}/);
         if (jsonMatch) {
           try {
             const jsonData = JSON.parse(jsonMatch[0]);
             return jsonData;
           } catch (parseError) {
             console.error('JSONè§£æã‚¨ãƒ©ãƒ¼:', parseError);
             return { text: content };
           }
         }

         return { text: content };
       }catch(e){ 
         pushMsg(activePane,'assistant',`ã‚¨ãƒ©ãƒ¼: ${e.message}`); 
         return null; 
       }
       finally{ load.remove(); }
     }

    // ===== å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡ºï¼ˆGroq / OpenAI ä¸¡å¯¾å¿œï¼‰ =====
    function extractLLMText(r){
      try{
        if (!r) return '';
        if (typeof r === 'string') return r;
        if (r.text) return r.text;
        if (r.output_text) return r.output_text;
        if (r.message && typeof r.message.content === 'string') return r.message.content;
        if (Array.isArray(r.choices) && r.choices.length){
          const ch = r.choices[0];
          return (ch.message && ch.message.content) || ch.text || '';
        }
        if (Array.isArray(r.candidates) && r.candidates.length){
          const cand = r.candidates[0];
          if (cand && cand.content && Array.isArray(cand.content.parts)){
            return cand.content.parts.map(p => (p && p.text) ? p.text : '').join('\n').trim();
          }
        }
        if (r.content && Array.isArray(r.content.parts)){
            return r.content.parts.map(p => p.text || '').join('\n').trim();
        }
        try { return JSON.stringify(r); } catch { return ''; }
      }catch(e){
        console.error('extractLLMText error', e, r);
        return '';
      }
    }
    
    // ===== ãƒ¬ã‚·ãƒ”è¡¨ç¤ºç”¨ãƒ˜ãƒ«ãƒ‘ =====
    function renderRecipeCard(pane, recipeObj, sourceLabel = 'AIææ¡ˆ'){
      try{
        const title = recipeObj.title || 'ç„¡é¡Œã®ãƒ¬ã‚·ãƒ”';
        const desc = recipeObj.description || recipeObj.notes || '';
        const servings = recipeObj.servings ? String(recipeObj.servings) : '';
        const ings = Array.isArray(recipeObj.ingredients) ? recipeObj.ingredients : [];
        const steps = Array.isArray(recipeObj.steps) ? recipeObj.steps : [];

        const ingTable = `
          <div style="overflow-x: auto; width: 100%; margin-top:8px;">
            <table class="table">
              <thead><tr><th>ç•ªå·</th><th>ææ–™å</th><th>åˆ†é‡</th><th>å˜ä½</th></tr></thead>
              <tbody>
                ${ings.map((it,idx)=>`<tr><td>${idx+1}</td><td>${(it.item||it.name||'').toString()}</td><td>${(it.quantity||'').toString()}</td><td>${(it.unit||'').toString()}</td></tr>`).join('')}
              </tbody>
            </table>
          </div>`;
        const stepList = `<ol style="margin-top:8px; overflow: visible !important; text-overflow: unset !important; white-space: normal !important; word-wrap: break-word !important; word-break: break-word !important; overflow-wrap: break-word !important; max-width: 100% !important; box-sizing: border-box !important;">${steps.map(step => {
          // æ–‡å­—åˆ—ã®å ´åˆ
          if (typeof step === 'string') {
            return `<li style="overflow: visible !important; text-overflow: unset !important; white-space: normal !important; word-wrap: break-word !important; word-break: break-word !important; overflow-wrap: break-word !important; max-width: 100% !important; box-sizing: border-box !important; margin: 0.6rem 0 !important; padding: 0.4rem 0 !important; line-height: 1.7 !important;">${step}</li>`;
          }
          // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆï¼ˆç¿»è¨³ãƒ‡ãƒ¼ã‚¿å½¢å¼ï¼‰
          if (typeof step === 'object' && step.text) {
            return `<li style="overflow: visible !important; text-overflow: unset !important; white-space: normal !important; word-wrap: break-word !important; word-break: break-word !important; overflow-wrap: break-word !important; max-width: 100% !important; box-sizing: border-box !important; margin: 0.6rem 0 !important; padding: 0.4rem 0 !important; line-height: 1.7 !important;">${step.text}</li>`;
          }
          // ãã®ä»–ã®å ´åˆ
          return `<li style="overflow: visible !important; text-overflow: unset !important; white-space: normal !important; word-wrap: break-word !important; word-break: break-word !important; overflow-wrap: break-word !important; max-width: 100% !important; box-sizing: border-box !important; margin: 0.6rem 0 !important; padding: 0.4rem 0 !important; line-height: 1.7 !important;">${(step || '').toString()}</li>`;
        }).join('')}</ol>`;

        const wrap = document.createElement('div');
        wrap.className = 'card';
        wrap.style.padding = '12px';
        wrap.innerHTML = `
          <div class="muted" style="margin-bottom:4px;">${sourceLabel}</div>
          <h4 style="margin:4px 0;">${title}</h4>
          ${servings ? `<div style="margin:4px 0;">äººæ•°: ${servings}</div>` : ''}
          ${desc ? `<p style="white-space:pre-wrap;">${desc}</p>` : ''}
          <h5 style="margin-top:8px;">ææ–™</h5>
          ${ingTable}
          <h5 style="margin-top:12px;">æ‰‹é †</h5>
          ${stepList}
        `;
        pane.appendChild(wrap);

        const btnRow = document.createElement('div');
        btnRow.style.display = 'flex';
        btnRow.style.gap = '8px';
        btnRow.style.marginTop = '8px';
        btnRow.style.justifyContent = 'flex-start';
        btnRow.style.alignItems = 'flex-start';
        btnRow.style.flexWrap = 'wrap';
        const btnApply = document.createElement('button');
        btnApply.className = 'ai-btn';
        btnApply.textContent = 'åæ˜ ';
        btnApply.style.flex = '1';
        btnApply.style.minWidth = '80px';
        btnApply.style.maxWidth = '120px';
        btnApply.style.padding = '8px 16px';
        btnApply.style.fontSize = '14px';
        btnApply.style.borderRadius = '6px';
        btnApply.style.border = '1px solid #d1d5db';
        btnApply.style.backgroundColor = '#ffffff';
        btnApply.style.color = '#374151';
        btnApply.style.cursor = 'pointer';
        btnApply.style.whiteSpace = 'normal';
        btnApply.style.overflow = 'visible';
        btnApply.style.textOverflow = 'unset';
        btnApply.style.wordWrap = 'break-word';
        btnApply.style.wordBreak = 'break-word';
        btnApply.style.textAlign = 'center';
        btnApply.addEventListener('mouseenter', () => {
          btnApply.style.backgroundColor = '#f9fafb';
          btnApply.style.borderColor = '#9ca3af';
        });
        btnApply.addEventListener('mouseleave', () => {
          btnApply.style.backgroundColor = '#ffffff';
          btnApply.style.borderColor = '#d1d5db';
        });
        btnApply.addEventListener('click', ()=> applyRecipeToView(recipeObj));

        const btnNew = document.createElement('button');
        btnNew.className = 'ai-btn primary';
        btnNew.textContent = 'æ–°è¦';
        btnNew.style.flex = '1';
        btnNew.style.minWidth = '80px';
        btnNew.style.maxWidth = '120px';
        btnNew.style.padding = '8px 16px';
        btnNew.style.fontSize = '14px';
        btnNew.style.borderRadius = '6px';
        btnNew.style.border = '1px solid #3b82f6';
        btnNew.style.backgroundColor = '#3b82f6';
        btnNew.style.color = '#ffffff';
        btnNew.style.cursor = 'pointer';
        btnNew.style.whiteSpace = 'normal';
        btnNew.style.overflow = 'visible';
        btnNew.style.textOverflow = 'unset';
        btnNew.style.wordWrap = 'break-word';
        btnNew.style.wordBreak = 'break-word';
        btnNew.style.textAlign = 'center';
        btnNew.addEventListener('mouseenter', () => {
          btnNew.style.backgroundColor = '#2563eb';
          btnNew.style.borderColor = '#2563eb';
        });
        btnNew.addEventListener('mouseleave', () => {
          btnNew.style.backgroundColor = '#3b82f6';
          btnNew.style.borderColor = '#3b82f6';
        });
        btnNew.addEventListener('click', ()=>{
          try {
            // 2ç³»çµ±ã§å—ã‘æ¸¡ã—ï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ + localStorage ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
            localStorage.setItem('ai_generated_recipe', JSON.stringify(recipeObj));
            const recipeData = encodeURIComponent(JSON.stringify(recipeObj));
            window.open(`recipe_edit.html?newRecipe=${recipeData}`, '_blank');
          } catch (_) {
            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const recipeData = encodeURIComponent(JSON.stringify(recipeObj));
            window.open(`recipe_edit.html?newRecipe=${recipeData}`, '_blank');
          }
        });
        const btnCancel = document.createElement('button');
        btnCancel.className = 'ai-btn';
        btnCancel.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
        btnCancel.style.flex = '1';
        btnCancel.style.minWidth = '80px';
        btnCancel.style.maxWidth = '120px';
        btnCancel.style.padding = '8px 16px';
        btnCancel.style.fontSize = '14px';
        btnCancel.style.borderRadius = '6px';
        btnCancel.style.border = '1px solid #d1d5db';
        btnCancel.style.backgroundColor = '#ffffff';
        btnCancel.style.color = '#374151';
        btnCancel.style.cursor = 'pointer';
        btnCancel.style.whiteSpace = 'normal';
        btnCancel.style.overflow = 'visible';
        btnCancel.style.textOverflow = 'unset';
        btnCancel.style.wordWrap = 'break-word';
        btnCancel.style.wordBreak = 'break-word';
        btnCancel.style.textAlign = 'center';
        btnCancel.addEventListener('mouseenter', () => {
          btnCancel.style.backgroundColor = '#f9fafb';
          btnCancel.style.borderColor = '#9ca3af';
        });
        btnCancel.addEventListener('mouseleave', () => {
          btnCancel.style.backgroundColor = '#ffffff';
          btnCancel.style.borderColor = '#d1d5db';
        });
        btnCancel.addEventListener('click', ()=>{
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«: ãƒœã‚¿ãƒ³è¡Œã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
          btnApply.disabled = true;
          btnNew.disabled = true;
          btnCancel.disabled = true;
          const note = document.createElement('div');
          note.className = 'muted';
          note.style.marginTop = '6px';
          note.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ';
          pane.appendChild(note);
        });
        btnRow.appendChild(btnApply);
        btnRow.appendChild(btnNew);
        btnRow.appendChild(btnCancel);
        pane.appendChild(btnRow);
        
        // ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ã€ä¸€ç•ªä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆã‚¿ã‚°é¸æŠã‚’å¦¨ã’ãªã„ã‚ˆã†ã«ï¼‰
        setTimeout(() => {
          const pane = document.querySelector('.ai-chat-container.active');
          if (pane) {
            pane.scrollTop = pane.scrollHeight;
          }
        }, 100);
      }catch(e){
        console.error('renderRecipeCard error', e);
      }
    }

    function applyRecipeToView(recipe){
      try{
        console.log('applyRecipeToView called with:', recipe);
        const ingEl = document.getElementById('ingredients');
        const stepsEl = document.getElementById('steps');
        const titleEl = document.getElementById('recipeTitle');
        const notesEl = document.getElementById('notes');
        console.log('stepsEl found:', !!stepsEl);
        if (titleEl && recipe.title) {
          // AIå‰µä½œãƒ¬ã‚·ãƒ”ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
          const aiIcon = recipe.is_ai_generated ? '<i class="fas fa-robot ai-generated-icon" title="AIå‰µä½œãƒ¬ã‚·ãƒ”"></i>' : '';
          titleEl.innerHTML = `${recipe.title}${aiIcon}`;
        }
        if (notesEl && (recipe.description || recipe.notes)) notesEl.textContent = recipe.description || recipe.notes;
        const ings = Array.isArray(recipe.ingredients) ? recipe.ingredients : [];
        const cols = ['ç•ªå·','ææ–™å','åˆ†é‡','å˜ä½'];
        const thead = `<thead><tr>${cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>`;
        const tbody = `<tbody>${ings.map((it,idx)=>`<tr><td>${idx+1}</td><td>${(it.item||it.name||'')}</td><td>${it.quantity||''}</td><td>${it.unit||''}</td></tr>`).join('')}</tbody>`;
        ingEl.innerHTML = `<div style="overflow-x: auto; width: 100%;"><table class="table">${thead}${tbody}</table></div>`;
        const steps = Array.isArray(recipe.steps) ? recipe.steps : [];
        console.log('æ‰‹é †ãƒ‡ãƒ¼ã‚¿:', steps);
        if (steps.length > 0) {
          const stepsHTML = steps.map(step => {
            // æ–‡å­—åˆ—ã®å ´åˆ
            if (typeof step === 'string') {
              return `<li>${step}</li>`;
            }
            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆï¼ˆç¿»è¨³ãƒ‡ãƒ¼ã‚¿å½¢å¼ï¼‰
            if (typeof step === 'object' && step.text) {
              return `<li>${step.text}</li>`;
            }
            // ãã®ä»–ã®å ´åˆ
            return `<li>${(step || '').toString()}</li>`;
          }).join('');
          console.log('æ‰‹é †HTML:', stepsHTML);
          stepsEl.innerHTML = stepsHTML;
        } else {
          stepsEl.innerHTML = '<li class="muted">æœªç™»éŒ²</li>';
        }
      }catch(e){ console.error('applyRecipeToView error', e); }
    }

    // ===== ã‚¿ãƒ–å†…å®¹ç”Ÿæˆï¼ˆå¿…è¦æ™‚ã«å‘¼ã³å‡ºã—ï¼‰ =====
    async function generateTab(kind){
      console.log(`generateTabé–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã¾ã—ãŸ: ${kind}`);
      try {
        const prompts = buildPrompts();
        const pane = panes[kind];
        const basePrompt = prompts[kind];
        let promptToSend = basePrompt;
        console.log(`${kind}ã‚¿ãƒ–ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é€ä¿¡ä¸­...`);
        const r = await invokeGroq(promptToSend);
        const t = extractLLMText(r) || 'ï¼ˆçµæœãªã—ï¼‰';
        console.log(`${kind}ã‚¿ãƒ–ã®ç”Ÿæˆå®Œäº†`);
      // JSONã‚’äººé–“å‘ã‘ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
      const jsonMatchForView = t && t.match(/\{[\s\S]*\}/);
      if (jsonMatchForView) {
        try {
          const obj = JSON.parse(jsonMatchForView[0]);
          const recipeObj = obj.recipe || obj;
          renderRecipeCard(pane, recipeObj, 'AIæ–°è¦ãƒ¬ã‚·ãƒ”');
          if (obj.analysis) {
            const ana = document.createElement('div');
            ana.className = 'card';
            ana.style.padding = '12px';
            ana.style.marginTop = '8px';
            ana.innerHTML = `<h5>è€ƒå¯Ÿ</h5><p style="white-space:pre-wrap;">${obj.analysis}</p>`;
            pane.appendChild(ana);
          }
        } catch (_) {
          pushMsg(pane, 'assistant', t);
        }
      } else {
        pushMsg(pane, 'assistant', t);
      }
      chatHistories[kind].push({ role: 'assistant', content: t });
      } catch (error) {
        console.error(`generateTabé–¢æ•°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (${kind}):`, error);
        pushMsg(pane, 'assistant', `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
      }
    }

    // â–¼â–¼â–¼ ä¼šè©±å±¥æ­´ã‚’è€ƒæ…®ã—ã¦AIã«è³ªå•ã™ã‚‹ã‚ˆã†ä¿®æ­£ â–¼â–¼â–¼
    btnSend.addEventListener('click', async ()=>{
      const q = input.value.trim(); if(!q) return;

      const activeTabEl = document.querySelector('.ai-tab[aria-selected="true"]');
      const kind = activeTabEl.dataset.tab;
      const pane = panes[kind];
      const history = chatHistories[kind];
      
      pushMsg(pane,'user',q);
      history.push({ role: 'user', content: q });
      input.value='';

      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºé–‹å§‹
      showStatusPopup('AIåˆ†æä¸­...', 'AIãŒå›ç­”ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™', 'loading');

      try {
        setAIInputEnabled(false);
        const historyText = history.map(msg => {
            return `${msg.role === 'user' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼' : 'ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ'}:\n${msg.content}`;
        }).join('\n\n');

        const initialPrompt = buildPrompts()[kind];
        const fullPrompt = `${initialPrompt}\n\n---\nä¸Šè¨˜ã¯æœ€åˆã®æŒ‡ç¤ºã§ã™ã€‚ä»¥ä¸‹ã¯ãã‚Œä»¥é™ã®ä¼šè©±å±¥æ­´ã§ã™ã€‚æ–‡è„ˆã‚’è¸ã¾ãˆã¦å¿œç­”ã‚’ç¶šã‘ã¦ãã ã•ã„ã€‚\n\n${historyText}`;

        const r = await invokeGroq(fullPrompt);
        const t = extractLLMText(r) || 'ï¼ˆçµæœãªã—ï¼‰';
        
        pushMsg(pane,'assistant',t);
        history.push({ role: 'assistant', content: t });
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºå®Œäº†
        updateStatusPopup('å®Œäº†', 'AIå›ç­”ã‚’ç”Ÿæˆã—ã¾ã—ãŸ', 'success');
        setTimeout(hideStatusPopup, 1500);
        
      } catch (error) {
        console.error('AIå›ç­”ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        updateStatusPopup('ã‚¨ãƒ©ãƒ¼', 'AIå›ç­”ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        setTimeout(hideStatusPopup, 3000);
      } finally {
        setAIInputEnabled(true);
        if (input) input.value = '';
      }
    });

    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); btnSend.click(); }});

    // ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—åˆ¶å¾¡ =====
    function showStatusPopup(title, message, type = 'loading') {
      const popup = document.getElementById('statusPopup');
      const titleEl = popup.querySelector('.status-title');
      const messageEl = popup.querySelector('.status-message');
      const spinnerEl = popup.querySelector('.spinner');
      
      titleEl.textContent = title;
      messageEl.textContent = message;
      
      // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
      popup.className = 'status-popup';
      if (type !== 'loading') {
        popup.classList.add(type);
        // æˆåŠŸãƒ»ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¹ãƒ”ãƒŠãƒ¼ã‚’éè¡¨ç¤º
        spinnerEl.style.display = 'none';
      } else {
        spinnerEl.style.display = 'block';
      }
      
      popup.style.display = 'flex';
    }
    
    function hideStatusPopup() {
      const popup = document.getElementById('statusPopup');
      popup.style.display = 'none';
    }
    
    function updateStatusPopup(title, message, type = 'loading') {
      const popup = document.getElementById('statusPopup');
      const titleEl = popup.querySelector('.status-title');
      const messageEl = popup.querySelector('.status-message');
      const spinnerEl = popup.querySelector('.spinner');
      
      titleEl.textContent = title;
      messageEl.textContent = message;
      
      // ã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°
      popup.className = 'status-popup';
      if (type !== 'loading') {
        popup.classList.add(type);
        spinnerEl.style.display = 'none';
      } else {
        spinnerEl.style.display = 'block';
      }
    }


    // â–¼â–¼â–¼ã€ã“ã“ã‹ã‚‰å…ƒã«æˆ»ã—ãŸç®‡æ‰€ã€‘â–¼â–¼â–¼
    // ===== æ–°è¦ãƒ¬ã‚·ãƒ”åŒ–ï¼ˆJSON + å˜ä½æ­£è¦åŒ–ï¼‰ =====
    btnSave.addEventListener('click', async ()=>{
      // é€²è¡ŒçŠ¶æ³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
      showRecipeProgressPopup();
      
      try {
        updateRecipeProgress(10, 'ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ä¸­...');
        
        const schema = { type:"OBJECT", properties:{ title:{type:"STRING"}, category:{type:"STRING"}, tags:{type:"ARRAY",items:{type:"STRING"}}, notes:{type:"STRING"}, ingredients:{type:"ARRAY", items:{type:"OBJECT", properties:{ item:{type:"STRING"}, quantity:{type:"STRING"}, unit:{type:"STRING"} }, required:["item"]}}, steps:{type:"ARRAY",items:{type:"STRING"}} }, required:["title","category","tags","notes","ingredients","steps"] };
        
        // æ–°è¦ãƒ¬ã‚·ãƒ”åŒ–å°‚ç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆ
        const { title, ings, steps } = scrapeRecipe();
        const ingText = ings.map(i=>`- ${i.item} ${i.quantity||''} ${i.unit||''}`).join('\n');
        const stepText = steps.map((s,i)=> `${i+1}. ${s}`).join('\n');
        
        updateRecipeProgress(30, 'AIã«ãƒ¬ã‚·ãƒ”åŒ–ã‚’ä¾é ¼ä¸­...');
      
      const recipePrompt = `ä»¥ä¸‹ã®ãƒ¬ã‚·ãƒ”ã‚’åŸºã«ã€æ”¹å–„ã•ã‚ŒãŸæ–°ãƒ¬ã‚·ãƒ”ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

# ãƒ¬ã‚·ãƒ”å
${title||'ç„¡é¡Œã®ãƒ¬ã‚·ãƒ”'}

## ææ–™
${ingText}

## æ‰‹é †
${stepText}

## å‡ºåŠ›ä»•æ§˜
1. ä¸Šè¨˜ãƒ¬ã‚·ãƒ”ã‚’æ”¹å–„ã—ã€æ–°ã—ã„ãƒ¬ã‚·ãƒ”ã‚’ä½œæˆã—ã¦ãã ã•ã„
2. ææ–™ã¯g/mlã‚’åŸºæœ¬å˜ä½ã¨ã—ã€å˜ä½çœç•¥ä¸å¯
3. åŒç¾©å˜ä½ã¯å¤‰æ›ã—ã¦ãã ã•ã„ï¼ˆtsp=5ml, tbsp=15ml, å°ã•ã˜=5ml, å¤§ã•ã˜=15mlï¼‰
4. ä»¥ä¸‹ã®JSONå½¢å¼ã§ã®ã¿å›ç­”ã—ã¦ãã ã•ã„ï¼ˆãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜å·ã¯ä½¿ç”¨ã—ãªã„ï¼‰ï¼š

{
  "title": "æ”¹å–„ã•ã‚ŒãŸãƒ¬ã‚·ãƒ”å",
  "category": "ã‚«ãƒ†ã‚´ãƒª",
  "tags": ["ã‚¿ã‚°1", "ã‚¿ã‚°2"],
  "notes": "ãƒ¬ã‚·ãƒ”ã®èª¬æ˜ã‚„ã‚³ãƒ„",
  "ingredients": [
    {"item": "ææ–™å", "quantity": "åˆ†é‡", "unit": "å˜ä½"}
  ],
  "steps": ["æ‰‹é †1", "æ‰‹é †2"]
}`;

      // ä¼šè©±å±¥æ­´ï¼ˆææ¡ˆã‚¿ãƒ–ï¼‰ã‚’è€ƒæ…®
      let promptWithHistory = recipePrompt;
      if (chatHistories.advice && chatHistories.advice.length){
        const historyText = chatHistories.advice.map(m=>`${m.role==='user'?'ãƒ¦ãƒ¼ã‚¶ãƒ¼':'ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ'}:\n${m.content}`).join('\n\n');
        promptWithHistory = `${recipePrompt}\n\n---\nä»¥ä¸‹ã¯ã“ã‚Œã¾ã§ã®ä¼šè©±å±¥æ­´ã§ã™ã€‚ç½®ãæ›ãˆä¾é ¼ã‚„æ¡ä»¶ã‚’å¿…ãšè€ƒæ…®ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚\n\n${historyText}\n\n---\nå‡ºåŠ›ã¯æ¬¡ã®JSONå½¢å¼ï¼š\n{\n  "recipe": {"title":"â€¦","description":"â€¦","servings":"â€¦","ingredients":[{"item":"â€¦","quantity":"â€¦","unit":"â€¦"}],"steps":["â€¦","â€¦"],"notes":"â€¦"},\n  "analysis": "ç½®ãæ›ãˆã®ç†ç”±ãƒ»å‘³ãƒ»è³ªæ„Ÿãƒ»å®‰å…¨ã®è€ƒå¯Ÿ"\n}`;
      }
      updateRecipeProgress(50, 'AIãŒãƒ¬ã‚·ãƒ”ã‚’ç”Ÿæˆä¸­...');
      
      const r = await invokeGroq(promptWithHistory, schema);
      const jsonText = extractLLMText(r);
      if (!jsonText){ alert('JSONã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚'); return; }
      
      updateRecipeProgress(70, 'ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...');
      
      try{
        const jsonMatch = jsonText.match(/\{[\s\S]*\}/);
        const cleanJsonText = jsonMatch ? jsonMatch[0] : jsonText;
        const parsed = JSON.parse(cleanJsonText);
        const obj = parsed.recipe || parsed;
        // å˜ä½ã®è»½ã„æ­£è¦åŒ–ï¼ˆã‚¹ãƒ—ãƒ¼ãƒ³æ›ç®—ï¼‰
        const unitMap = { 'tsp':'ml', 'tbsp':'ml', 'å°ã•ã˜':'ml', 'å¤§ã•ã˜':'ml' };
        const toVol = (q,u)=>{ const n=Number(q); if(!Number.isFinite(n)) return q; if(u==='tsp'||u==='å°ã•ã˜') return n*5; if(u==='tbsp'||u==='å¤§ã•ã˜') return n*15; return n; };
        obj.ingredients = (obj.ingredients||[]).map(it=>{ const u=(it.unit||'').toLowerCase(); if(unitMap[u]) return { ...it, quantity:String(toVol(it.quantity,u)), unit:'ml' }; return it; });
        
        updateRecipeProgress(90, 'ãƒ¬ã‚·ãƒ”ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºä¸­...');
        
        // åŒã˜ãƒãƒ£ãƒƒãƒˆãƒ©ã‚¤ãƒ³ï¼ˆææ¡ˆã‚¿ãƒ–ï¼‰ã«äººé–“å‘ã‘ã‚«ãƒ¼ãƒ‰ã§è¡¨ç¤ºã—ã€åæ˜ /ç·¨é›†ãƒœã‚¿ãƒ³ã‚’æä¾›
        renderRecipeCard(panes.advice, obj, 'æ–°è¦ãƒ¬ã‚·ãƒ”åŒ–ï¼ˆAIï¼‰');
        if (parsed.analysis) {
          const ana = document.createElement('div');
          ana.className = 'card';
          ana.style.padding = '12px';
          ana.style.marginTop = '8px';
          ana.innerHTML = `<h5>è€ƒå¯Ÿ</h5><p style="white-space:pre-wrap;">${parsed.analysis}</p>`;
          panes.advice.appendChild(ana);
        }
        localStorage.setItem('ai_generated_recipe', JSON.stringify(obj));
        
        updateRecipeProgress(100, 'ãƒ¬ã‚·ãƒ”åŒ–å®Œäº†ï¼');
        
        // å®Œäº†å¾Œå°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
        setTimeout(() => {
          hideRecipeProgressPopup();
        }, 1000);
        
      }catch(e){
        console.error('ãƒ¬ã‚·ãƒ”åŒ–ã‚¨ãƒ©ãƒ¼:', e);
        updateRecipeProgress(0, `ã‚¨ãƒ©ãƒ¼: ${e.message}`);
        pushMsg(panes.advice, 'assistant', `ã‚¨ãƒ©ãƒ¼: ${e.message}`);
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
        setTimeout(() => {
          hideRecipeProgressPopup();
        }, 2000);
        console.error('JSONè§£æã‚¨ãƒ©ãƒ¼:', e, 'å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ:', jsonText);
        alert('JSONã®è§£æã«å¤±æ•—: '+ e.message + '\n\nå–å¾—ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ: ' + jsonText.substring(0, 200) + '...');
      }
      }catch(e){
        console.error('ãƒ¬ã‚·ãƒ”åŒ–å…¨ä½“ã®ã‚¨ãƒ©ãƒ¼:', e);
        updateRecipeProgress(0, `ã‚¨ãƒ©ãƒ¼: ${e.message}`);
        pushMsg(panes.advice, 'assistant', `ã‚¨ãƒ©ãƒ¼: ${e.message}`);
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
        setTimeout(() => {
          hideRecipeProgressPopup();
        }, 2000);
      }
    });
    // â–²â–²â–²ã€ã“ã“ã¾ã§å…ƒã«æˆ»ã—ãŸç®‡æ‰€ã€‘â–²â–²â–²
  </script>

<script>
// ===== ãƒ¬ã‚·ãƒ”èª­ã¿è¾¼ã¿ï¼ˆURLã® id ã‹ã‚‰å–å¾—ã—ã¦è¡¨ç¤ºï¼‰ =====
(function(){
  try{
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    if(!id){
      alert('ãƒ¬ã‚·ãƒ”IDãŒã‚ã‚Šã¾ã›ã‚“'); location.href='../index.html'; return;
    }

    if(!window.sb && window.supabase){
      window.sb = window.supabase.createClient(
        "https://nnbdzwrndqtsfzobknmj.supabase.co",
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0eHlhd2luYmx3Y2Jrb3Zmc3lqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NzE3MzIsImV4cCI6MjA3MDU0NzczMn0.HMMoDl_LPz8uICruD_tzn75eUpU7rp3RZx_N8CEfO1Q"
      );
    }
    if(!window.sb){ console.error('Supabase not initialized'); return; }
    const sb = window.sb;
    
    // è¨€èªã‚³ãƒ¼ãƒ‰ã‹ã‚‰å›½æ——ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    const getFlagEmoji = (languageCode) => {
      const flagMap = {
        'fr': 'ğŸ‡«ğŸ‡·', // ãƒ•ãƒ©ãƒ³ã‚¹
        'it': 'ğŸ‡®ğŸ‡¹', // ã‚¤ã‚¿ãƒªã‚¢
        'ja': 'ğŸ‡¯ğŸ‡µ', // æ—¥æœ¬
        'zh': 'ğŸ‡¨ğŸ‡³', // ä¸­å›½
        'es': 'ğŸ‡ªğŸ‡¸', // ã‚¹ãƒšã‚¤ãƒ³
        'de': 'ğŸ‡©ğŸ‡ª', // ãƒ‰ã‚¤ãƒ„
        'en': 'ğŸ‡ºğŸ‡¸'  // ã‚¢ãƒ¡ãƒªã‚«ï¼ˆè‹±èªï¼‰
      };
      return flagMap[languageCode] || 'ğŸŒ';
    };

    const titleEl = document.getElementById('recipeTitle');
    const metaEl  = document.getElementById('meta');
    const tagsEl  = document.getElementById('tags');
    const notesEl = document.getElementById('notes');
    const ingEl   = document.getElementById('ingredients');
    const stepsEl = document.getElementById('steps');
    const btnEdit   = document.querySelector('.js-edit');
    const btnDelete = document.querySelector('.js-delete');
    const btnBack   = document.querySelector('.js-back');
    const favBtn    = document.getElementById('favBtn');

    console.log('æˆ»ã‚‹ãƒœã‚¿ãƒ³è¦ç´ :', btnBack);
    console.log('æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹:', !!btnBack);
    console.log('æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¯ãƒ©ã‚¹:', btnBack?.className);
    console.log('æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆ:', btnBack?.textContent);

    btnEdit?.addEventListener('click', ()=>{ location.href = `recipe_edit.html?id=${encodeURIComponent(id)}`; });
    
    // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç¢ºå®Ÿã«è¨­å®š
    if (btnBack) {
      btnBack.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
        window.location.href = '../index.html';
      };
      console.log('æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ');
    } else {
      console.error('æˆ»ã‚‹ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
    btnDelete?.addEventListener('click', async ()=>{
      if(!confirm('ã“ã®ãƒ¬ã‚·ãƒ”ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿï¼ˆææ–™ãƒ»æ‰‹é †ã¯æ®‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰')) return;
      try{
        // å‰Šé™¤å‰ã«ç¾åœ¨ã®ãƒ¬ã‚·ãƒ”ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã‚¿ã‚°ã‚’å–å¾—
        const { data: currentRecipe } = await sb.from('recipes').select('category, tags').eq('id', id).single();
        const deletedCategory = currentRecipe?.category;
        const deletedTags = Array.isArray(currentRecipe?.tags) ? currentRecipe.tags : [];
        
        // ãƒ¬ã‚·ãƒ”ã‚’å‰Šé™¤
        await sb.from('recipes').delete().eq('id', id);
        
        // ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®è‡ªå‹•å‰Šé™¤ãƒã‚§ãƒƒã‚¯
        if (deletedCategory) {
          await cleanupUnusedCategory(deletedCategory);
        }
        
        // ã‚¿ã‚°ã®è‡ªå‹•å‰Šé™¤ãƒã‚§ãƒƒã‚¯
        if (deletedTags.length > 0) {
          await cleanupUnusedTags(deletedTags);
        }
        
        alert('å‰Šé™¤ã—ã¾ã—ãŸ'); 
        location.href = '../index.html';
      }catch(e){ 
        alert('å‰Šé™¤ã«å¤±æ•—: ' + (e.message||e)); 
      }
    });
    
    // æœªä½¿ç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®å‰Šé™¤é–¢æ•°
    async function cleanupUnusedCategory(categoryName) {
      try {
        console.log('ã‚«ãƒ†ã‚´ãƒªãƒ¼ä½¿ç”¨çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯ä¸­:', categoryName);
        
        // åŸºæœ¬ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¯å‰Šé™¤ã—ãªã„
        const basicCategories = [
          'ã™ã¹ã¦', 'ã‚¢ãƒŸãƒ¥ãƒ¼ã‚º', 'å‰èœ', 'ã‚½ãƒ¼ã‚¹', 'ã‚¹ãƒ¼ãƒ—', 'ãƒ‘ã‚¹ã‚¿', 
          'é­šæ–™ç†', 'è‚‰æ–™ç†', 'ãƒ¡ã‚¤ãƒ³', 'ãƒ‡ã‚¶ãƒ¼ãƒˆ', 'ãƒ‘ãƒ³', 'ãã®ä»–'
        ];
        
        if (basicCategories.includes(categoryName)) {
          console.log('åŸºæœ¬ã‚«ãƒ†ã‚´ãƒªãƒ¼ãªã®ã§å‰Šé™¤ã‚’ã‚¹ã‚­ãƒƒãƒ—:', categoryName);
          return;
        }
        
        // åŒã˜ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ä»–ã®ãƒ¬ã‚·ãƒ”ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const { data: recipesWithCategory, error: checkError } = await sb
          .from('recipes')
          .select('id')
          .eq('category', categoryName);
        
        if (checkError) {
          console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼ä½¿ç”¨çŠ¶æ³ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', checkError);
          return;
        }
        
        // ä½¿ç”¨ã—ã¦ã„ã‚‹ãƒ¬ã‚·ãƒ”ãŒ0ä»¶ã®å ´åˆã€categoriesãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã‚‚å‰Šé™¤
        if (recipesWithCategory.length === 0) {
          console.log('æœªä½¿ç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å‰Šé™¤ä¸­:', categoryName);
          
          const { error: deleteError } = await sb
            .from('categories')
            .delete()
            .eq('name', categoryName);
          
          if (deleteError) {
            console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', deleteError);
          } else {
            console.log('æœªä½¿ç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ:', categoryName);
            
            // index.htmlã«æœªä½¿ç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼å‰Šé™¤ã®é€šçŸ¥ã‚’é€ã‚‹
            localStorage.setItem('categoryDeleted', JSON.stringify({
              name: categoryName,
              timestamp: Date.now()
            }));
          }
        } else {
          console.log('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¯ä»–ã®ãƒ¬ã‚·ãƒ”ã§ä½¿ç”¨ä¸­:', categoryName, 'ä½¿ç”¨æ•°:', recipesWithCategory.length);
        }
        
      } catch (error) {
        console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // æœªä½¿ç”¨ã‚¿ã‚°ã®å‰Šé™¤é–¢æ•°
    async function cleanupUnusedTags(tagsToCheck) {
      if (!Array.isArray(tagsToCheck) || tagsToCheck.length === 0) {
        return;
      }
      
      try {
        console.log('æœªä½¿ç”¨ã‚¿ã‚°ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’é–‹å§‹:', tagsToCheck);
        
        // å…¨ãƒ¬ã‚·ãƒ”ã®ã‚¿ã‚°ã‚’å–å¾—
        const { data: allRecipes, error: recipesError } = await sb
          .from('recipes')
          .select('tags')
          .not('tags', 'is', null);
        
        if (recipesError) {
          console.error('ãƒ¬ã‚·ãƒ”å–å¾—ã‚¨ãƒ©ãƒ¼:', recipesError);
          return;
        }
        
        // ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚°ã‚’é›†è¨ˆ
        const usedTags = new Set();
        allRecipes.forEach(recipe => {
          if (Array.isArray(recipe.tags)) {
            recipe.tags.forEach(tag => usedTags.add(tag));
          }
        });
        
        // ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®ã‚¿ã‚°ã§ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ã‚‚ã®ã‚’å‰Šé™¤
        for (const tagName of tagsToCheck) {
          if (!usedTags.has(tagName)) {
            console.log('æœªä½¿ç”¨ã‚¿ã‚°ã‚’å‰Šé™¤:', tagName);
            
            const { error: deleteError } = await sb
              .from('tags')
              .delete()
              .eq('name', tagName);
            
            if (deleteError) {
              console.error('ã‚¿ã‚°å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', tagName, deleteError);
            } else {
              console.log('æœªä½¿ç”¨ã‚¿ã‚°å‰Šé™¤æˆåŠŸ:', tagName);
            }
          }
        }
        
      } catch (error) {
        console.error('æœªä½¿ç”¨ã‚¿ã‚°ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    function getClientId(){
      let cid = localStorage.getItem('client_id');
      if(!cid){ cid = (crypto?.randomUUID?.() || String(Math.random()).slice(2)); localStorage.setItem('client_id', cid); }
      return cid;
    }
    async function refreshFavState(){
      try{
        const { data } = await sb.from('favorites').select('id').eq('recipe_id', id).eq('client_id', getClientId()).limit(1);
        const on = !!(data && data.length);
        if(favBtn){
          favBtn.textContent = on ? 'â™¥ ãŠæ°—ã«å…¥ã‚Šè§£é™¤' : 'â™¡ ãŠæ°—ã«å…¥ã‚Š';
          favBtn.dataset.active = on ? '1' : '0';
        }
      }catch(_){}
    }
    favBtn?.addEventListener('click', async ()=>{
      try{
        const cid = getClientId();
        const { data } = await sb.from('favorites').select('id').eq('recipe_id', id).eq('client_id', cid).limit(1);
        if(data && data.length){
          await sb.from('favorites').delete().eq('id', data[0].id);
        }else{
          await sb.from('favorites').insert({ recipe_id: id, client_id: cid });
        }
        await refreshFavState();
      }catch(e){ alert('ãŠæ°—ã«å…¥ã‚Šæ“ä½œã«å¤±æ•—: ' + (e.message||e)); }
    });

    // escé–¢æ•°ã¯ utils.js ã® escapeHtml ã‚’ä½¿ç”¨

    // HTMLå½¢å¼ã®ãƒ¬ã‚·ãƒ”ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
    async function loadHTMLFormatRecipe(recipe) {
      console.log('HTMLå½¢å¼ãƒ¬ã‚·ãƒ”ã®è©³ç´°èª­ã¿è¾¼ã¿:', recipe);
      
      // ã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ¡ã‚¿æƒ…å ±ã‚’è¨­å®š
      // AIå‰µä½œãƒ¬ã‚·ãƒ”ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
      const aiIcon = recipe.is_ai_generated ? '<i class="fas fa-robot ai-generated-icon" title="AIå‰µä½œãƒ¬ã‚·ãƒ”"></i>' : '';
      titleEl.innerHTML = `${recipe.title || 'ç„¡é¡Œã®ãƒ¬ã‚·ãƒ”'}${aiIcon}`;
      const dt = recipe.updated_at || recipe.created_at;
      metaEl.textContent = dt ? `æ›´æ–°: ${new Date(dt).toLocaleString()}` : '';
      
      // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã‚¿ã‚°ã®è¡¨ç¤º
      const categoryDisplay = document.getElementById('categoryDisplay');
      const categoryText = document.getElementById('categoryText');
      const tagsDisplay = document.getElementById('tagsDisplay');
      const tagsContainer = document.getElementById('tagsContainer');
      
      if (recipe.category && recipe.category.trim()) {
        categoryText.textContent = recipe.category;
        categoryDisplay.style.display = 'block';
      } else {
        categoryDisplay.style.display = 'none';
      }
      
      if (recipe.tags && Array.isArray(recipe.tags) && recipe.tags.length > 0) {
        tagsContainer.innerHTML = '';
        recipe.tags.forEach(tag => {
          const tagEl = document.createElement('span');
          tagEl.className = 'tag';
          tagEl.textContent = tag;
          tagsContainer.appendChild(tagEl);
        });
        tagsDisplay.style.display = 'block';
      } else {
        tagsDisplay.style.display = 'none';
      }
      
      // èª¬æ˜æ–‡ã‚’HTMLå½¢å¼ã§è¡¨ç¤º
      const notesEl = document.getElementById('notes');
      if (notesEl && recipe.notes) {
        notesEl.innerHTML = recipe.notes; // HTMLå½¢å¼ã®èª¬æ˜æ–‡ã‚’ãã®ã¾ã¾è¡¨ç¤º
      }
      
      // ææ–™ã‚’HTMLå½¢å¼ã§è¡¨ç¤º
      const ingredientsEl = document.getElementById('ingredients');
      if (ingredientsEl) {
        try {
          const { data: ingredients, error: ingredientsError } = await sb
            .from('recipe_ingredients')
            .select('*')
            .eq('recipe_id', recipe.id)
            .order('position');
          
          if (!ingredientsError && ingredients && ingredients.length > 0) {
            // HTMLå½¢å¼ã®ææ–™ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
            const hasHTMLContent = ingredients.some(ing => ing.html_content);
            if (hasHTMLContent) {
              // ç¿»è¨³ç‰ˆã¨å…ƒã®æ—¥æœ¬èªç‰ˆã‚’åˆ†ã‘ã¦è¡¨ç¤º
              // ææ–™ã®ç·æ•°ã‹ã‚‰ç¿»è¨³ç‰ˆã®æ•°ã‚’æ¨å®šï¼ˆé€šå¸¸ã¯åŠåˆ†ï¼‰
              const totalIngredients = ingredients.length;
              const translatedCount = Math.floor(totalIngredients / 2);
              const translatedIngredients = ingredients.filter(ing => ing.position <= translatedCount);
              const originalIngredients = ingredients.filter(ing => ing.position > translatedCount);
              
              const translatedTableHTML = `
                <div class="translated-section">
                  <h4>ææ–™ (Ingredients)</h4>
                  <div style="overflow-x: auto; width: 100%;">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>ç•ªå·</th>
                          <th>ææ–™å</th>
                          <th>åˆ†é‡</th>
                          <th>å˜ä½</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${translatedIngredients.map((ing, index) => ing.html_content || `
                          <tr>
                            <td>${index + 1}</td>
                            <td>${ing.item}</td>
                            <td>${ing.quantity}</td>
                            <td>${ing.unit}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              `;
              
              const originalTableHTML = `
                <div class="original-section">
                  <h5>å…ƒã®ææ–™</h5>
                  <div style="overflow-x: auto; width: 100%;">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>ç•ªå·</th>
                          <th>ææ–™å</th>
                          <th>åˆ†é‡</th>
                          <th>å˜ä½</th>
                          <th>ä¾¡æ ¼</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${originalIngredients.map((ing, index) => ing.html_content || `
                          <tr>
                            <td>${index + 1}</td>
                            <td>${ing.item}</td>
                            <td>${ing.quantity}</td>
                            <td>${ing.unit}</td>
                            <td>${ing.price || ''}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              `;
              
              ingredientsEl.innerHTML = translatedTableHTML + originalTableHTML;
            } else {
              // é€šå¸¸ã®ææ–™è¡¨ç¤º
              const tableHTML = `
                <div class="table">
                  <table>
                    <thead>
                      <tr>
                        <th>ç•ªå·</th>
                        <th>ææ–™å</th>
                        <th>åˆ†é‡</th>
                        <th>å˜ä½</th>
                        <th>price</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${ingredients.map(ing => `
                        <tr>
                          <td>${ing.position}</td>
                          <td>${ing.item}</td>
                          <td>${ing.quantity}</td>
                          <td>${ing.unit}</td>
                          <td>${ing.price || ''}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              `;
              ingredientsEl.innerHTML = tableHTML;
            }
          } else {
            ingredientsEl.innerHTML = '<div class="muted">æœªç™»éŒ²</div>';
          }
        } catch (error) {
          console.error('ææ–™èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          ingredientsEl.innerHTML = '<div class="muted">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
        }
      }
      
      // æ‰‹é †ã‚’HTMLå½¢å¼ã§è¡¨ç¤º
      const stepsEl = document.getElementById('steps');
      if (stepsEl) {
        try {
          const { data: steps, error: stepsError } = await sb
            .from('recipe_steps')
            .select('*')
            .eq('recipe_id', recipe.id)
            .order('position');
          
          if (!stepsError && steps && steps.length > 0) {
            // HTMLå½¢å¼ã®æ‰‹é †ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
            const hasHTMLContent = steps.some(step => step.html_content);
            if (hasHTMLContent) {
              // HTMLå½¢å¼ã®æ‰‹é †ã‚’ãã®ã¾ã¾è¡¨ç¤º
              const stepsHTML = steps.map(step => step.html_content || `
                <div class="step">
                  <span class="step-number">${step.position}.</span>
                  <span class="step-text">${step.instruction}</span>
                </div>
              `).join('');
              stepsEl.innerHTML = stepsHTML;
            } else {
              // é€šå¸¸ã®æ‰‹é †è¡¨ç¤º
              const stepsHTML = steps.map(step => `
                <div class="step">
                  <span class="step-number">${step.position}.</span>
                  <span class="step-text">${step.instruction}</span>
                </div>
              `).join('');
              stepsEl.innerHTML = stepsHTML;
            }
          } else {
            stepsEl.innerHTML = '<div class="muted">æœªç™»éŒ²</div>';
          }
        } catch (error) {
          console.error('æ‰‹é †èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          stepsEl.innerHTML = '<div class="muted">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
        }
      }
      
      // ç”»åƒã®è¡¨ç¤º
      if (recipe.image_url) {
        const imageContainer = document.getElementById('recipeImageContainer');
        const imageEl = document.getElementById('recipeImage');
        if (imageContainer && imageEl) {
          imageEl.src = recipe.image_url;
          imageContainer.style.display = 'block';
        }
      }
    }

    async function load(){
      // IDãŒnullã®å ´åˆã¯æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
      if (!id) {
        console.error('ãƒ¬ã‚·ãƒ”IDãŒnullã§ã™');
        alert('ãƒ¬ã‚·ãƒ”IDãŒç„¡åŠ¹ã§ã™');
        location.href = '../index.html';
        return;
      }
      
      const { data: recs, error } = await sb.from('recipes').select('*').eq('id', id).limit(1);
      if(error){ console.error(error); alert('ãƒ¬ã‚·ãƒ”ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
      const r = recs?.[0];
      if(!r){ alert('ãƒ¬ã‚·ãƒ”ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
      
      // å…ƒã®ãƒ¬ã‚·ãƒ”IDã‚’ä¿å­˜ï¼ˆç¿»è¨³ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ™‚ã«ä½¿ç”¨ï¼‰
      window.originalRecipeId = id;
      console.log('å…ƒã®ãƒ¬ã‚·ãƒ”IDã‚’ä¿å­˜:', id);

      titleEl.textContent = r.title || 'ç„¡é¡Œã®ãƒ¬ã‚·ãƒ”';
      
      // è¨€èªã‚¿ã‚°ã‚’ç¢ºèªã—ã¦è‡ªå‹•ç¿»è¨³
      const languageTag = r.tags?.find(tag => tag.startsWith('ç¿»è¨³:'));
      if (languageTag) {
        const targetLanguage = languageTag.replace('ç¿»è¨³:', '');
        console.log('è¨€èªã‚¿ã‚°ã‚’æ¤œå‡º:', languageTag, 'å¯¾è±¡è¨€èª:', targetLanguage);
        // è‡ªå‹•ç¿»è¨³ã‚’å®Ÿè¡Œ
        await autoTranslateRecipe(targetLanguage);
        return; // è‡ªå‹•ç¿»è¨³ã®å ´åˆã¯æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
      }
      
      // HTMLå½¢å¼ã®ãƒ¬ã‚·ãƒ”ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
      if (r.display_format === 'html') {
        console.log('HTMLå½¢å¼ã®ãƒ¬ã‚·ãƒ”ã‚’èª­ã¿è¾¼ã¿ä¸­...');
        await loadHTMLFormatRecipe(r);
        return; // HTMLå½¢å¼ã®å ´åˆã¯æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³
      }
      
      // ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ãƒ»è¡¨ç¤º
      let translationRecipes = null;
      try {
        console.log('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­... recipe_id:', id);
        
        // ç¿»è¨³ãƒ¬ã‚·ãƒ”ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        console.log('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­ - ãƒ¬ã‚·ãƒ”ID:', id);
        const { data: translationRecipesData, error: translationRecipeError } = await sb
          .from('translation_recipes')
          .select('*')
          .eq('original_recipe_id', id)
          .order('created_at', { ascending: false })
          .limit(1);
        
        console.log('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿å–å¾—çµæœ:', { translationRecipesData, translationRecipeError });
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        if (translationRecipeError) {
          if (translationRecipeError.code === 'PGRST116' || translationRecipeError.message.includes('relation "translation_recipes" does not exist')) {
            console.log('translation_recipesãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚create_translation_recipe_tables.sqlã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
            translationRecipes = null;
          } else if (translationRecipeError.code === 'PGRST200') {
            console.log('translation_recipesãƒ†ãƒ¼ãƒ–ãƒ«ã®é–¢ä¿‚æ€§ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            translationRecipes = null;
          } else {
            console.error('ç¿»è¨³ãƒ¬ã‚·ãƒ”å–å¾—ã‚¨ãƒ©ãƒ¼:', translationRecipeError);
            translationRecipes = null;
          }
        } else {
          translationRecipes = translationRecipesData;
        }
        console.log('ç¿»è¨³ãƒ¬ã‚·ãƒ”å–å¾—çµæœ:', { translationRecipes, translationRecipeError });
        if (translationRecipes && translationRecipes.length > 0) {
          console.log('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:', translationRecipes[0]);
        } else {
          console.log('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å¤ã„ç¿»è¨³ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ã‚‚å–å¾—
        const { data: translations, error: translationError } = await sb
          .from('recipe_translations')
          .select('translated_title, language_code, html_content')
          .eq('recipe_id', id);
        
        console.log('ç¿»è¨³å–å¾—çµæœ:', { translations, translationError });
        
        // ç¿»è¨³ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆ
        if (translationRecipes && translationRecipes.length > 0) {
          const translationRecipe = translationRecipes[0];
          console.log('ç¿»è¨³ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º:', translationRecipe);
          console.log('ç¿»è¨³ãƒ¬ã‚·ãƒ”ã®è¨€èªã‚³ãƒ¼ãƒ‰:', translationRecipe.language_code);
          console.log('ç¿»è¨³ææ–™ãƒ‡ãƒ¼ã‚¿:', translationRecipe.translation_recipe_ingredients);
          console.log('ç¿»è¨³æ‰‹é †ãƒ‡ãƒ¼ã‚¿:', translationRecipe.translation_recipe_steps);
          
          // ç¿»è¨³ææ–™ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const { data: translationIngredients, error: ingredientsError } = await sb
            .from('translation_recipe_ingredients')
            .select('*')
            .eq('translation_recipe_id', translationRecipe.id)
            .order('position', { ascending: true });
          
          // ç¿»è¨³æ‰‹é †ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const { data: translationSteps, error: stepsError } = await sb
            .from('translation_recipe_steps')
            .select('*')
            .eq('translation_recipe_id', translationRecipe.id)
            .order('position', { ascending: true });
          
          // ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ
          translationRecipe.translation_recipe_ingredients = translationIngredients || [];
          translationRecipe.translation_recipe_steps = translationSteps || [];
          
          // ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¿»è¨³ç‰ˆã«å¤‰æ›´
          if (translationRecipe.translated_title) {
            titleEl.textContent = translationRecipe.translated_title;
            
            // ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«è¦ç´ ã«å…ƒã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤º
            const translatedTitleEl = document.getElementById('translatedTitle');
            if (translatedTitleEl) {
              const flagEmoji = getFlagEmoji(translationRecipe.language_code);
              translatedTitleEl.innerHTML = `
                <span class="original-text">ï¼ˆ${translationRecipe.original_title}ï¼‰</span>
                <span class="flag-emoji">${flagEmoji}</span>
              `;
              translatedTitleEl.style.display = 'block';
            }
          }
          
          // èª¬æ˜ã‚’ç¿»è¨³ç‰ˆã«å¤‰æ›´
          if (translationRecipe.translated_description) {
            const notesEl = document.getElementById('notes');
            if (notesEl) {
              notesEl.innerHTML = `
                <div class="translated-description">
                  <div class="translated-text">${translationRecipe.translated_description}</div>
                  <div class="original-text">ï¼ˆ${translationRecipe.original_description}ï¼‰</div>
                </div>
              `;
            }
          }
          
          // ç¿»è¨³ã•ã‚ŒãŸææ–™ã‚’è¡¨ç¤º
          if (translationRecipe.translation_recipe_ingredients && translationRecipe.translation_recipe_ingredients.length > 0) {
            console.log('ç¿»è¨³ææ–™ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºä¸­:', translationRecipe.translation_recipe_ingredients);
            const ingredientsEl = document.getElementById('ingredients');
            if (ingredientsEl) {
              // å…ƒã®ææ–™ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆç¿»è¨³ç‰ˆã¨ä½µè¨˜ã™ã‚‹ãŸã‚ï¼‰
              let originalIngredientsHTML = '';
              try {
                const { data: originalIngredients } = await sb
                  .from('recipe_ingredients')
                  .select('*')
                  .eq('recipe_id', id)
                  .order('position', { ascending: true });
                
                if (originalIngredients && originalIngredients.length > 0) {
                  const translations = uiTranslations[translationRecipe.language_code] || {};
                  originalIngredientsHTML = `
                    <div style="overflow-x: auto; width: 100%;">
                      <table class="table">
                        <thead>
                          <tr>
                            <th>${translations.number || 'ç•ªå·'}</th>
                            <th>${translations.ingredient_name || 'ææ–™å'}</th>
                            <th>${translations.quantity || 'åˆ†é‡'}</th>
                            <th>${translations.unit || 'å˜ä½'}</th>
                          </tr>
                        </thead>
                        <tbody>
                          ${originalIngredients.map(ing => `
                            <tr>
                              <td>${ing.position}</td>
                              <td>${ing.item}</td>
                              <td>${ing.quantity}</td>
                              <td>${ing.unit}</td>
                            </tr>
                          `).join('')}
                        </tbody>
                      </table>
                    </div>
                  `;
                }
              } catch (error) {
                console.warn('å…ƒã®ææ–™ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
              }
              
              const translations = uiTranslations[translationRecipe.language_code] || {};
              const translatedIngredientsHTML = `
                <div class="translated-section">
                  <h4>${translations.ingredients || 'Ingredients'}</h4>
                  <div style="overflow-x: auto; width: 100%;">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>${translations.number || 'ç•ªå·'}</th>
                          <th>${translations.ingredient_name || 'ææ–™å'}</th>
                          <th>${translations.quantity || 'åˆ†é‡'}</th>
                          <th>${translations.unit || 'å˜ä½'}</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${translationRecipe.translation_recipe_ingredients.map(ing => `
                          <tr>
                            <td>${ing.position}</td>
                            <td>${ing.translated_item || ''}</td>
                            <td>${ing.quantity || ''}</td>
                            <td>${ing.unit || ''}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                  ${originalIngredientsHTML ? `
                    <div class="original-section">
                      <h5>${translations.original_ingredients || 'å…ƒã®ææ–™'}</h5>
                      ${originalIngredientsHTML}
                    </div>
                  ` : ''}
                </div>
              `;
              ingredientsEl.innerHTML = translatedIngredientsHTML;
            }
          }
          
          // ç¿»è¨³ã•ã‚ŒãŸæ‰‹é †ã‚’è¡¨ç¤º
          if (translationRecipe.translation_recipe_steps && translationRecipe.translation_recipe_steps.length > 0) {
            const stepsEl = document.getElementById('steps');
            if (stepsEl) {
              // å…ƒã®æ‰‹é †ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆç¿»è¨³ç‰ˆã¨ä½µè¨˜ã™ã‚‹ãŸã‚ï¼‰
              let originalStepsHTML = '';
              try {
                const { data: originalSteps } = await sb
                  .from('recipe_steps')
                  .select('*')
                  .eq('recipe_id', id)
                  .order('position', { ascending: true });
                
                if (originalSteps && originalSteps.length > 0) {
                  originalStepsHTML = `
                    <ol>
                      ${originalSteps.map(step => `
                        <li>${step.instruction || step.step || step.description || step.body || ''}</li>
                      `).join('')}
                    </ol>
                  `;
                }
              } catch (error) {
                console.warn('å…ƒã®æ‰‹é †ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
              }
              
              const translations = uiTranslations[translationRecipe.language_code] || {};
              const translatedStepsHTML = `
                <div class="translated-section">
                  <h4>${translations.instructions || 'Instructions'}</h4>
                  <ol>
                    ${translationRecipe.translation_recipe_steps.map(step => `
                      <li>${step.translated_instruction || ''}</li>
                    `).join('')}
                  </ol>
                  ${originalStepsHTML ? `
                    <div class="original-section">
                      <h5>${translations.original_instructions || 'å…ƒã®ä½œã‚Šæ–¹'}</h5>
                      ${originalStepsHTML}
                    </div>
                  ` : ''}
                </div>
              `;
              stepsEl.innerHTML = translatedStepsHTML;
            }
          }
          
          // UIè¦ç´ ã‚’ç¿»è¨³
          if (translationRecipe.language_code) {
            console.log('UIè¦ç´ ã‚’ç¿»è¨³ä¸­:', translationRecipe.language_code);
            translateUI(translationRecipe.language_code);
          }
        }
        // ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        else if (translationError) {
          if (translationError.code === 'PGRST116' || translationError.message.includes('relation "recipe_translations" does not exist')) {
            console.log('recipe_translationsãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚ç¿»è¨³æ©Ÿèƒ½ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚');
            console.log('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã™ã‚‹ã«ã¯ã€fix_recipe_translations_error.sqlã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
          } else if (translationError.code === 'PGRST205' || translationError.message.includes('column') || translationError.status === 400) {
            console.log('recipe_translationsãƒ†ãƒ¼ãƒ–ãƒ«ã®æ§‹é€ ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ç¿»è¨³æ©Ÿèƒ½ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚');
            console.log('ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          } else {
            console.error('ç¿»è¨³å–å¾—ã‚¨ãƒ©ãƒ¼:', translationError);
          }
        } else if (translations && translations.length > 0) {
          const translation = translations[0];
          console.log('è¡¨ç¤ºã™ã‚‹ç¿»è¨³:', translation);
          const translatedTitleEl = document.getElementById('translatedTitle');
          if (translatedTitleEl) {
            // HTMLå½¢å¼ã®ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
            if (translation.html_content) {
              translatedTitleEl.innerHTML = translation.html_content;
            } else {
              // é€šå¸¸ã®ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º
              const flagEmoji = getFlagEmoji(translation.language_code);
              translatedTitleEl.innerHTML = `${translation.translated_title} <span class="flag-emoji">${flagEmoji}</span>`;
            }
            translatedTitleEl.style.display = 'block';
            console.log('ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤º:', translation.translated_title);
          } else {
            console.error('translatedTitleè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
          
          // UIè¦ç´ ã‚’ç¿»è¨³
          if (translation.language_code) {
            console.log('UIè¦ç´ ã‚’ç¿»è¨³ä¸­:', translation.language_code);
            translateUI(translation.language_code);
          }
        } else {
          console.log('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        }
      } catch (translationError) {
        console.error('ç¿»è¨³å–å¾—ã‚¨ãƒ©ãƒ¼:', translationError);
        translationRecipes = null; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ãªã—ã¨ã—ã¦æ‰±ã†
        if (translationError.message && translationError.message.includes('recipe_translations')) {
          console.log('recipe_translationsãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
        }
      }
      
      const dt = r.updated_at || r.created_at;
      metaEl.textContent = dt ? `æ›´æ–°: ${new Date(dt).toLocaleString()}` : '';

      // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã‚¿ã‚°ã®è¡¨ç¤º
      const categoryDisplay = document.getElementById('categoryDisplay');
      const categoryText = document.getElementById('categoryText');
      const tagsDisplay = document.getElementById('tagsDisplay');
      const tagsContainer = document.getElementById('tagsContainer');
      
      // ã‚«ãƒ†ã‚´ãƒªãƒ¼è¡¨ç¤º
      if (r.category && r.category.trim()) {
        categoryText.textContent = r.category;
        categoryDisplay.style.display = 'inline-block';
      } else {
        categoryDisplay.style.display = 'none';
      }
      
      // ã‚¿ã‚°è¡¨ç¤ºï¼ˆå€‹åˆ¥ãƒãƒƒã‚¸ï¼‰
      const tags = Array.isArray(r.tags) ? r.tags : (r.tags ? String(r.tags).split(/[,\s]+/).filter(Boolean) : []);
      if (tags && tags.length > 0) {
        tagsContainer.innerHTML = tags.map(tag => 
          `<span style="background: #f3e5f5; color: #7b1fa2; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; font-weight: 500; white-space: nowrap;">${escapeHtml(tag)}</span>`
        ).join('');
        tagsDisplay.style.display = 'block';
      } else {
        tagsDisplay.style.display = 'none';
      }

      tagsEl.innerHTML = (tags||[]).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('');
      notesEl.textContent = r.notes || '';
      
      // source_urlè¡¨ç¤ºå‡¦ç†
      const sourceUrlSection = document.getElementById('sourceUrlSection');
      const sourceUrlLink = document.getElementById('sourceUrlLink');
      const sourceUrlText = document.getElementById('sourceUrlText');
      if (r.source_url && r.source_url.trim()) {
        sourceUrlLink.href = r.source_url;
        sourceUrlText.textContent = r.source_url;
        sourceUrlSection.style.display = 'block';
      } else {
        sourceUrlSection.style.display = 'none';
      }
      
      // ãƒ¬ã‚·ãƒ”ç”»åƒã®è¡¨ç¤º
      const recipeImageContainer = document.getElementById('recipeImageContainer');
      const recipeImage = document.getElementById('recipeImage');
      console.log('ğŸ” ç”»åƒãƒ‡ãƒ¼ã‚¿ç¢ºèª:', { 
        hasImageUrl: !!r.image_url, 
        imageUrlLength: r.image_url ? r.image_url.length : 0,
        imageUrlStart: r.image_url ? r.image_url.substring(0, 50) + '...' : 'none'
      });
      
      if (r.image_url && r.image_url.trim()) {
        recipeImage.src = r.image_url;
        recipeImageContainer.style.display = 'flex';
        console.log('ğŸ“¸ ãƒ¬ã‚·ãƒ”ç”»åƒã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
      } else {
        recipeImageContainer.style.display = 'none';
        console.warn('âš ï¸ ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      }

      // ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ã¿é€šå¸¸ã®ææ–™è¡¨ç¤ºå‡¦ç†ã‚’å®Ÿè¡Œ
      if (!translationRecipes || translationRecipes.length === 0) {
        console.log('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ãªã— - é€šå¸¸ã®ææ–™è¡¨ç¤ºå‡¦ç†ã‚’å®Ÿè¡Œ');
        try{
          const { data: ings, error: e1 } = await sb.from('recipe_ingredients').select('*').eq('recipe_id', id).order('position', {ascending:true}).order('id', {ascending:true});
          if(!e1 && ings?.length){
            // åˆ—åã‚’æ—¥æœ¬èªã«ãƒãƒƒãƒ”ãƒ³ã‚°
            const columnMapping = {
              'position': 'ç•ªå·',
              'item': 'ææ–™å',
              'quantity': 'åˆ†é‡',
              'unit': 'å˜ä½',
              'price': 'ä¾¡æ ¼',
              'html_content': 'HTMLå½¢å¼'
            };
            
            const cols = ['position', 'item', 'quantity', 'unit'].filter(k => ings[0].hasOwnProperty(k));
            const thead = `<thead><tr>${cols.map(c=>`<th>${escapeHtml(columnMapping[c] || c)}</th>`).join('')}</tr></thead>`;
            const tbody = `<tbody>${ings.map(row=>`<tr>${cols.map(c=>`<td>${escapeHtml(row[c])}</td>`).join('')}</tr>`).join('')}</tbody>`;
            ingEl.innerHTML = `<div style="overflow-x: auto; width: 100%;"><table class="table">${thead}${tbody}</table></div>`;
          }else{
            ingEl.innerHTML = '<div class="muted">æœªç™»éŒ²</div>';
          }
        }catch(_){
          ingEl.innerHTML = '<div class="muted">æœªç™»éŒ²</div>';
        }
      }

      // ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ã¿é€šå¸¸ã®æ‰‹é †è¡¨ç¤ºå‡¦ç†ã‚’å®Ÿè¡Œ
      if (!translationRecipes || translationRecipes.length === 0) {
        try{
          const { data: steps, error: e2 } = await sb.from('recipe_steps').select('*').eq('recipe_id', id).order('position', {ascending:true}).order('id', {ascending:true});
          if(!e2 && steps?.length){
            stepsEl.innerHTML = steps.map(s=>`<li>${escapeHtml(s.instruction || s.step || s.description || s.body || '')}</li>`).join('');
          }else{
            stepsEl.innerHTML = '<li class="muted">æœªç™»éŒ²</li>';
          }
        }catch(_){
          stepsEl.innerHTML = '<li class="muted">æœªç™»éŒ²</li>';
        }
      }

      await refreshFavState();
    }


    load();
  }catch(e){
    console.error(e);
  }
})();


// ç¿»è¨³æ©Ÿèƒ½
let currentTranslatedData = null;


// ç¿»è¨³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®åˆ¶å¾¡
function showTranslatePopup() {
  console.log('ç¿»è¨³ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º');
  document.getElementById('translatePopup').style.display = 'block';
}

function closeTranslatePopup() {
  document.getElementById('translatePopup').style.display = 'none';
}

function showTranslateLoading() {
  document.getElementById('translateLoading').style.display = 'block';
}

function hideTranslateLoading() {
  document.getElementById('translateLoading').style.display = 'none';
}

// ç¿»è¨³é–‹å§‹é–¢æ•°
async function startTranslation(language) {
  console.log('ç¿»è¨³é–‹å§‹:', language);
  
  // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤º
  closeTranslatePopup();
  showTranslateLoading();
  
  // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å›é¿ã®ãŸã‚å°‘ã—å¾…æ©Ÿ
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  try {
    // ç¾åœ¨ã®ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
    const recipeData = {
      title: document.getElementById('recipeTitle').textContent,
      description: document.getElementById('notes')?.textContent || '',
      ingredients: Array.from(document.querySelectorAll('#ingredients .table tbody tr')).map(row => {
        const cells = row.querySelectorAll('td');
        return {
          position: cells[0]?.textContent || '',
          item: cells[1]?.textContent || '',
          quantity: cells[2]?.textContent || '',
          unit: cells[3]?.textContent || ''
        };
      }),
      steps: Array.from(document.querySelectorAll('#steps li')).map((step, index) => {
        const text = step.textContent || '';
        return { number: index + 1, text };
      })
    };
    
    console.log('åé›†ã—ãŸãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿:', recipeData);
    console.log('èª¬æ˜æ–‡ã®é•·ã•:', recipeData.description.length);
    console.log('ææ–™æ•°:', recipeData.ingredients.length);
    console.log('æ‰‹é †æ•°:', recipeData.steps.length);
    console.log('æ‰‹é †ãƒ‡ãƒ¼ã‚¿:', recipeData.steps);
    
    // AIç¿»è¨³ã‚’å®Ÿè¡Œ
    const translatedData = await translateRecipe(recipeData, language);
    currentTranslatedData = translatedData;
    
    console.log('ç¿»è¨³çµæœ:', translatedData);
    console.log('ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«:', translatedData.title);
    console.log('ç¿»è¨³èª¬æ˜:', translatedData.description);
    
    console.log('ç¿»è¨³ææ–™æ•°:', translatedData.ingredients ? translatedData.ingredients.length : 0);
    console.log('ç¿»è¨³æ‰‹é †æ•°:', translatedData.steps ? translatedData.steps.length : 0);
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºã«ã—ã¦ç¿»è¨³çµæœã‚’è¡¨ç¤º
    hideTranslateLoading();
    await showTranslatedResult(translatedData, language);
    
  } catch (error) {
    console.error('ç¿»è¨³ã‚¨ãƒ©ãƒ¼:', error);
    hideTranslateLoading();
    
    let errorMessage = 'ç¿»è¨³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
    if (error.message.includes('429')) {
      errorMessage = 'ç¿»è¨³APIã®åˆ©ç”¨åˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
    } else if (error.message.includes('API')) {
      errorMessage = 'ç¿»è¨³APIã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
    }
    
    alert(errorMessage);
  }
}


// UIè¦ç´ ã‚’ç¿»è¨³ã™ã‚‹é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰
function translateUI(language) {
  const translations = uiTranslations[language];
  if (!translations) return;
  
  // ææ–™ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¿»è¨³
  const ingredientsTitle = document.querySelector('aside h3');
  if (ingredientsTitle && ingredientsTitle.textContent.includes('ææ–™')) {
    ingredientsTitle.textContent = translations.ingredients;
  }
  
  // æ‰‹é †ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¿»è¨³
  const stepsTitle = document.querySelector('aside h3:nth-of-type(2)');
  if (stepsTitle && stepsTitle.textContent.includes('æ‰‹é †')) {
    stepsTitle.textContent = translations.steps;
  }
  
  // ç¿»è¨³ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¿»è¨³
  const translatedInstructions = document.querySelector('.translated-section h4');
  if (translatedInstructions) {
    translatedInstructions.textContent = `${translations.instructions} (${translations.instructions})`;
  }
  
  // å…ƒã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¿»è¨³
  const originalInstructions = document.querySelector('.original-section h5');
  if (originalInstructions) {
    originalInstructions.textContent = translations.original_instructions;
  }
  
  // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç¿»è¨³
  const tableHeaders = document.querySelectorAll('table thead th');
  tableHeaders.forEach(header => {
    const text = header.textContent.trim();
    if (text === 'ç•ªå·') {
      header.textContent = translations.number || 'ç•ªå·';
    } else if (text === 'ææ–™å') {
      header.textContent = translations.ingredient_name || 'ææ–™å';
    } else if (text === 'åˆ†é‡') {
      header.textContent = translations.quantity || 'åˆ†é‡';
    } else if (text === 'å˜ä½') {
      header.textContent = translations.unit || 'å˜ä½';
    }
  });
}

// ãƒ¬ã‚·ãƒ”ç¿»è¨³é–¢æ•°
async function translateRecipe(recipeData, targetLanguage) {
  const languageNames = {
    'fr': 'ãƒ•ãƒ©ãƒ³ã‚¹èª',
    'it': 'ã‚¤ã‚¿ãƒªã‚¢èª',
    'zh': 'ä¸­å›½èª',
    'es': 'ã‚¹ãƒšã‚¤ãƒ³èª',
    'de': 'ãƒ‰ã‚¤ãƒ„èª',
    'en': 'è‹±èª'
  };
  
  const languageName = languageNames[targetLanguage];
  
  const prompt = `ä»¥ä¸‹ã®ãƒ¬ã‚·ãƒ”ã‚’${languageName}ã«ç¿»è¨³ã—ã¦ãã ã•ã„ã€‚æ–™ç†åã€ææ–™ã€æ‰‹é †ã™ã¹ã¦ã‚’è‡ªç„¶ã§é©åˆ‡ãª${languageName}ã«ç¿»è¨³ã—ã¦ãã ã•ã„ã€‚

æ–™ç†å: ${recipeData.title}
èª¬æ˜: ${recipeData.description}

ææ–™:
${recipeData.ingredients.map(ing => `${ing.position}. ${ing.item} ${ing.quantity} ${ing.unit}`).join('\n')}

ä½œã‚Šæ–¹:
${recipeData.steps.map(step => `${step.number}. ${step.text}`).join('\n')}

é‡è¦: å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚èª¬æ˜ã‚„è¿½åŠ ã®ãƒ†ã‚­ã‚¹ãƒˆã€Markdownè¨˜å·ï¼ˆ\`\`\`ãªã©ï¼‰ã¯ä¸€åˆ‡å«ã‚ãªã„ã§ãã ã•ã„ã€‚ç´”ç²‹ãªJSONã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚

æ–™ç†åã¯å¿…ãš${languageName}ã§ç¿»è¨³ã—ã¦ãã ã•ã„ã€‚æ—¥æœ¬èªã®ã¾ã¾ã«ã—ãªã„ã§ãã ã•ã„ã€‚

{
  "title": "ç¿»è¨³ã•ã‚ŒãŸæ–™ç†åï¼ˆ${languageName}ï¼‰",
  "description": "ç¿»è¨³ã•ã‚ŒãŸèª¬æ˜",
  "ingredients": [
    {"position": "ç•ªå·", "item": "ææ–™å", "quantity": "åˆ†é‡", "unit": "å˜ä½"}
  ],
  "steps": [
    {"number": "ç•ªå·", "text": "æ‰‹é †"}
  ]
}`;

  const { data, error } = await sb.functions.invoke('call-groq-api', {
    body: {
      prompt,
      model: 'llama-3.1-8b-instant',
      maxTokens: 2000,
      temperature: 0.3
    }
  });

  if (error || !data?.success) {
    throw new Error(`ç¿»è¨³API ã‚¨ãƒ©ãƒ¼: ${data?.error || error?.message || 'unknown'}`);
  }

  const translatedText = data.content?.trim();
  
  if (!translatedText) {
    throw new Error('ç¿»è¨³çµæœãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
  }

  console.log('ç¿»è¨³ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', translatedText);
  console.log('ç¿»è¨³ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®é•·ã•:', translatedText.length);

  try {
    // Markdownå½¢å¼ã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’é™¤å»
    let cleanText = translatedText;
    if (cleanText.includes('```json+')) {
      cleanText = cleanText.replace(/```json\+?\s*/, '');
    }
    if (cleanText.includes('```')) {
      cleanText = cleanText.replace(/```\s*$/, '');
    }
    
    // JSONå½¢å¼ã®éƒ¨åˆ†ã‚’æŠ½å‡º
    const jsonMatch = cleanText.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      console.log('JSONå½¢å¼ã§ç¿»è¨³çµæœã‚’è§£æ:', jsonMatch[0]);
      try {
        const parsed = JSON.parse(jsonMatch[0]);
        console.log('è§£æã•ã‚ŒãŸç¿»è¨³ãƒ‡ãƒ¼ã‚¿:', parsed);
        console.log('è§£æã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«:', parsed.title);
        return parsed;
      } catch (parseError) {
        console.error('JSONè§£æã‚¨ãƒ©ãƒ¼:', parseError);
        console.log('ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆ:', translatedText);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ‰‹å‹•ã§æ§‹é€ åŒ–
        return parseTranslatedTextManually(cleanText);
      }
    } else {
      console.log('JSONå½¢å¼ã§ã¯ãªã„ãŸã‚ã€æ‰‹å‹•ã§æ§‹é€ åŒ–');
    // JSONå½¢å¼ã§ãªã„å ´åˆã¯ã€æ‰‹å‹•ã§æ§‹é€ åŒ–
    const lines = translatedText.split('\n').filter(line => line.trim());
    const result = {
      title: lines[0] || 'ç¿»è¨³ã•ã‚ŒãŸæ–™ç†å',
      description: lines.slice(1, 3).join(' ') || 'ç¿»è¨³ã•ã‚ŒãŸèª¬æ˜',
      ingredients: [],
      steps: []
    };
    console.log('æ‰‹å‹•æ§‹é€ åŒ–ã®çµæœ:', result);
      
      // ææ–™ã¨æ‰‹é †ã‚’æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
      let currentSection = '';
      lines.forEach(line => {
        if (line.includes('ææ–™') || line.includes('ingredients')) {
          currentSection = 'ingredients';
        } else if (line.includes('ä½œã‚Šæ–¹') || line.includes('æ‰‹é †') || line.includes('steps')) {
          currentSection = 'steps';
        } else if (currentSection === 'ingredients' && /^\d+\./.test(line)) {
          const parts = line.split(/[\s\t]+/);
          result.ingredients.push({
            position: parts[0].replace('.', ''),
            item: parts.slice(1, -2).join(' '),
            quantity: parts[parts.length - 2] || '',
            unit: parts[parts.length - 1] || ''
          });
        } else if (currentSection === 'steps' && /^\d+\./.test(line)) {
          result.steps.push({
            number: line.match(/^\d+/)[0],
            text: line.replace(/^\d+\.\s*/, '')
          });
        }
      });
      
      return result;
    }
  } catch (parseError) {
    console.error('JSONè§£æã‚¨ãƒ©ãƒ¼:', parseError);
    console.error('ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆ:', translatedText);
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬çš„ãªæ§‹é€ ã‚’è¿”ã™
    return {
      title: translatedText.split('\n')[0] || 'ç¿»è¨³ã•ã‚ŒãŸæ–™ç†å',
      description: 'ç¿»è¨³ã•ã‚ŒãŸèª¬æ˜',
      ingredients: [],
      steps: []
    };
  }
}

// ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ‰‹å‹•ã§æ§‹é€ åŒ–ã™ã‚‹é–¢æ•°
function parseTranslatedTextManually(text) {
  console.log('æ‰‹å‹•ã§ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹é€ åŒ–:', text);
  
  try {
    // ã¾ãšã€ä¸å®Œå…¨ãªJSONã‚’ä¿®æ­£ã—ã¦ã¿ã‚‹
    let fixedText = text;
    
    // ä¸å®Œå…¨ãªJSONã®ä¿®æ­£
    if (fixedText.includes('"ingredients": [')) {
      // ingredientsé…åˆ—ã®çµ‚äº†ã‚’ç¢ºèª
      if (!fixedText.includes(']')) {
        fixedText += ']';
      }
    }
    if (fixedText.includes('"steps": [')) {
      // stepsé…åˆ—ã®çµ‚äº†ã‚’ç¢ºèª
      if (!fixedText.includes(']')) {
        fixedText += ']';
      }
    }
    
    // æœ€å¾Œã®}ã‚’ç¢ºèª
    if (!fixedText.includes('}')) {
      fixedText += '}';
    }
    
    // ä¿®æ­£ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã§JSONè§£æã‚’è©¦è¡Œ
    const jsonMatch = fixedText.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      try {
        const parsed = JSON.parse(jsonMatch[0]);
        console.log('ä¿®æ­£ã•ã‚ŒãŸJSONè§£ææˆåŠŸ:', parsed);
        return parsed;
      } catch (e) {
        console.log('ä¿®æ­£ã•ã‚ŒãŸJSONã§ã‚‚è§£æå¤±æ•—:', e);
      }
    }
  } catch (e) {
    console.log('JSONä¿®æ­£å¤±æ•—:', e);
  }
  
  // å®Œå…¨ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: åŸºæœ¬çš„ãªæ§‹é€ ã‚’è¿”ã™
  return {
    title: 'ç¿»è¨³ã•ã‚ŒãŸæ–™ç†å',
    description: 'ç¿»è¨³ã•ã‚ŒãŸèª¬æ˜',
    ingredients: [],
    steps: []
  };
}

// ç¿»è¨³çµæœè¡¨ç¤º
async function showTranslatedResult(translatedData, language) {
  console.log('showTranslatedResult called with:', { translatedData, language });
  console.log('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã®ã‚¿ã‚¤ãƒˆãƒ«:', translatedData.title);
  console.log('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿å…¨ä½“:', JSON.stringify(translatedData, null, 2));
  
  const flagEmoji = getFlagEmoji(language);
  
  // ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤º
  const translatedTitleEl = document.getElementById('translatedTitle');
  console.log('translatedTitleEl found:', !!translatedTitleEl);
  if (translatedTitleEl) {
    // å…ƒã®ãƒ¬ã‚·ãƒ”ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—
    const originalTitle = document.getElementById('recipeTitle')?.textContent?.trim() || '';
    console.log('å…ƒã®ã‚¿ã‚¤ãƒˆãƒ«:', originalTitle);
    console.log('ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«:', translatedData.title);
    
    // ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã§ãªã„å ´åˆã®ã¿è¡¨ç¤º
    if (translatedData.title && translatedData.title.trim() && translatedData.title !== 'ç¿»è¨³ã•ã‚ŒãŸæ–™ç†å') {
      // ãƒ¡ã‚¤ãƒ³ã®æ–™ç†åã‚‚ç¿»è¨³ç‰ˆã«ç½®ãæ›ãˆ
      const mainTitleEl = document.getElementById('recipeTitle');
      if (mainTitleEl) {
        mainTitleEl.textContent = translatedData.title;
        console.log('ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¿»è¨³ç‰ˆã«ç½®ãæ›ãˆã¾ã—ãŸ:', translatedData.title);
      }
      
      // ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«è¦ç´ ã«ã¯å…ƒã®æ—¥æœ¬èªã‚’è¡¨ç¤º
      translatedTitleEl.innerHTML = `
        <span class="original-text">ï¼ˆ${originalTitle}ï¼‰</span>
        <span class="flag-emoji">${flagEmoji}</span>
      `;
      translatedTitleEl.style.display = 'block';
      console.log('ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ:', translatedData.title);
    } else {
      console.log('ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®ãŸã‚è¡¨ç¤ºã—ã¾ã›ã‚“');
      translatedTitleEl.style.display = 'none';
    }
  }
  
  // ç¿»è¨³èª¬æ˜æ–‡ã‚’è¡¨ç¤º
  if (translatedData.description && translatedData.description.trim()) {
    const notesEl = document.getElementById('notes');
    if (notesEl) {
      const originalDescription = notesEl.textContent || '';
      notesEl.innerHTML = `
        <div class="translated-description">
          <div class="translated-text">${translatedData.description}</div>
          <div class="original-text">ï¼ˆ${originalDescription}ï¼‰</div>
        </div>
      `;
    }
  }
  
  // ç¿»è¨³ææ–™ã‚’è¡¨ç¤º
  console.log('ç¿»è¨³ææ–™ãƒ‡ãƒ¼ã‚¿:', translatedData.ingredients);
  if (translatedData.ingredients && translatedData.ingredients.length > 0) {
    const ingredientsEl = document.getElementById('ingredients');
    console.log('ingredientsEl found:', !!ingredientsEl);
    if (ingredientsEl) {
      const originalIngredients = ingredientsEl.innerHTML;
      const translations = uiTranslations[language] || {};
      const translatedIngredientsHTML = `
        <div class="translated-section">
          <h4>${translations.ingredients || 'Ingredients'}</h4>
          <div style="overflow-x: auto; width: 100%;">
            <table class="table">
              <thead>
                <tr>
                  <th>${translations.number || 'ç•ªå·'}</th>
                  <th>${translations.ingredient_name || 'ææ–™å'}</th>
                  <th>${translations.quantity || 'åˆ†é‡'}</th>
                  <th>${translations.unit || 'å˜ä½'}</th>
                </tr>
              </thead>
              <tbody>
                ${translatedData.ingredients.map(ing => {
                  const position = ing.position || '';
                  const item = ing.item || '';
                  const quantity = ing.quantity || '';
                  const unit = ing.unit || '';
                  return `
                    <tr>
                      <td>${position === 'false' ? '' : position}</td>
                      <td>${item === 'false' ? '' : item}</td>
                      <td>${quantity === 'false' ? '' : quantity}</td>
                      <td>${unit === 'false' ? '' : unit}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
          <div class="original-section">
            <h5>${translations.original_ingredients || 'å…ƒã®ææ–™'}</h5>
            ${originalIngredients}
          </div>
        </div>
      `;
      ingredientsEl.innerHTML = translatedIngredientsHTML;
    }
  }
  
  // ç¿»è¨³æ‰‹é †ã‚’è¡¨ç¤º
  console.log('ç¿»è¨³æ‰‹é †ãƒ‡ãƒ¼ã‚¿:', translatedData.steps);
  if (translatedData.steps && translatedData.steps.length > 0) {
    const stepsEl = document.getElementById('steps');
    console.log('stepsEl found:', !!stepsEl);
    if (stepsEl) {
      const originalSteps = stepsEl.innerHTML;
      const translations = uiTranslations[language] || {};
      const translatedStepsHTML = `
        <div class="translated-section">
          <h4>${translations.instructions || 'Instructions'}</h4>
          <ol>
            ${translatedData.steps.map(step => {
              const instruction = step.instruction || step.text || '';
              return `<li>${instruction === 'false' ? '' : instruction}</li>`;
            }).join('')}
          </ol>
          <div class="original-section">
            <h5>${translations.original_instructions || 'å…ƒã®ä½œã‚Šæ–¹'}</h5>
            ${originalSteps}
          </div>
        </div>
      `;
      stepsEl.innerHTML = translatedStepsHTML;
    }
  }
  
  // UIè¦ç´ ã‚’ç¿»è¨³
  translateUI(language);
  
  // ç¿»è¨³å®Œäº† - è‡ªå‹•çš„ã«ç¿»è¨³ç‰ˆã‚’ä¿å­˜
  console.log('ç¿»è¨³è¡¨ç¤ºå®Œäº†ã€‚è‡ªå‹•çš„ã«ç¿»è¨³ç‰ˆã‚’ä¿å­˜ã—ã¾ã™ã€‚');
  
  // è‡ªå‹•çš„ã«ç¿»è¨³ç‰ˆã‚’ä¿å­˜
  try {
    await saveTranslatedRecipe(translatedData, false);
    console.log('ç¿»è¨³ç‰ˆã‚’è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ');
  } catch (error) {
    console.error('ç¿»è¨³ç‰ˆè‡ªå‹•ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    alert('ç¿»è¨³ç‰ˆã®è‡ªå‹•ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// è‡ªå‹•ç¿»è¨³é–¢æ•°ï¼ˆè¨€èªã‚¿ã‚°ã‹ã‚‰ç¿»è¨³ã‚’å®Ÿè¡Œï¼‰
async function autoTranslateRecipe(targetLanguage) {
  console.log('è‡ªå‹•ç¿»è¨³ã‚’é–‹å§‹:', targetLanguage);
  
  try {
    // ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const { data: translationRecipes, error } = await sb
      .from('translation_recipes')
      .select('*')
      .eq('original_recipe_id', window.originalRecipeId)
      .eq('language_code', targetLanguage)
      .order('created_at', { ascending: false })
      .limit(1);
    
    if (error) {
      console.error('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      return;
    }
    
    if (!translationRecipes || translationRecipes.length === 0) {
      console.log('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚é€šå¸¸è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚');
      return;
    }
    
    const translationRecipe = translationRecipes[0];
    console.log('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã‚’ç™ºè¦‹:', translationRecipe);
    
    // ç¿»è¨³ææ–™ã¨æ‰‹é †ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const { data: translationIngredients } = await sb
      .from('translation_recipe_ingredients')
      .select('*')
      .eq('translation_recipe_id', translationRecipe.id)
      .order('position', { ascending: true });
    
    const { data: translationSteps } = await sb
      .from('translation_recipe_steps')
      .select('*')
      .eq('translation_recipe_id', translationRecipe.id)
      .order('position', { ascending: true });
    
    // ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆ
    translationRecipe.translation_recipe_ingredients = translationIngredients || [];
    translationRecipe.translation_recipe_steps = translationSteps || [];
    
    // ç¿»è¨³è¡¨ç¤ºã‚’å®Ÿè¡Œ
    await displayTranslatedRecipe(translationRecipe);
    
  } catch (error) {
    console.error('è‡ªå‹•ç¿»è¨³ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// ç¿»è¨³ãƒ¬ã‚·ãƒ”ã®è¡¨ç¤ºé–¢æ•°
async function displayTranslatedRecipe(translationRecipe) {
  console.log('ç¿»è¨³ãƒ¬ã‚·ãƒ”ã‚’è¡¨ç¤ºä¸­:', translationRecipe);
  
  // ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç¿»è¨³ç‰ˆã«å¤‰æ›´
  const titleEl = document.getElementById('recipeTitle');
  if (titleEl && translationRecipe.translated_title) {
    titleEl.textContent = translationRecipe.translated_title;
    
    // ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«è¦ç´ ã«å…ƒã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤º
    const translatedTitleEl = document.getElementById('translatedTitle');
    if (translatedTitleEl) {
      const flagEmoji = getFlagEmoji(translationRecipe.language_code);
      translatedTitleEl.innerHTML = `
        <span class="original-text">ï¼ˆ${translationRecipe.original_title}ï¼‰</span>
        <span class="flag-emoji">${flagEmoji}</span>
      `;
      translatedTitleEl.style.display = 'block';
    }
  }
  
  // èª¬æ˜ã‚’ç¿»è¨³ç‰ˆã«å¤‰æ›´
  if (translationRecipe.translated_description) {
    const notesEl = document.getElementById('notes');
    if (notesEl) {
      notesEl.innerHTML = `
        <div class="translated-description">
          <div class="translated-text">${translationRecipe.translated_description}</div>
          <div class="original-text">ï¼ˆ${translationRecipe.original_description}ï¼‰</div>
        </div>
      `;
    }
  }
  
  // ç¿»è¨³ã•ã‚ŒãŸææ–™ã‚’è¡¨ç¤º
  if (translationRecipe.translation_recipe_ingredients && translationRecipe.translation_recipe_ingredients.length > 0) {
    const ingredientsEl = document.getElementById('ingredients');
    if (ingredientsEl) {
      // å…ƒã®ææ–™ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆç¿»è¨³ç‰ˆã¨ä½µè¨˜ã™ã‚‹ãŸã‚ï¼‰
      let originalIngredientsHTML = '';
      try {
        const { data: originalIngredients } = await sb
          .from('recipe_ingredients')
          .select('*')
          .eq('recipe_id', window.originalRecipeId)
          .order('position', { ascending: true });
        
        if (originalIngredients && originalIngredients.length > 0) {
          const translations = uiTranslations[translationRecipe.language_code] || {};
          originalIngredientsHTML = `
            <div style="overflow-x: auto; width: 100%;">
              <table class="table">
                <thead>
                  <tr>
                    <th>${translations.number || 'ç•ªå·'}</th>
                    <th>${translations.ingredient_name || 'ææ–™å'}</th>
                    <th>${translations.quantity || 'åˆ†é‡'}</th>
                    <th>${translations.unit || 'å˜ä½'}</th>
                  </tr>
                </thead>
                <tbody>
                  ${originalIngredients.map(ing => `
                    <tr>
                      <td>${ing.position}</td>
                      <td>${ing.item}</td>
                      <td>${ing.quantity}</td>
                      <td>${ing.unit}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
      } catch (error) {
        console.warn('å…ƒã®ææ–™ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }
      
      const translations = uiTranslations[translationRecipe.language_code] || {};
      const translatedIngredientsHTML = `
        <div class="translated-section">
          <h4>${translations.ingredients || 'Ingredients'}</h4>
          <div style="overflow-x: auto; width: 100%;">
            <table class="table">
              <thead>
                <tr>
                  <th>${translations.number || 'ç•ªå·'}</th>
                  <th>${translations.ingredient_name || 'ææ–™å'}</th>
                  <th>${translations.quantity || 'åˆ†é‡'}</th>
                  <th>${translations.unit || 'å˜ä½'}</th>
                </tr>
              </thead>
              <tbody>
                ${translationRecipe.translation_recipe_ingredients.map(ing => `
                  <tr>
                    <td>${ing.position}</td>
                    <td>${ing.translated_item || ''}</td>
                    <td>${ing.quantity || ''}</td>
                    <td>${ing.unit || ''}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          ${originalIngredientsHTML ? `
            <div class="original-section">
              <h5>${translations.original_ingredients || 'å…ƒã®ææ–™'}</h5>
              ${originalIngredientsHTML}
            </div>
          ` : ''}
        </div>
      `;
      ingredientsEl.innerHTML = translatedIngredientsHTML;
    }
  }
  
  // ç¿»è¨³ã•ã‚ŒãŸæ‰‹é †ã‚’è¡¨ç¤º
  if (translationRecipe.translation_recipe_steps && translationRecipe.translation_recipe_steps.length > 0) {
    const stepsEl = document.getElementById('steps');
    if (stepsEl) {
      // å…ƒã®æ‰‹é †ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆç¿»è¨³ç‰ˆã¨ä½µè¨˜ã™ã‚‹ãŸã‚ï¼‰
      let originalStepsHTML = '';
      try {
        const { data: originalSteps } = await sb
          .from('recipe_steps')
          .select('*')
          .eq('recipe_id', window.originalRecipeId)
          .order('position', { ascending: true });
        
        if (originalSteps && originalSteps.length > 0) {
          originalStepsHTML = `
            <ol>
              ${originalSteps.map(step => `
                <li>${step.instruction || step.step || step.description || step.body || ''}</li>
              `).join('')}
            </ol>
          `;
        }
      } catch (error) {
        console.warn('å…ƒã®æ‰‹é †ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }
      
      const translations = uiTranslations[translationRecipe.language_code] || {};
      const translatedStepsHTML = `
        <div class="translated-section">
          <h4>${translations.instructions || 'Instructions'}</h4>
          <ol>
            ${translationRecipe.translation_recipe_steps.map(step => `
              <li>${step.translated_instruction || ''}</li>
            `).join('')}
          </ol>
          ${originalStepsHTML ? `
            <div class="original-section">
              <h5>${translations.original_instructions || 'å…ƒã®ä½œã‚Šæ–¹'}</h5>
              ${originalStepsHTML}
            </div>
          ` : ''}
        </div>
      `;
      stepsEl.innerHTML = translatedStepsHTML;
    }
  }
  
  // UIè¦ç´ ã‚’ç¿»è¨³
  if (translationRecipe.language_code) {
    console.log('UIè¦ç´ ã‚’ç¿»è¨³ä¸­:', translationRecipe.language_code);
    translateUI(translationRecipe.language_code);
  }
  
  console.log('è‡ªå‹•ç¿»è¨³è¡¨ç¤ºå®Œäº†');
}

// è¨€èªã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¦é€šå¸¸è¡¨ç¤ºã«æˆ»ã™é–¢æ•°
async function resetToOriginalLanguage() {
  try {
    const currentRecipeId = window.originalRecipeId || new URLSearchParams(window.location.search).get('id');
    const { data: originalRecipe } = await sb.from('recipes').select('tags').eq('id', currentRecipeId).single();
    
    if (originalRecipe?.tags) {
      // ç¿»è¨³ã‚¿ã‚°ã‚’å‰Šé™¤
      const filteredTags = originalRecipe.tags.filter(tag => !tag.startsWith('ç¿»è¨³:'));
      
      await sb.from('recipes')
        .update({ tags: filteredTags })
        .eq('id', currentRecipeId);
      
      console.log('è¨€èªã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      
      // ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦é€šå¸¸è¡¨ç¤ºã«æˆ»ã™
      location.reload();
    }
  } catch (error) {
    console.error('è¨€èªã‚¿ã‚°å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
  }
}

// ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ã¨å…ƒã®æ—¥æœ¬èªã‚’åˆ†é›¢ã—ã¦ä¿å­˜ï¼ˆæ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ï¼‰
async function saveCombinedRecipe(translatedData, language) {
  // å…ƒã®ãƒ¬ã‚·ãƒ”IDã‚’å–å¾—ï¼ˆç¿»è¨³å‰ã®IDï¼‰
  const originalRecipeId = window.originalRecipeId || new URLSearchParams(window.location.search).get('id');
  console.log('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ä¿å­˜ä¸­ - å…ƒã®ãƒ¬ã‚·ãƒ”ID:', originalRecipeId);
  console.log('window.originalRecipeId:', window.originalRecipeId);
  console.log('URL param id:', new URLSearchParams(window.location.search).get('id'));
  
  if (!originalRecipeId) {
    console.error('ç¿»è¨³ãƒ‡ãƒ¼ã‚¿ä¿å­˜: originalRecipeIdãŒå–å¾—ã§ãã¾ã›ã‚“');
    return;
  }
  
  // å…ƒã®ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const originalTitle = document.getElementById('recipeTitle')?.textContent?.trim() || '';
  const originalDescription = document.getElementById('notes')?.textContent?.trim() || '';
  
  // å…ƒã®ææ–™ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const originalIngredients = Array.from(document.querySelectorAll('#ingredients .table tbody tr')).map(row => {
    const cells = row.querySelectorAll('td');
    return {
      position: cells[0]?.textContent || '',
      item: cells[1]?.textContent || '',
      quantity: cells[2]?.textContent || '',
      unit: cells[3]?.textContent || ''
    };
  });
  
  // å…ƒã®æ‰‹é †ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const originalSteps = Array.from(document.querySelectorAll('#steps .step')).map(step => {
    const number = step.querySelector('.step-number')?.textContent || '';
    const text = step.querySelector('.step-text')?.textContent || '';
    return { number, text };
  });
  
  // å…ƒã®ãƒ¬ã‚·ãƒ”ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã‚¿ã‚°ã‚’å–å¾—
  console.log('å…ƒã®ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­ - ID:', originalRecipeId);
  if (!originalRecipeId) {
    console.error('originalRecipeIdãŒnullã§ã™');
    return;
  }
  const { data: originalRecipe } = await sb.from('recipes').select('category, tags').eq('id', originalRecipeId).single();
  
  // ç¿»è¨³ãƒ¬ã‚·ãƒ”ãƒ¡ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
  const translationRecipeData = {
    original_recipe_id: originalRecipeId,
    translated_title: translatedData.title,
    original_title: originalTitle,
    translated_description: translatedData.description,
    original_description: originalDescription,
    language_code: language,
    category: originalRecipe?.category || 'ç¿»è¨³ãƒ¬ã‚·ãƒ”',
    tags: [...(originalRecipe?.tags || []), 'ç¿»è¨³', 'å¤šè¨€èª'],
    servings: 4
  };
  
  console.log('ç¿»è¨³ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿:', translationRecipeData);
  
  // ç¿»è¨³ãƒ¬ã‚·ãƒ”ã‚’ä¿å­˜
  console.log('ç¿»è¨³ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ä¸­:', translationRecipeData);
  const { data: translationResult, error: translationError } = await sb
    .from('translation_recipes')
    .insert(translationRecipeData)
    .select()
    .single();
    
  if (translationError) {
    console.error('ç¿»è¨³ãƒ¬ã‚·ãƒ”ä¿å­˜ã‚¨ãƒ©ãƒ¼:', translationError);
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’ä½¿ç”¨
    await saveCombinedRecipeFallback(translatedData, language, originalTitle, originalDescription, originalIngredients, originalSteps);
    return;
  }
  
  console.log('ç¿»è¨³ãƒ¬ã‚·ãƒ”ä¿å­˜æˆåŠŸ:', translationResult);
  
  const translationRecipeId = translationResult.id;
  
  // å…ƒã®ãƒ¬ã‚·ãƒ”ã«ç¿»è¨³è¨€èªã‚¿ã‚°ã‚’è¿½åŠ 
  try {
    console.log('è¨€èªã‚¿ã‚°è¿½åŠ ä¸­ - ID:', originalRecipeId);
    if (!originalRecipeId) {
      console.error('è¨€èªã‚¿ã‚°è¿½åŠ : originalRecipeIdãŒnullã§ã™');
      return;
    }
    const { data: originalRecipe } = await sb.from('recipes').select('tags').eq('id', originalRecipeId).single();
    const currentTags = originalRecipe?.tags || [];
    const languageTag = `ç¿»è¨³:${language}`;
    
    // æ—¢å­˜ã®ç¿»è¨³ã‚¿ã‚°ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ã‚¿ã‚°ã‚’è¿½åŠ 
    const filteredTags = currentTags.filter(tag => !tag.startsWith('ç¿»è¨³:'));
    const newTags = [...filteredTags, languageTag];
    
    await sb.from('recipes')
      .update({ tags: newTags })
      .eq('id', originalRecipeId);
    
    console.log('å…ƒã®ãƒ¬ã‚·ãƒ”ã«è¨€èªã‚¿ã‚°ã‚’è¿½åŠ :', languageTag);
  } catch (error) {
    console.warn('è¨€èªã‚¿ã‚°è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
  }
  
  // ç¿»è¨³ææ–™ã‚’ä¿å­˜
  if (translatedData.ingredients && translatedData.ingredients.length > 0) {
    try {
      const translationIngredients = translatedData.ingredients.map((ing, index) => ({
        translation_recipe_id: translationRecipeId,
        position: index + 1,
        translated_item: ing.item || '',
        original_item: originalIngredients[index]?.item || '',
        quantity: ing.quantity || originalIngredients[index]?.quantity || '',
        unit: ing.unit || originalIngredients[index]?.unit || '',
        price: null
      }));
      
      const { error: ingredientsError } = await sb
        .from('translation_recipe_ingredients')
        .insert(translationIngredients);
        
      if (ingredientsError) {
        console.warn('ç¿»è¨³ææ–™ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', ingredientsError.message);
      }
    } catch (error) {
      console.warn('ç¿»è¨³ææ–™ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', error);
    }
  }
  
  // ç¿»è¨³æ‰‹é †ã‚’ä¿å­˜
  if (translatedData.steps && translatedData.steps.length > 0) {
    try {
      const translationSteps = translatedData.steps.map((step, index) => ({
        translation_recipe_id: translationRecipeId,
        position: index + 1,
        translated_instruction: step.text || '',
        original_instruction: originalSteps[index]?.text || ''
      }));
      
      const { error: stepsError } = await sb
        .from('translation_recipe_steps')
        .insert(translationSteps);
        
      if (stepsError) {
        console.warn('ç¿»è¨³æ‰‹é †ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', stepsError.message);
      }
    } catch (error) {
      console.warn('ç¿»è¨³æ‰‹é †ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', error);
    }
  }
}

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’ä½¿ç”¨
async function saveCombinedRecipeFallback(translatedData, language, originalTitle, originalDescription, originalIngredients, originalSteps) {
  console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’ä½¿ç”¨');
  
  const currentRecipeId = new URLSearchParams(window.location.search).get('id');
  
  // å…ƒã®ãƒ¬ã‚·ãƒ”ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã‚¿ã‚°ã‚’å–å¾—
  const { data: originalRecipe } = await sb.from('recipes').select('category, tags').eq('id', currentRecipeId).single();
  
  // æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã§ä¿å­˜
  const combinedRecipeData = {
    title: `${translatedData.title} ï¼ˆ${originalTitle}ï¼‰`,
    notes: `ç¿»è¨³ç‰ˆ:\n${translatedData.description}\n\nå…ƒã®æ—¥æœ¬èªç‰ˆ:\n${originalDescription}`,
    category: originalRecipe?.category || 'ç¿»è¨³ãƒ¬ã‚·ãƒ”',
    tags: [...(originalRecipe?.tags || []), 'ç¿»è¨³', 'å¤šè¨€èª'],
    servings: 4
  };
  
  const { data: recipeResult, error: recipeError } = await sb
    .from('recipes')
    .insert(combinedRecipeData)
    .select()
    .single();
    
  if (recipeError) {
    throw new Error('ãƒ¬ã‚·ãƒ”ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + recipeError.message);
  }
  
  const newRecipeId = recipeResult.id;
  
  // ææ–™ã¨æ‰‹é †ã®ä¿å­˜ï¼ˆæ—¢å­˜ã®æ§‹é€ ï¼‰
  // ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾ä½¿ç”¨
}

// è¡¨ç¤ºå½¢å¼ãã®ã¾ã¾ä¿å­˜ï¼ˆHTMLå½¢å¼ï¼‰
async function saveDisplayFormatRecipe(translatedData, language) {
  const currentRecipeId = new URLSearchParams(window.location.search).get('id');
  
  // å…ƒã®ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  const originalTitle = document.getElementById('recipeTitle')?.textContent?.trim() || '';
  const originalDescription = document.getElementById('notes')?.textContent?.trim() || '';
  
  // ç¾åœ¨ã®è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹HTMLã‚’å–å¾—
  const translatedTitleHTML = document.getElementById('translatedTitle')?.innerHTML || '';
  const notesHTML = document.getElementById('notes')?.innerHTML || '';
  const ingredientsHTML = document.getElementById('ingredients')?.innerHTML || '';
  const stepsHTML = document.getElementById('steps')?.innerHTML || '';
  
  // è¡¨ç¤ºå½¢å¼ãã®ã¾ã¾ã®ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
  const displayFormatData = {
    title: `${translatedData.title} ï¼ˆ${originalTitle}ï¼‰`,
    notes: notesHTML, // ç¿»è¨³è¡¨ç¤ºã•ã‚ŒãŸHTMLã‚’ãã®ã¾ã¾ä¿å­˜
    category: 'ç¿»è¨³ãƒ¬ã‚·ãƒ”',
    tags: ['ç¿»è¨³', 'å¤šè¨€èª', 'HTMLå½¢å¼'],
    servings: 4,
    display_format: 'html', // HTMLå½¢å¼ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
    language_code: language,
    original_recipe_id: currentRecipeId
  };
  
  console.log('è¡¨ç¤ºå½¢å¼ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿:', displayFormatData);
  
  // ãƒ¬ã‚·ãƒ”ã‚’ä¿å­˜
  const { data: recipeResult, error: recipeError } = await sb
    .from('recipes')
    .insert(displayFormatData)
    .select()
    .single();
    
  if (recipeError) {
    throw new Error('ãƒ¬ã‚·ãƒ”ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + recipeError.message);
  }
  
  const newRecipeId = recipeResult.id;
  
  // ææ–™ã‚’HTMLå½¢å¼ã§ä¿å­˜ï¼ˆç¿»è¨³ç‰ˆã¨å…ƒã®æ—¥æœ¬èªç‰ˆã®ä¸¡æ–¹ï¼‰
  if (ingredientsHTML) {
    try {
      // ç¿»è¨³ç‰ˆã®ææ–™ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å„è¡Œã‚’æŠ½å‡º
      const translatedIngredientRows = Array.from(document.querySelectorAll('#ingredients .translated-section .table tbody tr'));
      const originalIngredientRows = Array.from(document.querySelectorAll('#ingredients .original-section .table tbody tr'));
      
      // ç¿»è¨³ç‰ˆã®ææ–™ã‚’ä¿å­˜
      const translatedIngredientsData = translatedIngredientRows.map((row, index) => {
        const cells = row.querySelectorAll('td');
        return {
          recipe_id: newRecipeId,
          position: index + 1,
          item: cells[1]?.textContent || '',
          quantity: cells[2]?.textContent || '',
          unit: cells[3]?.textContent || '',
          price: null,
          html_content: row.outerHTML // HTMLå½¢å¼ã‚‚ä¿å­˜
        };
      });
      
      // å…ƒã®æ—¥æœ¬èªç‰ˆã®ææ–™ã‚’ä¿å­˜ï¼ˆä½ç½®ã‚’ãšã‚‰ã™ï¼‰
      const originalIngredientsData = originalIngredientRows.map((row, index) => {
        const cells = row.querySelectorAll('td');
        return {
          recipe_id: newRecipeId,
          position: translatedIngredientRows.length + index + 1,
          item: cells[1]?.textContent || '',
          quantity: cells[2]?.textContent || '',
          unit: cells[3]?.textContent || '',
          price: cells[4]?.textContent || null,
          html_content: row.outerHTML // HTMLå½¢å¼ã‚‚ä¿å­˜
        };
      });
      
      // ä¸¡æ–¹ã®ææ–™ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆã—ã¦ä¿å­˜
      const allIngredientsData = [...translatedIngredientsData, ...originalIngredientsData];
      
      const { error: ingredientsError } = await sb
        .from('recipe_ingredients')
        .insert(allIngredientsData);
        
      if (ingredientsError) {
        console.warn('ææ–™ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', ingredientsError.message);
      }
    } catch (error) {
      console.warn('ææ–™ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', error);
    }
  }
  
  // æ‰‹é †ã‚’HTMLå½¢å¼ã§ä¿å­˜ï¼ˆç¿»è¨³ç‰ˆã¨å…ƒã®æ—¥æœ¬èªç‰ˆã®ä¸¡æ–¹ï¼‰
  if (stepsHTML) {
    try {
      // ç¿»è¨³ç‰ˆã®æ‰‹é †ã‹ã‚‰å„ã‚¹ãƒ†ãƒƒãƒ—ã‚’æŠ½å‡º
      const translatedStepElements = Array.from(document.querySelectorAll('#steps .translated-section ol li'));
      const originalStepElements = Array.from(document.querySelectorAll('#steps .original-section ol li'));
      
      // ç¿»è¨³ç‰ˆã®æ‰‹é †ã‚’ä¿å­˜
      const translatedStepsData = translatedStepElements.map((step, index) => {
        return {
          recipe_id: newRecipeId,
          position: index + 1,
          instruction: step.textContent || '',
          html_content: step.outerHTML // HTMLå½¢å¼ã‚‚ä¿å­˜
        };
      });
      
      // å…ƒã®æ—¥æœ¬èªç‰ˆã®æ‰‹é †ã‚’ä¿å­˜ï¼ˆä½ç½®ã‚’ãšã‚‰ã™ï¼‰
      const originalStepsData = originalStepElements.map((step, index) => {
        return {
          recipe_id: newRecipeId,
          position: translatedStepElements.length + index + 1,
          instruction: step.textContent || '',
          html_content: step.outerHTML // HTMLå½¢å¼ã‚‚ä¿å­˜
        };
      });
      
      // ä¸¡æ–¹ã®æ‰‹é †ãƒ‡ãƒ¼ã‚¿ã‚’çµåˆã—ã¦ä¿å­˜
      const allStepsData = [...translatedStepsData, ...originalStepsData];
      
      const { error: stepsError } = await sb
        .from('recipe_steps')
        .insert(allStepsData);
        
      if (stepsError) {
        console.warn('æ‰‹é †ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', stepsError.message);
      }
    } catch (error) {
      console.warn('æ‰‹é †ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', error);
    }
  }
  
  // ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«ã‚‚ä¿å­˜
  if (translatedTitleHTML) {
    try {
      await sb.from('recipe_translations').insert({
        recipe_id: newRecipeId,
        language_code: language,
        translated_title: translatedData.title,
        html_content: translatedTitleHTML // HTMLå½¢å¼ã‚‚ä¿å­˜
      });
    } catch (error) {
      console.warn('ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', error);
    }
  }
}

// ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ä¿å­˜
async function saveTranslatedTitle(translatedTitle, language) {
  const currentRecipeId = new URLSearchParams(window.location.search).get('id');
  
  if (!currentRecipeId) {
    throw new Error('ãƒ¬ã‚·ãƒ”IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }
  
  try {
    // æ—¢å­˜ã®ç¿»è¨³ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ç¿»è¨³ã‚’æŒ¿å…¥
    await sb.from('recipe_translations').delete().eq('recipe_id', currentRecipeId);
    await sb.from('recipe_translations').insert({
      recipe_id: currentRecipeId,
      language_code: language,
      translated_title: translatedTitle
    });
  } catch (error) {
    console.error('ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    throw error;
  }
}


// ç¿»è¨³ãƒ¬ã‚·ãƒ”ä¿å­˜é–¢æ•°
async function saveTranslatedRecipe(translatedData, saveBoth = false) {
  const currentRecipeId = new URLSearchParams(window.location.search).get('id');
  
  // å…ƒã®ãƒ¬ã‚·ãƒ”ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã‚¿ã‚°ã‚’å–å¾—
  const { data: originalRecipe } = await sb.from('recipes').select('category, tags').eq('id', currentRecipeId).single();
  
  // ç¿»è¨³ç‰ˆã®ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
  const recipeData = {
    title: translatedData.title,
    notes: translatedData.description, // descriptionã§ã¯ãªãnotesã‚’ä½¿ç”¨
    category: originalRecipe?.category || 'ç¿»è¨³ãƒ¬ã‚·ãƒ”', // å…ƒã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ç¶™æ‰¿
    tags: [...(originalRecipe?.tags || []), 'ç¿»è¨³'], // å…ƒã®ã‚¿ã‚°ã«ç¿»è¨³ã‚¿ã‚°ã‚’è¿½åŠ 
    servings: 4 // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  };
  
  // ãƒ¬ã‚·ãƒ”ã‚’ä¿å­˜
  const { data: recipeResult, error: recipeError } = await sb
    .from('recipes')
    .insert(recipeData)
    .select()
    .single();
    
  if (recipeError) {
    throw new Error('ãƒ¬ã‚·ãƒ”ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + recipeError.message);
  }
  
  const newRecipeId = recipeResult.id;
  console.log('ç¿»è¨³ãƒ¬ã‚·ãƒ”ä¿å­˜æˆåŠŸ:', recipeResult);
  
  // ææ–™ã‚’ä¿å­˜
  if (translatedData.ingredients && translatedData.ingredients.length > 0) {
    try {
      const ingredientsData = translatedData.ingredients.map((ing, index) => ({
        recipe_id: newRecipeId,
        position: ing.position || (index + 1),
        item: ing.item || '',
        quantity: ing.quantity || '',
        unit: ing.unit || '',
        price: null // ç¿»è¨³ãƒ¬ã‚·ãƒ”ã§ã¯ä¾¡æ ¼ã¯è¨­å®šã—ãªã„
      }));
      
      const { error: ingredientsError } = await sb
        .from('recipe_ingredients')
        .insert(ingredientsData);
        
      if (ingredientsError) {
        console.warn('ææ–™ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', ingredientsError.message);
        console.warn('ææ–™ãƒ‡ãƒ¼ã‚¿:', ingredientsData);
        // ææ–™ä¿å­˜ã‚¨ãƒ©ãƒ¼ã¯è­¦å‘Šã¨ã—ã¦è¨˜éŒ²ã™ã‚‹ãŒã€å‡¦ç†ã‚’ç¶šè¡Œ
      }
    } catch (error) {
      console.warn('ææ–™ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', error);
    }
  }
  
  // æ‰‹é †ã‚’ä¿å­˜
  if (translatedData.steps && translatedData.steps.length > 0) {
    try {
      const stepsData = translatedData.steps.map((step, index) => ({
        recipe_id: newRecipeId,
        position: step.number || (index + 1),
        instruction: step.text || '' // textã§ã¯ãªãinstructionã‚’ä½¿ç”¨
      }));
      
      const { error: stepsError } = await sb
        .from('recipe_steps')
        .insert(stepsData);
        
      if (stepsError) {
        console.warn('æ‰‹é †ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', stepsError.message);
        console.warn('æ‰‹é †ãƒ‡ãƒ¼ã‚¿:', stepsData);
        // æ‰‹é †ä¿å­˜ã‚¨ãƒ©ãƒ¼ã¯è­¦å‘Šã¨ã—ã¦è¨˜éŒ²ã™ã‚‹ãŒã€å‡¦ç†ã‚’ç¶šè¡Œ
      }
    } catch (error) {
      console.warn('æ‰‹é †ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', error);
    }
  }
  
  // å…ƒã®ãƒ¬ã‚·ãƒ”ã®ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«ã‚‚æ›´æ–°ï¼ˆsaveBothã®å ´åˆï¼‰
  if (saveBoth && currentRecipeId) {
    try {
      const language = document.getElementById('translateLanguage')?.value || 'fr';
      
      // æ—¢å­˜ã®ç¿»è¨³ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ç¿»è¨³ã‚’æŒ¿å…¥
      await sb.from('recipe_translations').delete().eq('recipe_id', currentRecipeId);
      await sb.from('recipe_translations').insert({
        recipe_id: currentRecipeId,
        language_code: language,
        translated_title: translatedData.title
      });
    } catch (error) {
      console.warn('ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', error);
      // ç¿»è¨³ã‚¿ã‚¤ãƒˆãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼ã¯è­¦å‘Šã¨ã—ã¦è¨˜éŒ²ã™ã‚‹ãŒã€å‡¦ç†ã‚’ç¶šè¡Œ
    }
    
    // å…ƒã®ãƒ¬ã‚·ãƒ”ã«ã‚‚ç¿»è¨³ã‚¿ã‚°ã‚’è¿½åŠ 
    try {
      const { data: originalRecipe } = await sb.from('recipes').select('tags').eq('id', currentRecipeId).single();
      if (originalRecipe && originalRecipe.tags) {
        const updatedTags = [...originalRecipe.tags];
        if (!updatedTags.includes('ç¿»è¨³')) {
          updatedTags.push('ç¿»è¨³');
        }
        if (!updatedTags.includes('å¤šè¨€èª')) {
          updatedTags.push('å¤šè¨€èª');
        }
        
        await sb.from('recipes').update({ tags: updatedTags }).eq('id', currentRecipeId);
        console.log('å…ƒã®ãƒ¬ã‚·ãƒ”ã«ç¿»è¨³ã‚¿ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.warn('å…ƒã®ãƒ¬ã‚·ãƒ”ã‚¿ã‚°æ›´æ–°ã§ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰:', error);
    }
  }
}

// ===== PDF/CSVå‡ºåŠ›æ©Ÿèƒ½ =====

// æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿é–¢æ•°ï¼ˆæ”¹è‰¯ç‰ˆï¼‰
async function loadJapaneseFont(doc) {
  return new Promise((resolve) => {
    try {
      // æ—¥æœ¬èªå¯¾å¿œãƒ•ã‚©ãƒ³ãƒˆã®è¨­å®š
      // ã¾ãšã€åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚©ãƒ³ãƒˆã‚’ç¢ºèª
      const availableFonts = doc.getFontList();
      console.log('åˆ©ç”¨å¯èƒ½ãªãƒ•ã‚©ãƒ³ãƒˆ:', availableFonts);
      
      // æ—¥æœ¬èªå¯¾å¿œã®ãƒ•ã‚©ãƒ³ãƒˆã‚’è©¦ã™
      const japaneseFonts = ['NotoSansJP', 'NotoSerifJP', 'HiraginoSans', 'YuGothic', 'Meiryo'];
      let fontSet = false;
      
      for (const fontName of japaneseFonts) {
        if (availableFonts[fontName]) {
          doc.setFont(fontName);
          console.log(`æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆè¨­å®šå®Œäº†: ${fontName}`);
          fontSet = true;
          break;
        }
      }
      
      if (!fontSet) {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã€æ—¥æœ¬èªæ–‡å­—ã‚’å®‰å…¨ã«å‡¦ç†
        doc.setFont('helvetica');
        console.log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨ï¼ˆæ—¥æœ¬èªæ–‡å­—ã¯å®‰å…¨ã«å‡¦ç†ï¼‰');
      }
      
      resolve();
    } catch (error) {
      console.warn('ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
      doc.setFont('helvetica');
      resolve();
    }
  });
}

// HTMLã‹ã‚‰Canvasã‚’çµŒç”±ã—ã¦PDFã‚’ç”Ÿæˆï¼ˆæ—¥æœ¬èªå¯¾å¿œãƒ»æ”¹å–„ã•ã‚ŒãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ - æ–°ã—ã„V2é–¢æ•°ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
async function generatePDFFromHTML(doc, title, ingredients, steps, notes, imageUrl) {
  console.log('ğŸ”„ Old generatePDFFromHTML called, redirecting to V2');
  return await generatePDFFromHTMLV2(doc, title, ingredients, steps, notes, imageUrl);
}

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°ã¯ utils.js ã§å®šç¾©æ¸ˆã¿

// PDFå‡ºåŠ›æ©Ÿèƒ½
async function exportToPDF() {
  console.log('ğŸš€ PDFå‡ºåŠ›é–‹å§‹');
  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    console.log('âœ… jsPDFåˆæœŸåŒ–å®Œäº†');
    
    // æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆè¨­å®šï¼ˆæ–‡å­—åŒ–ã‘å›é¿ï¼‰
    // NotoSansJPãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨ï¼ˆGoogle Fontsã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
    try {
      // æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
      await loadJapaneseFont(doc);
    } catch (fontError) {
      console.warn('æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨:', fontError);
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚©ãƒ³ãƒˆã‚’ä½¿ç”¨
      doc.setFont('helvetica');
    }
    
    // ç¾åœ¨ã®ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const recipeTitle = document.getElementById('recipeTitle')?.textContent || 'ãƒ¬ã‚·ãƒ”';
    const recipeNotes = document.getElementById('notes')?.textContent || '';
    
    // ææ–™ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ˆã‚Šç¢ºå®Ÿã«å–å¾—ï¼ˆè¤‡æ•°ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’è©¦ã™ï¼‰
    const ingredients = [];
    
    // è¤‡æ•°ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã™ï¼ˆã‚ˆã‚ŠåŒ…æ‹¬çš„ï¼‰
    const ingredientSelectors = [
      '#ingredients .ingredient-row',
      '#ingredients tr',
      '#ingredients .table-row',
      '.ingredients-table tr',
      '.ingredients-table .ingredient-row',
      '.ingredients tr',
      '.ingredients .row',
      'table.ingredients tr',
      'table.ingredients .ingredient-row',
      '.recipe-ingredients tr',
      '.recipe-ingredients .ingredient-row',
      'table tr',
      '.table tr',
      'tbody tr',
      '.ingredient-row',
      '.ingredient-item',
      '.material-row',
      '.material-item'
    ];
    
    let ingredientRows = [];
    for (const selector of ingredientSelectors) {
      ingredientRows = document.querySelectorAll(selector);
      if (ingredientRows.length > 0) {
        console.log(`ææ–™ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ "${selector}" ã§ ${ingredientRows.length} è¡Œã‚’ç™ºè¦‹`);
        break;
      }
    }
    
    console.log('ææ–™è¡Œæ•°:', ingredientRows.length);
    
    // ææ–™ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®è¿½åŠ ãƒ‡ãƒãƒƒã‚°
    if (ingredientRows.length === 0) {
      console.warn('ææ–™ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åˆ©ç”¨å¯èƒ½ãªè¦ç´ ã‚’ç¢ºèªä¸­...');
      
      // ãƒšãƒ¼ã‚¸å†…ã®ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ã‚’ç¢ºèª
      const allTables = document.querySelectorAll('table');
      console.log('ãƒšãƒ¼ã‚¸å†…ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ•°:', allTables.length);
      
      allTables.forEach((table, index) => {
        const rows = table.querySelectorAll('tr');
        console.log(`ãƒ†ãƒ¼ãƒ–ãƒ«${index + 1}: ${rows.length}è¡Œ`);
        if (rows.length > 0) {
          console.log('æœ€åˆã®è¡Œ:', rows[0].textContent);
        }
      });
      
      // ææ–™é–¢é€£ã®è¦ç´ ã‚’ç¢ºèª
      const ingredientElements = document.querySelectorAll('[class*="ingredient"], [class*="material"], [id*="ingredient"], [id*="material"]');
      console.log('ææ–™é–¢é€£è¦ç´ æ•°:', ingredientElements.length);
      ingredientElements.forEach((el, index) => {
        console.log(`ææ–™é–¢é€£è¦ç´ ${index + 1}:`, el.className, el.id, el.textContent.substring(0, 50));
      });
    }
    
    ingredientRows.forEach((row, index) => {
      // ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’ç¢ºèªã—ã¦æ­£ã—ã„ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’ä½¿ç”¨
      const cells = row.querySelectorAll('td');
      console.log(`ææ–™è¡Œ${index + 1}ã®ã‚»ãƒ«æ•°:`, cells.length);
      
      if (cells.length >= 3) {
        // é€šå¸¸ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ : ææ–™å, åˆ†é‡, å˜ä½
        let item = cells[0] ? cells[0].textContent.trim() : '';
        const quantity = cells[1] ? cells[1].textContent.trim() : '';
        const unit = cells[2] ? cells[2].textContent.trim() : '';
        
        // ææ–™åã‹ã‚‰ç•ªå·ã‚’å‰Šé™¤ï¼ˆä¾‹: "1. ç”Ÿç‰¡è £" -> "ç”Ÿç‰¡è £"ï¼‰
        item = item.replace(/^\d+\.?\s*/, '').trim();
        
        // ææ–™åã«åˆ†é‡ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®å‡¦ç†ï¼ˆä¾‹: "ç”Ÿç‰¡è £6" -> item: "ç”Ÿç‰¡è £", quantity: "6"ï¼‰
        if (!quantity && !unit && item) {
          const itemMatch = item.match(/^(.+?)([0-9\/\.]+)$/);
          if (itemMatch) {
            item = itemMatch[1].trim();
            const extractedQuantity = itemMatch[2].trim();
            if (!quantity) quantity = extractedQuantity;
          }
        }
        
        console.log(`ææ–™${index + 1}:`, { item, quantity, unit });
        
        if (item) {
          ingredients.push({ item, quantity, unit });
        }
      } else if (cells.length === 2) {
        // 2ã‚»ãƒ«æ§‹é€ : ææ–™å, åˆ†é‡+å˜ä½
        let item = cells[0] ? cells[0].textContent.trim() : '';
        const amountText = cells[1] ? cells[1].textContent.trim() : '';
        
        // ææ–™åã‹ã‚‰ç•ªå·ã‚’å‰Šé™¤ï¼ˆä¾‹: "1. ç”Ÿç‰¡è £" -> "ç”Ÿç‰¡è £"ï¼‰
        item = item.replace(/^\d+\.?\s*/, '').trim();
        
        // åˆ†é‡ã¨å˜ä½ã‚’åˆ†é›¢
        let quantity = '', unit = '';
        if (amountText) {
          // æ•°å­—ã¨å˜ä½ã‚’åˆ†é›¢ï¼ˆä¾‹: "100g" -> quantity: "100", unit: "g"ï¼‰
          const match = amountText.match(/^([0-9\/\.]+)(.*)$/);
          if (match) {
            quantity = match[1];
            unit = match[2];
          } else {
            // åˆ†é›¢ã§ããªã„å ´åˆã¯å…¨ä½“ã‚’åˆ†é‡ã¨ã—ã¦æ‰±ã†
            quantity = amountText;
          }
        }
        
        console.log(`ææ–™${index + 1} (2ã‚»ãƒ«):`, { item, quantity, unit, original: amountText });
        
        if (item) {
          ingredients.push({ item, quantity, unit });
        }
      } else {
        // è¤‡æ•°ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã™ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        const itemSelectors = ['.ing-item', '.ingredient-name', '.item'];
        const quantitySelectors = ['.ing-quantity', '.quantity'];
        const unitSelectors = ['.ing-unit', '.unit'];
        
        let itemEl = null, quantityEl = null, unitEl = null;
        
        for (const selector of itemSelectors) {
          itemEl = row.querySelector(selector);
          if (itemEl) break;
        }
        
        for (const selector of quantitySelectors) {
          quantityEl = row.querySelector(selector);
          if (quantityEl) break;
        }
        
        for (const selector of unitSelectors) {
          unitEl = row.querySelector(selector);
          if (unitEl) break;
        }
        
        let item = itemEl ? itemEl.textContent.trim() : '';
        const quantity = quantityEl ? quantityEl.textContent.trim() : '';
        const unit = unitEl ? unitEl.textContent.trim() : '';
        
        // ææ–™åã‹ã‚‰ç•ªå·ã‚’å‰Šé™¤ï¼ˆä¾‹: "1. ç”Ÿç‰¡è £" -> "ç”Ÿç‰¡è £"ï¼‰
        item = item.replace(/^\d+\.?\s*/, '').trim();
        
        console.log(`ææ–™${index + 1} (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯):`, { item, quantity, unit });
        
        if (item) {
          ingredients.push({ item, quantity, unit });
        }
      }
    });
    
    // æ‰‹é †ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ˆã‚Šç¢ºå®Ÿã«å–å¾—ï¼ˆ<ol><li>æ§‹é€ ã«å¯¾å¿œï¼‰
    const steps = [];
    
    // <ol id="steps">å†…ã®<li>è¦ç´ ã‚’å–å¾—
    const stepElements = document.querySelectorAll('#steps li');
    console.log('æ‰‹é †è¦ç´ æ•°:', stepElements.length);
    
    stepElements.forEach((li, index) => {
      const stepText = li.textContent.trim();
      console.log(`æ‰‹é †${index + 1}:`, stepText);
      
      // "æœªç™»éŒ²"ã‚„ç©ºã®ãƒ†ã‚­ã‚¹ãƒˆã¯é™¤å¤–
      if (stepText && stepText !== 'æœªç™»éŒ²' && stepText.length > 0) {
        steps.push(stepText);
      }
    });
    
    console.log('å–å¾—ã—ãŸææ–™:', ingredients);
    console.log('å–å¾—ã—ãŸæ‰‹é †:', steps);
    
    // ææ–™ãŒå–å¾—ã§ããªã‹ã£ãŸå ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
    if (ingredients.length === 0) {
      console.warn('ææ–™ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚è¿½åŠ ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’è©¦ã—ã¾ã™...');
      
      // ã‚ˆã‚ŠåŸºæœ¬çš„ãªã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’è©¦ã™
      const fallbackSelectors = [
        'tr',
        'div[class*="ingredient"]',
        'div[class*="material"]',
        'li',
        'p',
        'span[class*="ingredient"]',
        'span[class*="material"]'
      ];
      
      for (const selector of fallbackSelectors) {
        const elements = document.querySelectorAll(selector);
        console.log(`ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ "${selector}": ${elements.length}å€‹ã®è¦ç´ `);
        
        elements.forEach((el, index) => {
          const text = el.textContent.trim();
          // ææ–™ã‚‰ã—ã„ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ•°å­—ã¨å˜ä½ãŒå«ã¾ã‚Œã¦ã„ã‚‹ï¼‰
          if (text && text.match(/[0-9]/) && text.match(/[a-zA-Z\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/) && text.length < 100) {
            console.log(`ææ–™å€™è£œ${index + 1}:`, text);
            
            // ææ–™åã¨åˆ†é‡ã‚’åˆ†é›¢
            const match = text.match(/^(.+?)([0-9\/\.]+)([a-zA-Z\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]*)$/);
            if (match) {
              const item = match[1].trim().replace(/^\d+\.?\s*/, '');
              const quantity = match[2].trim();
              const unit = match[3].trim();
              
              if (item && item.length > 0) {
                ingredients.push({ item, quantity, unit });
                console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§æŠ½å‡ºã—ãŸææ–™:', { item, quantity, unit });
              }
            }
          }
        });
        
        if (ingredients.length > 0) {
          console.log(`ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ "${selector}" ã§ææ–™ã‚’å–å¾—ã—ã¾ã—ãŸ`);
          break;
        }
      }
      
      // ãã‚Œã§ã‚‚ææ–™ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æ‰‹é †ã‹ã‚‰æŠ½å‡º
      if (ingredients.length === 0) {
        console.warn('æ‰‹é †ã‹ã‚‰ææ–™ã‚’æŠ½å‡ºã—ã¾ã™...');
        
        steps.forEach(step => {
          // æ‰‹é †ã‹ã‚‰ææ–™ã¨åˆ†é‡ã‚’æŠ½å‡ºï¼ˆä¾‹: "ãƒã‚¿ãƒ¼10g"ã€"ç”Ÿã‚¯ãƒªãƒ¼ãƒ 40ml"ï¼‰
          const materialMatches = step.match(/([^0-9\s]+)([0-9\/\.]+)([a-zA-Z\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+)/g);
          if (materialMatches) {
            materialMatches.forEach(match => {
              const parts = match.match(/([^0-9\s]+)([0-9\/\.]+)([a-zA-Z\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]+)/);
              if (parts && parts.length >= 4) {
                const item = parts[1].trim();
                const quantity = parts[2].trim();
                const unit = parts[3].trim();
                
                // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                const exists = ingredients.some(ing => ing.item === item);
                if (!exists && item.length > 0) {
                  ingredients.push({ item, quantity, unit });
                  console.log('æ‰‹é †ã‹ã‚‰æŠ½å‡ºã—ãŸææ–™:', { item, quantity, unit });
                }
              }
            });
          }
        });
      }
    }
    
    // æ”¹å–„ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã®PDFç”Ÿæˆï¼ˆæ–‡å­—åŒ–ã‘å›é¿ï¼‰
    let pdfContent = '';
    
    // ã‚¿ã‚¤ãƒˆãƒ«
    pdfContent += recipeTitle + '\n';
    pdfContent += '='.repeat(recipeTitle.length) + '\n\n';
    
    // ãƒ¡ãƒ¢
    if (recipeNotes) {
      pdfContent += 'ã€ãƒ¡ãƒ¢ãƒ»ã‚³ãƒ„ã€‘\n';
      pdfContent += recipeNotes + '\n\n';
    }
    
    // ææ–™ï¼ˆå˜ä½ã‚’æ­£ã—ãè¡¨ç¤ºã€é–“éš”ã‚’èª¿æ•´ã€ç•ªå·ãªã—ï¼‰
    pdfContent += 'ã€ææ–™ã€‘\n';
    pdfContent += '-'.repeat(40) + '\n';
    ingredients.forEach(ingredient => {
      const item = (ingredient.item || '').trim();
      const quantity = (ingredient.quantity || '').trim();
      const unit = (ingredient.unit || '').trim();
      
      // åˆ†é‡ã¨å˜ä½ã‚’é©åˆ‡ã«çµ„ã¿åˆã‚ã›ã¦è¡¨ç¤º
      let amount = '';
      if (quantity && unit) {
        amount = `${quantity}${unit}`;
      } else if (quantity) {
        amount = quantity;
      } else if (unit) {
        amount = unit;
      }
      
      // ææ–™åã¨åˆ†é‡ã®é–“ã«ååˆ†ãªé–“éš”ã‚’è¨­ã‘ã‚‹ï¼ˆç•ªå·ãªã—ï¼‰
      if (amount) {
        // ææ–™åã‚’å·¦å¯„ã›ã€åˆ†é‡ã‚’å³å¯„ã›ã§è¡¨ç¤ºï¼ˆã‚ˆã‚Šåºƒã„é–“éš”ï¼‰
        const maxItemLength = 35;
        const itemPadded = item.padEnd(maxItemLength, ' ');
        pdfContent += `ãƒ»${itemPadded} ${amount}\n`;
      } else {
        pdfContent += `ãƒ»${item}\n`;
      }
    });
    pdfContent += '\n';
    
    // ä½œã‚Šæ–¹
    pdfContent += 'ã€ä½œã‚Šæ–¹ã€‘\n';
    pdfContent += '-'.repeat(30) + '\n';
    steps.forEach((step, index) => {
      pdfContent += `${index + 1}. ${step}\n\n`;
    });
    
    // ç”»åƒURLã‚’å–å¾—ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ãŸãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’ç›´æ¥ä½¿ç”¨ï¼‰
    let imageUrl = null;
    
    // ç¾åœ¨ã®ãƒ¬ã‚·ãƒ”IDã‚’å–å¾—
    const currentRecipeId = new URLSearchParams(window.location.search).get('id');
    if (currentRecipeId) {
      try {
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¦image_urlã‚’å–å¾—
        const { data: recipeData } = await sb.from('recipes').select('image_url').eq('id', currentRecipeId).single();
        if (recipeData && recipeData.image_url && recipeData.image_url.trim()) {
          imageUrl = recipeData.image_url;
          console.log('ğŸ–¼ï¸ ãƒ¬ã‚·ãƒ”ç”»åƒURLç™ºè¦‹ (ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›´æ¥å–å¾—):', imageUrl);
        }
      } catch (error) {
        console.warn('âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ç”»åƒURLå–å¾—ã«å¤±æ•—:', error);
      }
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: DOMè¦ç´ ã‹ã‚‰å–å¾—
    if (!imageUrl) {
      const recipeImageElement = document.getElementById('recipeImage');
      if (recipeImageElement && recipeImageElement.src && recipeImageElement.src.trim()) {
        imageUrl = recipeImageElement.src;
        console.log('ğŸ–¼ï¸ ãƒ¬ã‚·ãƒ”ç”»åƒURLç™ºè¦‹ (DOMè¦ç´ å–å¾—):', imageUrl);
      }
    }
    
    if (!imageUrl) {
      console.log('ğŸ–¼ï¸ ãƒ¬ã‚·ãƒ”ç”»åƒURLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }
    
    // HTMLã‹ã‚‰Canvasã‚’çµŒç”±ã—ã¦PDFã‚’ç”Ÿæˆï¼ˆæ—¥æœ¬èªå¯¾å¿œï¼‰
    try {
      console.log('ğŸ”„ generatePDFFromHTMLV2å‘¼ã³å‡ºã—é–‹å§‹');
      await generatePDFFromHTMLV2(doc, recipeTitle, ingredients, steps, recipeNotes, imageUrl);
      console.log('âœ… generatePDFFromHTMLV2å®Œäº†');
    } catch (htmlError) {
      console.warn('HTML to PDFå¤‰æ›ã«å¤±æ•—ã€ãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:', htmlError);
      
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ã‚­ã‚¹ãƒˆãƒ™ãƒ¼ã‚¹ã®PDFç”Ÿæˆ
      doc.setFontSize(12);
      const lines = pdfContent.split('\n');
      let yPosition = 20;
      const lineHeight = 7;
      
      lines.forEach(line => {
        if (yPosition > 280) {
          doc.addPage();
          yPosition = 20;
        }
        
        // æ–‡å­—åŒ–ã‘ã‚’é˜²ããŸã‚ã€å®‰å…¨ãªæ–‡å­—ã®ã¿ã‚’ä½¿ç”¨
        const safeLine = line
          .replace(/[^\x20-\x7E\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\uFF00-\uFFEF]/g, '?') // æœªå¯¾å¿œæ–‡å­—ã‚’?ã«ç½®æ›
          .replace(/\s+/g, ' ') // é€£ç¶šã™ã‚‹ç©ºç™½ã‚’1ã¤ã«
          .trim(); // å‰å¾Œã®ç©ºç™½ã‚’å‰Šé™¤
        
        if (safeLine.length > 0) {
          try {
            // è¡ŒãŒé•·ã™ãã‚‹å ´åˆã¯åˆ†å‰²
            const maxLength = 80;
            if (safeLine.length > maxLength) {
              const words = safeLine.split(' ');
              let currentLine = '';
              
              words.forEach(word => {
                if ((currentLine + ' ' + word).length > maxLength) {
                  if (currentLine.length > 0) {
                    doc.text(currentLine, 20, yPosition);
                    yPosition += lineHeight;
                    if (yPosition > 280) {
                      doc.addPage();
                      yPosition = 20;
                    }
                  }
                  currentLine = word;
                } else {
                  currentLine += (currentLine.length > 0 ? ' ' : '') + word;
                }
              });
              
              if (currentLine.length > 0) {
                doc.text(currentLine, 20, yPosition);
                yPosition += lineHeight;
              }
            } else {
              doc.text(safeLine, 20, yPosition);
              yPosition += lineHeight;
            }
          } catch (error) {
            console.warn('PDFæ–‡å­—å‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error, 'è¡Œ:', safeLine);
            // ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          }
        } else {
          // ç©ºè¡Œã®å ´åˆã¯æ”¹è¡Œã®ã¿
          yPosition += lineHeight;
        }
      });
    }
    
    // ãƒ•ãƒƒã‚¿ãƒ¼
    const totalPages = doc.internal.getNumberOfPages();
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    
    for (let i = 1; i <= totalPages; i++) {
      doc.setPage(i);
      doc.setFontSize(8);
      doc.text(`ãƒšãƒ¼ã‚¸ ${i} / ${totalPages}`, pageWidth - 30, pageHeight - 10);
    }
    
    // PDFã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const cleanTitle = recipeTitle
      .replace(/[^\w\s\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '') // è‹±æ•°å­—ã€ç©ºç™½ã€ã²ã‚‰ãŒãªã€ã‚«ã‚¿ã‚«ãƒŠã€æ¼¢å­—ã®ã¿ä¿æŒ
      .replace(/\s+/g, '_') // ç©ºç™½ã‚’ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã«ç½®æ›
      .trim();
    const fileName = `${cleanTitle}.pdf`;
    doc.save(fileName);
    
    console.log('PDFå‡ºåŠ›å®Œäº†:', fileName);
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒ­ã‚°
    console.log('PDFå†…å®¹ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:');
    console.log('ã‚¿ã‚¤ãƒˆãƒ«:', recipeTitle);
    console.log('ææ–™æ•°:', ingredients.length);
    console.log('æ‰‹é †æ•°:', steps.length);
    console.log('æœ€åˆã®æ‰‹é †:', steps[0] || 'ãªã—');
    
    // ææ–™ã®å˜ä½è¡¨ç¤ºçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
    console.log('ææ–™è©³ç´°:');
    ingredients.forEach((ingredient, index) => {
      console.log(`ææ–™${index + 1}:`, {
        item: ingredient.item,
        quantity: ingredient.quantity,
        unit: ingredient.unit,
        combined: `${ingredient.quantity || ''}${ingredient.unit || ''}`
      });
    });
    
  } catch (error) {
    console.error('PDFå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);
    alert('PDFå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// CSVå‡ºåŠ›æ©Ÿèƒ½
async function exportToCSV() {
  try {
    // ç¾åœ¨ã®ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const recipeTitle = document.getElementById('recipeTitle')?.textContent || 'ãƒ¬ã‚·ãƒ”';
    const recipeNotes = document.getElementById('notes')?.textContent || '';
    
    // ææ–™ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ˆã‚Šç¢ºå®Ÿã«å–å¾—ï¼ˆè¤‡æ•°ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’è©¦ã™ï¼‰
    const ingredients = [];
    
    // è¤‡æ•°ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã™
    const ingredientSelectors = [
      '#ingredients .ingredient-row',
      '#ingredients tr',
      '#ingredients .table-row',
      '.ingredients-table tr',
      '.ingredients-table .ingredient-row',
      '.ingredients tr',
      '.ingredients .row',
      'table.ingredients tr',
      'table.ingredients .ingredient-row',
      '.recipe-ingredients tr',
      '.recipe-ingredients .ingredient-row'
    ];
    
    let ingredientRows = [];
    for (const selector of ingredientSelectors) {
      ingredientRows = document.querySelectorAll(selector);
      if (ingredientRows.length > 0) {
        console.log(`CSVå‡ºåŠ› - ææ–™ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ "${selector}" ã§ ${ingredientRows.length} è¡Œã‚’ç™ºè¦‹`);
        break;
      }
    }
    
    console.log('CSVå‡ºåŠ› - ææ–™è¡Œæ•°:', ingredientRows.length);
    
    ingredientRows.forEach((row, index) => {
      // ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’ç¢ºèªã—ã¦æ­£ã—ã„ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã‚’ä½¿ç”¨
      const cells = row.querySelectorAll('td');
      console.log(`CSVå‡ºåŠ› - ææ–™è¡Œ${index + 1}ã®ã‚»ãƒ«æ•°:`, cells.length);
      
      if (cells.length >= 3) {
        // é€šå¸¸ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ : ææ–™å, åˆ†é‡, å˜ä½
        const item = cells[0] ? cells[0].textContent.trim() : '';
        const quantity = cells[1] ? cells[1].textContent.trim() : '';
        const unit = cells[2] ? cells[2].textContent.trim() : '';
        
        console.log(`CSVå‡ºåŠ› - ææ–™${index + 1}:`, { item, quantity, unit });
        
        if (item) {
          ingredients.push({ item, quantity, unit });
        }
      } else {
        // è¤‡æ•°ã®ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã™ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        const itemSelectors = ['.ing-item', '.ingredient-name', '.item'];
        const quantitySelectors = ['.ing-quantity', '.quantity'];
        const unitSelectors = ['.ing-unit', '.unit'];
        
        let itemEl = null, quantityEl = null, unitEl = null;
        
        for (const selector of itemSelectors) {
          itemEl = row.querySelector(selector);
          if (itemEl) break;
        }
        
        for (const selector of quantitySelectors) {
          quantityEl = row.querySelector(selector);
          if (quantityEl) break;
        }
        
        for (const selector of unitSelectors) {
          unitEl = row.querySelector(selector);
          if (unitEl) break;
        }
        
        const item = itemEl ? itemEl.textContent.trim() : '';
        const quantity = quantityEl ? quantityEl.textContent.trim() : '';
        const unit = unitEl ? unitEl.textContent.trim() : '';
        
        console.log(`CSVå‡ºåŠ› - ææ–™${index + 1} (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯):`, { item, quantity, unit });
        
        if (item) {
          ingredients.push({ item, quantity, unit });
        }
      }
    });
    
    // æ‰‹é †ãƒ‡ãƒ¼ã‚¿ã‚’ã‚ˆã‚Šç¢ºå®Ÿã«å–å¾—ï¼ˆ<ol><li>æ§‹é€ ã«å¯¾å¿œï¼‰
    const steps = [];
    
    // <ol id="steps">å†…ã®<li>è¦ç´ ã‚’å–å¾—
    const stepElements = document.querySelectorAll('#steps li');
    console.log('CSVå‡ºåŠ› - æ‰‹é †è¦ç´ æ•°:', stepElements.length);
    
    stepElements.forEach((li, index) => {
      const stepText = li.textContent.trim();
      console.log(`CSVå‡ºåŠ› - æ‰‹é †${index + 1}:`, stepText);
      
      // "æœªç™»éŒ²"ã‚„ç©ºã®ãƒ†ã‚­ã‚¹ãƒˆã¯é™¤å¤–
      if (stepText && stepText !== 'æœªç™»éŒ²' && stepText.length > 0) {
        steps.push(stepText);
      }
    });
    
    console.log('CSVå‡ºåŠ› - å–å¾—ã—ãŸææ–™:', ingredients);
    console.log('CSVå‡ºåŠ› - å–å¾—ã—ãŸæ‰‹é †:', steps);
    
    // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã®å ´åˆã®è­¦å‘Š
    if (ingredients.length === 0) {
      console.warn('ææ–™ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
    }
    if (steps.length === 0) {
      console.warn('æ‰‹é †ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
    }
    
    // CSVãƒ‡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ï¼ˆã‚ˆã‚Šæ•´ç†ã•ã‚ŒãŸå½¢å¼ï¼‰
    let csvContent = '';
    
    // ãƒ¬ã‚·ãƒ”åŸºæœ¬æƒ…å ±
    csvContent += 'ãƒ¬ã‚·ãƒ”å,ãƒ¡ãƒ¢\n';
    csvContent += `"${recipeTitle.replace(/"/g, '""')}","${recipeNotes.replace(/"/g, '""')}"\n\n`;
    
    // ææ–™æƒ…å ±
    csvContent += 'ææ–™å,åˆ†é‡,å˜ä½\n';
    ingredients.forEach(ingredient => {
      const item = ingredient.item.replace(/"/g, '""');
      const quantity = ingredient.quantity.replace(/"/g, '""');
      const unit = ingredient.unit.replace(/"/g, '""');
      csvContent += `"${item}","${quantity}","${unit}"\n`;
    });
    
    // ç©ºè¡Œã§åŒºåˆ‡ã‚Š
    csvContent += '\n';
    
    // ä½œã‚Šæ–¹
    csvContent += 'æ‰‹é †ç•ªå·,ä½œã‚Šæ–¹\n';
    steps.forEach((step, index) => {
      const stepText = step.replace(/"/g, '""');
      csvContent += `${index + 1},"${stepText}"\n`;
    });
    
    // BOMã‚’è¿½åŠ ã—ã¦UTF-8ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ˜ç¤º
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
    
    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `${recipeTitle.replace(/[^\w\s]/gi, '')}_ãƒ¬ã‚·ãƒ”.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    console.log('CSVå‡ºåŠ›å®Œäº†');
    
  } catch (error) {
    console.error('CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);
    alert('CSVå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
  }
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
document.addEventListener('DOMContentLoaded', () => {
  // PDFå‡ºåŠ›ãƒœã‚¿ãƒ³
  const pdfBtn = document.querySelector('.js-export-pdf');
  if (pdfBtn) {
    pdfBtn.addEventListener('click', exportToPDF);
  }
  
  // CSVå‡ºåŠ›ãƒœã‚¿ãƒ³
  const csvBtn = document.querySelector('.js-export-csv');
  if (csvBtn) {
    csvBtn.addEventListener('click', exportToCSV);
  }
  
  // èª­ã¿ã‚„ã™ã„ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºãƒœã‚¿ãƒ³
  const readableTextBtn = document.querySelector('.js-show-readable-text');
  if (readableTextBtn) {
    readableTextBtn.addEventListener('click', () => {
      if (window.currentRecipe) {
        window.showReadableText(window.currentRecipe);
      } else {
        alert('ãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
      }
    });
  }
  
  // èª­ã¿ã‚„ã™ã„ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  const readableTextModal = document.getElementById('readableTextModal');
  const readableTextCloseBtn = document.getElementById('readableTextCloseBtn');
  const readableTextCloseBtn2 = document.getElementById('readableTextCloseBtn2');
  const readableTextCopyBtn = document.getElementById('readableTextCopyBtn');
  const readableTextEditBtn = document.getElementById('readableTextEditBtn');
  const readableTextSaveBtn = document.getElementById('readableTextSaveBtn');
  const readableTextCancelBtn = document.getElementById('readableTextCancelBtn');
  
  if (readableTextCloseBtn) {
    readableTextCloseBtn.addEventListener('click', window.closeReadableTextModal);
  }
  if (readableTextCloseBtn2) {
    readableTextCloseBtn2.addEventListener('click', window.closeReadableTextModal);
  }
  if (readableTextCopyBtn) {
    readableTextCopyBtn.addEventListener('click', window.copyReadableText);
  }
  if (readableTextEditBtn) {
    readableTextEditBtn.addEventListener('click', window.toggleReadableTextEdit);
  }
  if (readableTextSaveBtn) {
    readableTextSaveBtn.addEventListener('click', window.saveReadableText);
  }
  if (readableTextCancelBtn) {
    readableTextCancelBtn.addEventListener('click', window.cancelReadableTextEdit);
  }
  if (readableTextModal) {
    readableTextModal.addEventListener('click', (e) => {
      if (e.target === readableTextModal) {
        window.closeReadableTextModal();
      }
    });
  }
  
  // ãƒ¬ã‚·ãƒ”è¡¨ç¤ºã®åˆæœŸåŒ–
  initRecipeView();
});
</script>
</body>
</html>
