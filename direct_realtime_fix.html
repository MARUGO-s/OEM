<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Service Role Key ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã‚’ä¿®æ­£</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>ğŸ”§ Supabase Service Role Key ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã‚’ä¿®æ­£</h1>
    <div id="status"></div>
    <button onclick="diagnoseAndFix()">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã‚’è¨ºæ–­ãƒ»ä¿®æ­£</button>
    <div id="results"></div>

    <script>
        // Service Role Keyï¼ˆç®¡ç†è€…æ¨©é™ï¼‰
        const SUPABASE_URL = 'https://mrjocjcppjnjxtudebta.supabase.co';
        const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yam9jamNwcGpuanh0dWRlYnRhIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MDg1OTk0OSwiZXhwIjoyMDc2NDM1OTQ5fQ.JRjv6UowDMwLQ1sIKTSK1_04PXmIL5JQk91u8MDMy9c';

        // Service Role ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆï¼ˆç®¡ç†è€…æ¨©é™ï¼‰
        const supabaseAdmin = supabase.createClient(SUPABASE_URL, SERVICE_ROLE_KEY, {
            auth: {
                autoRefreshToken: false,
                persistSession: false
            }
        });

        async function diagnoseAndFix() {
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            
            statusDiv.innerHTML = 'ğŸ” ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã‚’è¨ºæ–­ä¸­...';
            resultsDiv.innerHTML = '';

            try {
                // 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
                statusDiv.innerHTML = 'ğŸ“¡ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆä¸­...';
                
                const { data: tasks, error: tasksError } = await supabaseAdmin
                    .from('tasks')
                    .select('id')
                    .limit(1);
                
                if (tasksError) {
                    resultsDiv.innerHTML += `<p>âŒ ã‚¿ã‚¹ã‚¯ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${tasksError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += `<p>âœ… ã‚¿ã‚¹ã‚¯ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã—ãŸ</p>`;
                }

                const { data: comments, error: commentsError } = await supabaseAdmin
                    .from('comments')
                    .select('id')
                    .limit(1);
                
                if (commentsError) {
                    resultsDiv.innerHTML += `<p>âŒ ã‚³ãƒ¡ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${commentsError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += `<p>âœ… ã‚³ãƒ¡ãƒ³ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã—ãŸ</p>`;
                }

                const { data: notifications, error: notificationsError } = await supabaseAdmin
                    .from('notifications')
                    .select('id')
                    .limit(1);
                
                if (notificationsError) {
                    resultsDiv.innerHTML += `<p>âŒ é€šçŸ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${notificationsError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += `<p>âœ… é€šçŸ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã—ãŸ</p>`;
                }

                // 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
                statusDiv.innerHTML = 'ğŸ”” ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆä¸­...';
                
                // ã‚¿ã‚¹ã‚¯ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒ†ã‚¹ãƒˆ
                const tasksChannel = supabaseAdmin
                    .channel('test-tasks-realtime')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'tasks' },
                        (payload) => {
                            resultsDiv.innerHTML += `<p>âœ… ã‚¿ã‚¹ã‚¯ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’å—ä¿¡: ${JSON.stringify(payload)}</p>`;
                        }
                    )
                    .subscribe((status) => {
                        resultsDiv.innerHTML += `<p>ğŸ“Š ã‚¿ã‚¹ã‚¯ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çŠ¶æ…‹: ${status}</p>`;
                    });

                // ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒ†ã‚¹ãƒˆ
                const commentsChannel = supabaseAdmin
                    .channel('test-comments-realtime')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'comments' },
                        (payload) => {
                            resultsDiv.innerHTML += `<p>âœ… ã‚³ãƒ¡ãƒ³ãƒˆã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’å—ä¿¡: ${JSON.stringify(payload)}</p>`;
                        }
                    )
                    .subscribe((status) => {
                        resultsDiv.innerHTML += `<p>ğŸ“Š ã‚³ãƒ¡ãƒ³ãƒˆã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çŠ¶æ…‹: ${status}</p>`;
                    });

                // é€šçŸ¥ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ãƒ†ã‚¹ãƒˆ
                const notificationsChannel = supabaseAdmin
                    .channel('test-notifications-realtime')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'notifications' },
                        (payload) => {
                            resultsDiv.innerHTML += `<p>âœ… é€šçŸ¥ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’å—ä¿¡: ${JSON.stringify(payload)}</p>`;
                        }
                    )
                    .subscribe((status) => {
                        resultsDiv.innerHTML += `<p>ğŸ“Š é€šçŸ¥ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çŠ¶æ…‹: ${status}</p>`;
                    });

                // 3. ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æŒ¿å…¥ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã®å‹•ä½œç¢ºèªï¼‰
                statusDiv.innerHTML = 'ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æŒ¿å…¥ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ã‚’ç¢ºèªä¸­...';
                
                // ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’æŒ¿å…¥
                const { data: testNotification, error: testError } = await supabaseAdmin
                    .from('notifications')
                    .insert([{
                        message: 'Service Role Key ã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ',
                        type: 'test',
                        created_by: null
                    }])
                    .select();

                if (testError) {
                    resultsDiv.innerHTML += `<p>âŒ ãƒ†ã‚¹ãƒˆé€šçŸ¥æŒ¿å…¥ã‚¨ãƒ©ãƒ¼: ${testError.message}</p>`;
                } else {
                    resultsDiv.innerHTML += `<p>âœ… ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’æŒ¿å…¥ã—ã¾ã—ãŸ: ${JSON.stringify(testNotification)}</p>`;
                }

                statusDiv.innerHTML = 'ğŸ‰ è¨ºæ–­å®Œäº†ï¼çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                
                // 5ç§’å¾Œã«ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                setTimeout(() => {
                    tasksChannel.unsubscribe();
                    commentsChannel.unsubscribe();
                    notificationsChannel.unsubscribe();
                    resultsDiv.innerHTML += `<p>ğŸ§¹ ãƒ†ã‚¹ãƒˆç”¨ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ</p>`;
                }, 5000);

            } catch (error) {
                statusDiv.innerHTML = 'âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                resultsDiv.innerHTML += `<p>âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
